<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Abdullah Mahmood">
<meta name="dcterms.date" content="2025-02-28">

<title>StanCon 2018 Helsinki Intro Workshop: Pest Control Example</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="Pest Control Example_files/libs/clipboard/clipboard.min.js"></script>
<script src="Pest Control Example_files/libs/quarto-html/quarto.js"></script>
<script src="Pest Control Example_files/libs/quarto-html/popper.min.js"></script>
<script src="Pest Control Example_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="Pest Control Example_files/libs/quarto-html/anchor.min.js"></script>
<link href="Pest Control Example_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="Pest Control Example_files/libs/quarto-html/quarto-syntax-highlighting-2f5df379a58b258e96c21c0638c20c03.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="Pest Control Example_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="Pest Control Example_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="Pest Control Example_files/libs/bootstrap/bootstrap-c0367b04c37547644fece4185067e4a7.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#setup" id="toc-setup" class="nav-link active" data-scroll-target="#setup">Setup</a></li>
  <li><a href="#the-problem" id="toc-the-problem" class="nav-link" data-scroll-target="#the-problem">The Problem</a>
  <ul class="collapse">
  <li><a href="#background" id="toc-background" class="nav-link" data-scroll-target="#background">Background</a></li>
  <li><a href="#the-goal" id="toc-the-goal" class="nav-link" data-scroll-target="#the-goal">The Goal</a></li>
  </ul></li>
  <li><a href="#the-data" id="toc-the-data" class="nav-link" data-scroll-target="#the-data">The Data</a></li>
  <li><a href="#bayesian-workflow" id="toc-bayesian-workflow" class="nav-link" data-scroll-target="#bayesian-workflow">Bayesian Workflow</a></li>
  <li><a href="#modeling-count-data-poisson-distribution" id="toc-modeling-count-data-poisson-distribution" class="nav-link" data-scroll-target="#modeling-count-data-poisson-distribution">Modeling count data: Poisson distribution</a>
  <ul class="collapse">
  <li><a href="#model" id="toc-model" class="nav-link" data-scroll-target="#model">Model</a></li>
  <li><a href="#writing-our-first-stan-model" id="toc-writing-our-first-stan-model" class="nav-link" data-scroll-target="#writing-our-first-stan-model">Writing our first Stan model</a></li>
  <li><a href="#making-sure-our-code-is-right" id="toc-making-sure-our-code-is-right" class="nav-link" data-scroll-target="#making-sure-our-code-is-right">Making sure our code is right</a></li>
  <li><a href="#fit-the-model-to-the-fake-data" id="toc-fit-the-model-to-the-fake-data" class="nav-link" data-scroll-target="#fit-the-model-to-the-fake-data">Fit the model to the fake data</a></li>
  <li><a href="#assess-parameter-recovery" id="toc-assess-parameter-recovery" class="nav-link" data-scroll-target="#assess-parameter-recovery">Assess parameter recovery</a></li>
  <li><a href="#fit-with-real-data" id="toc-fit-with-real-data" class="nav-link" data-scroll-target="#fit-with-real-data">Fit with real data</a></li>
  <li><a href="#posterior-predictive-checking" id="toc-posterior-predictive-checking" class="nav-link" data-scroll-target="#posterior-predictive-checking">Posterior predictive checking</a></li>
  </ul></li>
  <li><a href="#expanding-the-model-multiple-predictors" id="toc-expanding-the-model-multiple-predictors" class="nav-link" data-scroll-target="#expanding-the-model-multiple-predictors">Expanding the model: multiple predictors</a>
  <ul class="collapse">
  <li><a href="#interpretability" id="toc-interpretability" class="nav-link" data-scroll-target="#interpretability">Interpretability</a></li>
  <li><a href="#stan-program-for-poisson-multiple-regression" id="toc-stan-program-for-poisson-multiple-regression" class="nav-link" data-scroll-target="#stan-program-for-poisson-multiple-regression">Stan program for Poisson multiple regression</a></li>
  <li><a href="#simulate-fake-data-with-multiple-predictors" id="toc-simulate-fake-data-with-multiple-predictors" class="nav-link" data-scroll-target="#simulate-fake-data-with-multiple-predictors">Simulate fake data with multiple predictors</a></li>
  <li><a href="#fit-the-real-data" id="toc-fit-the-real-data" class="nav-link" data-scroll-target="#fit-the-real-data">Fit the real data</a></li>
  </ul></li>
  <li><a href="#modeling-count-data-with-the-negative-binomial" id="toc-modeling-count-data-with-the-negative-binomial" class="nav-link" data-scroll-target="#modeling-count-data-with-the-negative-binomial">Modeling count data with the Negative Binomial</a>
  <ul class="collapse">
  <li><a href="#stan-program-for-negative-binomial-regression" id="toc-stan-program-for-negative-binomial-regression" class="nav-link" data-scroll-target="#stan-program-for-negative-binomial-regression">Stan program for negative-binomial regression</a></li>
  <li><a href="#fake-data-fit-multiple-nb-regression" id="toc-fake-data-fit-multiple-nb-regression" class="nav-link" data-scroll-target="#fake-data-fit-multiple-nb-regression">Fake data fit: Multiple NB regression</a></li>
  <li><a href="#fit-to-real-data-and-check-the-fit" id="toc-fit-to-real-data-and-check-the-fit" class="nav-link" data-scroll-target="#fit-to-real-data-and-check-the-fit">Fit to real data and check the fit</a></li>
  <li><a href="#garbage-collect" id="toc-garbage-collect" class="nav-link" data-scroll-target="#garbage-collect">Garbage Collect</a></li>
  </ul></li>
  <li><a href="#hierarchical-modeling" id="toc-hierarchical-modeling" class="nav-link" data-scroll-target="#hierarchical-modeling">Hierarchical modeling</a>
  <ul class="collapse">
  <li><a href="#modeling-varying-intercepts-for-each-building" id="toc-modeling-varying-intercepts-for-each-building" class="nav-link" data-scroll-target="#modeling-varying-intercepts-for-each-building">Modeling varying intercepts for each building</a></li>
  <li><a href="#prepare-building-data-for-hierarchical" id="toc-prepare-building-data-for-hierarchical" class="nav-link" data-scroll-target="#prepare-building-data-for-hierarchical">Prepare building data for hierarchical</a></li>
  <li><a href="#compile-and-fit-the-hierarchical-model" id="toc-compile-and-fit-the-hierarchical-model" class="nav-link" data-scroll-target="#compile-and-fit-the-hierarchical-model">Compile and fit the hierarchical model</a></li>
  <li><a href="#diagnostics" id="toc-diagnostics" class="nav-link" data-scroll-target="#diagnostics">Diagnostics</a></li>
  <li><a href="#reparameterize-and-recheck-diagnostics" id="toc-reparameterize-and-recheck-diagnostics" class="nav-link" data-scroll-target="#reparameterize-and-recheck-diagnostics">Reparameterize and recheck diagnostics</a></li>
  <li><a href="#varying-intercepts-and-varying-slopes" id="toc-varying-intercepts-and-varying-slopes" class="nav-link" data-scroll-target="#varying-intercepts-and-varying-slopes">Varying intercepts <em>and</em> varying slopes</a></li>
  </ul></li>
  <li><a href="#time-varying-effects-and-structured-priors" id="toc-time-varying-effects-and-structured-priors" class="nav-link" data-scroll-target="#time-varying-effects-and-structured-priors">Time varying effects and structured priors</a></li>
  <li><a href="#using-our-model-cost-forecasts" id="toc-using-our-model-cost-forecasts" class="nav-link" data-scroll-target="#using-our-model-cost-forecasts">Using our model: Cost forecasts</a>
  <ul class="collapse">
  <li><a href="#exercise-for-the-reader" id="toc-exercise-for-the-reader" class="nav-link" data-scroll-target="#exercise-for-the-reader">Exercise for the reader</a></li>
  </ul></li>
  <li><a href="#gaussian-process-instead-of-ar1" id="toc-gaussian-process-instead-of-ar1" class="nav-link" data-scroll-target="#gaussian-process-instead-of-ar1">Gaussian process instead of AR(1)</a>
  <ul class="collapse">
  <li><a href="#joint-density-for-ar1-process" id="toc-joint-density-for-ar1-process" class="nav-link" data-scroll-target="#joint-density-for-ar1-process">Joint density for AR(1) process</a></li>
  <li><a href="#cholesky-decomposition" id="toc-cholesky-decomposition" class="nav-link" data-scroll-target="#cholesky-decomposition">Cholesky decomposition</a></li>
  <li><a href="#extension-to-gaussian-processes" id="toc-extension-to-gaussian-processes" class="nav-link" data-scroll-target="#extension-to-gaussian-processes">Extension to Gaussian processes</a></li>
  <li><a href="#compiling-the-gp-model" id="toc-compiling-the-gp-model" class="nav-link" data-scroll-target="#compiling-the-gp-model">Compiling the GP model</a></li>
  <li><a href="#fitting-the-gp-model-to-data" id="toc-fitting-the-gp-model-to-data" class="nav-link" data-scroll-target="#fitting-the-gp-model-to-data">Fitting the GP model to data</a></li>
  <li><a href="#examining-the-fit" id="toc-examining-the-fit" class="nav-link" data-scroll-target="#examining-the-fit">Examining the fit</a></li>
  </ul></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">StanCon 2018 Helsinki Intro Workshop: Pest Control Example</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Abdullah Mahmood </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">February 28, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="setup" class="level3">
<h3 class="anchored" data-anchor-id="setup">Setup</h3>
<div id="d47b0fd7" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> gc</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> arviz <span class="im">as</span> az</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> cmdstanpy</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> cmdstanpy <span class="im">import</span> CmdStanModel</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib <span class="im">import</span> style </span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>style.use(<span class="st">'../../../PlottingStyle.mplstyle'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="207b8eed" class="cell" data-execution_count="2">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> StanModel(stan_file: <span class="bu">str</span>, stan_code: <span class="bu">str</span>) <span class="op">-&gt;</span> CmdStanModel:</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Load or compile a Stan model"""</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    stan_src <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>stan_file<span class="sc">}</span><span class="ss">.stan"</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.isfile(stan_file):  </span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>        <span class="bu">open</span>(stan_src, <span class="st">'w'</span>).write(stan_code)  <span class="co"># Write Stan code if needed</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> CmdStanModel(stan_file<span class="op">=</span>stan_src, cpp_options<span class="op">=</span>{<span class="st">'STAN_THREADS'</span>: <span class="st">'true'</span>, <span class="st">'parallel_chains'</span>: <span class="dv">4</span>})</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> CmdStanModel(stan_file<span class="op">=</span>stan_src, exe_file<span class="op">=</span>stan_file)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="the-problem" class="level2">
<h2 class="anchored" data-anchor-id="the-problem">The Problem</h2>
<section id="background" class="level3">
<h3 class="anchored" data-anchor-id="background">Background</h3>
<p>Imagine that you are a statistician or data scientist working as an independent contractor. One of your clients is a company that owns many residential buildings throughout New York City. The property manager explains that they are concerned about the number of cockroach complaints that they receive from their buildings. Previously the company has offered monthly visits from a pest inspector as a solution to this problem. While this is the default solution of many property managers in NYC, the tenants are rarely home when the inspector visits, and so the manager reasons that this is a relatively expensive solution that is currently not very effective.</p>
<p>One alternative to this problem is to deploy long term bait stations. In this alternative, child and pet safe bait stations are installed throughout the apartment building. Cockroaches obtain quick acting poison from these stations and distribute it throughout the colony. The manufacturer of these bait stations provides some indication of the space-to-bait efficacy, but the manager suspects that this guidance was not calculated with NYC roaches in mind. NYC roaches, the manager rationalizes, have more hustle than traditional roaches; and NYC buildings are built differently than other common residential buildings in the US. This is particularly important as the unit cost for each bait station per year is quite high.</p>
</section>
<section id="the-goal" class="level3">
<h3 class="anchored" data-anchor-id="the-goal">The Goal</h3>
<p>The manager wishes to employ your services to help them to find the optimal number of roach bait stations they should place in each of their buildings in order to minimize the number of cockroach complaints while also keeping expenditure on pest control affordable.</p>
<p>A subset of the company’s buildings have been randomly selected for an experiment:</p>
<ul>
<li>At the beginning of each month, a pest inspector randomly places a number of bait stations throughout the building, without knowledge of the current cockroach levels in the building</li>
<li>At the end of the month, the manager records the total number of cockroach complaints in that building.</li>
<li>The manager would like to determine the optimal number of traps (<span class="math inline">\(\textrm{traps}\)</span>) that balances the lost revenue (<span class="math inline">\(R\)</span>) that complaints (<span class="math inline">\(\textrm{complaints}\)</span>) generate with the all-in cost of maintaining the traps (<span class="math inline">\(\textrm{TC}\)</span>).</li>
</ul>
<p>Fortunately, Bayesian data analysis provides a coherent framework for us to tackle this problem.</p>
<p>Formally, we are interested in finding:</p>
<p><span class="math display">\[
\arg\max_{\textrm{traps} \in \mathbb{N}} \mathbb{E}_{\text{complaints}}[R(\textrm{complaints}(\textrm{traps})) - \textrm{TC}(\textrm{traps})]
\]</span></p>
<p>The property manager would also, if possible, like to learn how these results generalize to buildings they haven’t treated so they can understand the potential costs of pest control at buildings they are acquiring as well as for the rest of their building portfolio.</p>
<p>As the property manager has complete control over the number of traps set, the random variable contributing to this expectation is the number of complaints given the number of traps. We will model the number of complaints as a function of the number of traps.</p>
</section>
</section>
<section id="the-data" class="level2">
<h2 class="anchored" data-anchor-id="the-data">The Data</h2>
<p>The data provided to us is in a file called <code>pest_data.csv</code>. Let’s load the data and see what the structure is:</p>
<div id="8351fa5f" class="cell" data-execution_count="3">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>pest_data <span class="op">=</span> pd.read_csv(<span class="st">'data/pest_data.csv'</span>, sep<span class="op">=</span><span class="st">','</span>, header<span class="op">=</span><span class="dv">0</span>, parse_dates<span class="op">=</span>[<span class="st">'date'</span>])</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>pest_data.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="3">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Unnamed: 0</th>
<th data-quarto-table-cell-role="th">mus</th>
<th data-quarto-table-cell-role="th">building_id</th>
<th data-quarto-table-cell-role="th">wk_ind</th>
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">traps</th>
<th data-quarto-table-cell-role="th">floors</th>
<th data-quarto-table-cell-role="th">sq_footage_p_floor</th>
<th data-quarto-table-cell-role="th">live_in_super</th>
<th data-quarto-table-cell-role="th">monthly_average_rent</th>
<th data-quarto-table-cell-role="th">average_tenant_age</th>
<th data-quarto-table-cell-role="th">age_of_building</th>
<th data-quarto-table-cell-role="th">total_sq_foot</th>
<th data-quarto-table-cell-role="th">month</th>
<th data-quarto-table-cell-role="th">complaints</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>1</td>
<td>0.369134</td>
<td>37</td>
<td>1</td>
<td>2017-01-15</td>
<td>8</td>
<td>8</td>
<td>5149.008112</td>
<td>0</td>
<td>3846.94905</td>
<td>53.877424</td>
<td>47</td>
<td>41192.064892</td>
<td>1</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2</td>
<td>0.359355</td>
<td>37</td>
<td>2</td>
<td>2017-02-14</td>
<td>8</td>
<td>8</td>
<td>5149.008112</td>
<td>0</td>
<td>3846.94905</td>
<td>53.877424</td>
<td>47</td>
<td>41192.064892</td>
<td>2</td>
<td>3</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>3</td>
<td>0.281783</td>
<td>37</td>
<td>3</td>
<td>2017-03-16</td>
<td>9</td>
<td>8</td>
<td>5149.008112</td>
<td>0</td>
<td>3846.94905</td>
<td>53.877424</td>
<td>47</td>
<td>41192.064892</td>
<td>3</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>4</td>
<td>0.129254</td>
<td>37</td>
<td>4</td>
<td>2017-04-15</td>
<td>10</td>
<td>8</td>
<td>5149.008112</td>
<td>0</td>
<td>3846.94905</td>
<td>53.877424</td>
<td>47</td>
<td>41192.064892</td>
<td>4</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>5</td>
<td>0.452041</td>
<td>37</td>
<td>5</td>
<td>2017-05-15</td>
<td>11</td>
<td>8</td>
<td>5149.008112</td>
<td>0</td>
<td>3846.94905</td>
<td>53.877424</td>
<td>47</td>
<td>41192.064892</td>
<td>5</td>
<td>0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>We have access to the following fields:</p>
<ul>
<li><code>complaints</code>: Number of complaints per building per month</li>
<li><code>building_id</code>: The unique building identifier</li>
<li><code>traps</code>: The number of traps used per month per building</li>
<li><code>date</code>: The date at which the number of complaints are recorded</li>
<li><code>live_in_super</code>: An indicator for whether the building as a live-in super</li>
<li><code>age_of_building</code>: The age of the building</li>
<li><code>total_sq_foot</code>: The total square footage of the building</li>
<li><code>average_tenant_age</code>: The average age of the tenants per building</li>
<li><code>monthly_average_rent</code>: The average monthly rent per building</li>
<li><code>floors</code>: The number of floors per building</li>
</ul>
<p>First, let’s see how many buildings we have data for:</p>
<div id="19714bd7" class="cell" data-execution_count="4">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>N_buildings <span class="op">=</span> <span class="bu">len</span>(pest_data.building_id.unique())</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>N_buildings</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="4">
<pre><code>10</code></pre>
</div>
</div>
<p>And make some plots of the raw data:</p>
<div id="5e5be9cf" class="cell" data-execution_count="5">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>plt.clf()</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>sns.histplot(pest_data.complaints, discrete<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>plt.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Pest%20Control%20Example_files/figure-html/cell-6-output-1.png" width="511" height="411" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="624beaa0" class="cell" data-execution_count="6">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>plt.clf()</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>sns.stripplot(data<span class="op">=</span>pest_data, x<span class="op">=</span><span class="st">'traps'</span>, y<span class="op">=</span><span class="st">'complaints'</span>, hue<span class="op">=</span><span class="st">'live_in_super'</span>, jitter<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>plt.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Pest%20Control%20Example_files/figure-html/cell-7-output-1.png" width="511" height="411" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="85fa27a5" class="cell" data-execution_count="7">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.dates <span class="im">as</span> mdates</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>plt.clf()</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>g <span class="op">=</span> sns.FacetGrid(data<span class="op">=</span>pest_data, col<span class="op">=</span><span class="st">'building_id'</span>, hue<span class="op">=</span><span class="st">'live_in_super'</span>, col_wrap<span class="op">=</span><span class="dv">2</span>, height<span class="op">=</span><span class="dv">2</span>, sharex<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>g.map_dataframe(sns.lineplot, <span class="st">'date'</span>, <span class="st">'traps'</span>, linestyle<span class="op">=</span><span class="st">'dashed'</span>, color<span class="op">=</span><span class="st">'k'</span>, label<span class="op">=</span><span class="st">'Number of Traps'</span>)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>g.map_dataframe(sns.lineplot, x<span class="op">=</span><span class="st">'date'</span>, y<span class="op">=</span><span class="st">'complaints'</span>, marker<span class="op">=</span><span class="st">'o'</span>, label<span class="op">=</span><span class="st">'Number of Complaints'</span>)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ax <span class="kw">in</span> g.axes.flat:</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    ax.xaxis.set_major_formatter(mdates.DateFormatter(<span class="st">'%b'</span>))  <span class="co"># Show only abbreviated month names (e.g., Jan, Feb)</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    ax.xaxis.set_major_locator(mdates.MonthLocator(interval<span class="op">=</span><span class="dv">3</span>))  <span class="co"># Set ticks at the start of each month</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>line_labels <span class="op">=</span> [</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>    plt.Line2D([<span class="dv">0</span>], [<span class="dv">0</span>], color<span class="op">=</span><span class="st">'k'</span>, linestyle<span class="op">=</span><span class="st">'dashed'</span>, label<span class="op">=</span><span class="st">"Number of Traps"</span>),</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>    plt.Line2D([<span class="dv">0</span>], [<span class="dv">0</span>], marker<span class="op">=</span><span class="st">'o'</span>, color<span class="op">=</span><span class="st">'k'</span>, label<span class="op">=</span><span class="st">"Number of Complaints"</span>, linestyle<span class="op">=</span><span class="st">'solid'</span>)</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>g.add_legend(handles<span class="op">=</span>line_labels, title<span class="op">=</span><span class="st">'Legend'</span>, loc<span class="op">=</span><span class="st">'upper right'</span>)   </span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>plt.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<pre><code>&lt;Figure size 500x400 with 0 Axes&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Pest%20Control%20Example_files/figure-html/cell-8-output-2.png" width="542" height="999" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>The first question we’ll look at is just whether the number of complaints per building per month is associated with the number of bait stations per building per month, ignoring the temporal and across-building variation (we’ll come back to those sources of variation later in the document). That requires only two variables, <span class="math inline">\(\textrm{complaints}\)</span> and <span class="math inline">\(\textrm{traps}\)</span>. How should we model the number of complaints?</p>
</section>
<section id="bayesian-workflow" class="level2">
<h2 class="anchored" data-anchor-id="bayesian-workflow">Bayesian Workflow</h2>
<ul>
<li>Exploratory data analysis</li>
<li>Prior predictive checking</li>
<li>Model fitting and algorithm diagnostics</li>
<li>Posterior predictive checking</li>
<li>Model comparison (e.g., via cross-validation)</li>
</ul>
</section>
<section id="modeling-count-data-poisson-distribution" class="level2">
<h2 class="anchored" data-anchor-id="modeling-count-data-poisson-distribution">Modeling count data: Poisson distribution</h2>
<p>We already know some rudimentary information about what we should expect. The number of complaints over a month should be either zero or an integer. The property manager tells us that it is possible but unlikely that number of complaints in a given month is zero. Occasionally there are a very large number of complaints in a single month. A common way of modeling this sort of skewed, single bounded count data is as a Poisson random variable. One concern about modeling the outcome variable as Poisson is that the data may be over-dispersed, but we’ll start with the Poisson model and then check whether over-dispersion is a problem by comparing our model’s predictions to the data.</p>
<section id="model" class="level3">
<h3 class="anchored" data-anchor-id="model">Model</h3>
<p>Given that we have chosen a Poisson regression, we define the likelihood to be the Poisson probability mass function over the number bait stations placed in the building, denoted below as <code>traps</code>. This model assumes that the mean and variance of the outcome variable <code>complaints</code> (number of complaints) is the same. We’ll investigate whether this is a good assumption after we fit the model.</p>
<p>For building <span class="math inline">\(b = 1,\dots,10\)</span> at time (month) <span class="math inline">\(t = 1,\dots,12\)</span>, we have:</p>
<p><span class="math display">\[
\begin{align*}
\textrm{complaints}_{b,t} &amp; \sim \textrm{Poisson}(\lambda_{b,t}) \\
\lambda_{b,t} &amp; = \exp{(\eta_{b,t})} \\
\eta_{b,t} &amp;= \alpha + \beta \, \textrm{traps}_{b,t}
\end{align*}
\]</span></p>
<p>Let’s encode this probability model in a Stan program.</p>
</section>
<section id="writing-our-first-stan-model" class="level3">
<h3 class="anchored" data-anchor-id="writing-our-first-stan-model">Writing our first Stan model</h3>
<div id="f14ca88c" class="cell" data-execution_count="8">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>simple_poisson_regression <span class="op">=</span> <span class="st">'''</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="st">functions {</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="st">  /*</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="st">  * Alternative to poisson_log_rng() that </span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="st">  * avoids potential numerical problems during warmup</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="st">  */</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="st">  int poisson_log_safe_rng(real eta) {</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="st">    real pois_rate = exp(eta);</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="st">    if (pois_rate &gt;= exp(20.79))</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="st">      return -9;</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="st">    return poisson_rng(pois_rate);</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a><span class="st">data {</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a><span class="st">    int&lt;lower=1&gt; N;</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a><span class="st">    array[N] int&lt;lower=0&gt; complaints;</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a><span class="st">    vector&lt;lower=0&gt;[N] traps;</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a><span class="st">parameters {</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a><span class="st">    real alpha;</span></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a><span class="st">    real beta;</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a><span class="st">  // weakly informative priors:</span></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a><span class="st">  // we expect negative slope on traps and a positive intercept,</span></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a><span class="st">  // but we will allow ourselves to be wrong</span></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a><span class="st">  beta ~ normal(-0.25, 1);</span></span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a><span class="st">  alpha ~ normal(log(4), 1);</span></span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a><span class="st">  // poisson_log(eta) is more efficient and stable alternative to poisson(exp(eta))</span></span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a><span class="st">  complaints ~ poisson_log(alpha + beta * traps);</span></span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a><span class="st">} </span></span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a><span class="st">generated quantities {</span></span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a><span class="st">    array[N] int y_rep;</span></span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a><span class="st">    for (n in 1:N) {</span></span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a><span class="st">        y_rep[n] = poisson_log_safe_rng(alpha + beta * traps[n]);</span></span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a><span class="st">    }</span></span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a><span class="st">'''</span></span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>simple_poisson_regression_model <span class="op">=</span> StanModel(<span class="st">'../stan_models/simple_poisson_regression'</span>, simple_poisson_regression)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="making-sure-our-code-is-right" class="level3">
<h3 class="anchored" data-anchor-id="making-sure-our-code-is-right">Making sure our code is right</h3>
<p>However, before we fit the model to real data, we should check that our model works well with simulated data. We’ll simulate data according to the model and then check that we can sufficiently recover the parameter values used in the simulation.</p>
<div id="0f9921fb" class="cell" data-execution_count="9">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>simple_poisson_regression_dgp_model <span class="op">=</span> <span class="st">'''</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="st">data {</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="st">    int&lt;lower=1&gt; N;</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="st">    real&lt;lower=0&gt; mean_traps;</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="st">} </span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="st">generated quantities {</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="st">    array[N] int traps;</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="st">    array[N] int complaints;</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="st">    real alpha = normal_rng(log(4), .1);</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a><span class="st">    real beta = normal_rng(-0.25, .1);</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a><span class="st">    for (n in 1:N)  {</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a><span class="st">        traps[n] = poisson_rng(mean_traps);</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a><span class="st">        complaints[n] = poisson_log_rng(alpha + beta * traps[n]);</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a><span class="st">    }</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a><span class="st">'''</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Here we will do the <em>compilation</em> and <em>fitting</em> in two stages to demonstrate what is happening under the hood.</p>
<p>First we will compile the Stan program (<code>simple_poisson_regression_dgp.stan</code>) that will generate the fake data.</p>
<div id="a299ded1" class="cell" data-execution_count="10">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>simple_poisson_regression_dgp <span class="op">=</span> StanModel(<span class="st">'../stan_models/simple_poisson_regression_dgp'</span>, simple_poisson_regression_dgp_model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Now we can simulate the data by calling the <code>sample()</code> method on the <code>CmdStanModel</code> object instantiated above. The method requires that we pass input data in the form of a dictionary. The names must match the names used in the <code>data</code> block of the Stan program.</p>
<div id="cbd1d773" class="cell" data-execution_count="11">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>fitted_model_dgp <span class="op">=</span> simple_poisson_regression_dgp.sample(</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>{<span class="st">'N'</span>: <span class="bu">len</span>(pest_data.traps), </span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>          <span class="st">'mean_traps'</span>: pest_data.traps.mean()},</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    chains<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    iter_sampling<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    show_progress<span class="op">=</span><span class="va">False</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>samps_dgp <span class="op">=</span> az.from_cmdstanpy(fitted_model_dgp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="fit-the-model-to-the-fake-data" class="level3">
<h3 class="anchored" data-anchor-id="fit-the-model-to-the-fake-data">Fit the model to the fake data</h3>
<p>In order to pass the fake data to our Stan program, we need to arrange the data into a dictionary. The keys must match the names used in the <code>data</code> block of the Stan program.</p>
<div id="1100bfa4" class="cell" data-execution_count="12">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>stan_dat_fake <span class="op">=</span> {</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">'N'</span>: <span class="bu">len</span>(pest_data.traps),</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'traps'</span>: samps_dgp.posterior.traps.sel(chain<span class="op">=</span><span class="dv">0</span>, draw<span class="op">=</span><span class="dv">0</span>).to_numpy().astype(np.int16),</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'complaints'</span>: samps_dgp.posterior.complaints.sel(chain<span class="op">=</span><span class="dv">0</span>, draw<span class="op">=</span><span class="dv">0</span>).to_numpy().astype(np.int16)</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Now that we have the simulated data we fit the model to see if we can recover the <code>alpha</code> and <code>beta</code> parameters used in the simulation.</p>
<div id="ec0e5eff" class="cell" data-execution_count="13">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>fit_model_P <span class="op">=</span> simple_poisson_regression_model.sample(data<span class="op">=</span>stan_dat_fake, show_progress<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>posterior_alpha_beta <span class="op">=</span> az.extract(az.from_cmdstanpy(fit_model_P), <span class="st">'posterior'</span>, var_names<span class="op">=</span>[<span class="st">'alpha'</span>, <span class="st">'beta'</span>]).to_dataframe()[[<span class="st">'alpha'</span>, <span class="st">'beta'</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="assess-parameter-recovery" class="level3">
<h3 class="anchored" data-anchor-id="assess-parameter-recovery">Assess parameter recovery</h3>
<div id="eb37e39f" class="cell" data-execution_count="14">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>true_alpha <span class="op">=</span> samps_dgp.posterior.alpha.sel(chain<span class="op">=</span><span class="dv">0</span>, draw<span class="op">=</span><span class="dv">0</span>).to_numpy()</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>true_beta <span class="op">=</span> samps_dgp.posterior.beta.sel(chain<span class="op">=</span><span class="dv">0</span>, draw<span class="op">=</span><span class="dv">0</span>).to_numpy()</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>plt.clf()</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>_, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>,<span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">8</span>,<span class="dv">4</span>))</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>sns.histplot(posterior_alpha_beta, x<span class="op">=</span><span class="st">'alpha'</span>, bins<span class="op">=</span><span class="dv">30</span>, ax<span class="op">=</span>ax[<span class="dv">0</span>])</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].axvline(true_alpha, color<span class="op">=</span><span class="st">'r'</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>sns.histplot(posterior_alpha_beta, x<span class="op">=</span><span class="st">'beta'</span>, bins<span class="op">=</span><span class="dv">30</span>, ax<span class="op">=</span>ax[<span class="dv">1</span>])</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].axvline(true_beta, color<span class="op">=</span><span class="st">'r'</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>plt.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<pre><code>&lt;Figure size 500x400 with 0 Axes&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Pest%20Control%20Example_files/figure-html/cell-15-output-2.png" width="811" height="411" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>We don’t do a great job recovering the parameters here simply because we’re simulating so few observations that the posterior uncertainty remains rather large, but it looks at least <em>plausible</em> (<span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\beta\)</span> are contained within the histograms). If we did the simulation with many more observations the parameters would be estimated much more precisely.</p>
<p>We should also check if the <code>y_rep</code> datasets (in-sample predictions) that we coded in the <code>generated quantities</code> block are similar to the <code>y</code> (complaints) values we conditioned on when fitting the model.</p>
<p>Here is a plot of the density estimate of the observed data compared to 200 of the <code>y_rep</code> datasets:</p>
<div id="bf498e75" class="cell" data-execution_count="15">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>y_rep <span class="op">=</span> az.from_cmdstanpy(fit_model_P).posterior.y_rep</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>plt.clf()</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">200</span>):</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    sns.kdeplot(y_rep.sel(chain<span class="op">=</span><span class="bu">slice</span>(<span class="dv">0</span>,<span class="dv">4</span>), draw<span class="op">=</span>i).to_dataframe(), x<span class="op">=</span><span class="st">'y_rep'</span>, color<span class="op">=</span><span class="st">'k'</span>, alpha<span class="op">=</span><span class="fl">0.2</span>)</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>sns.kdeplot(stan_dat_fake[<span class="st">'complaints'</span>], color<span class="op">=</span><span class="st">'r'</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>plt.xlim(<span class="dv">0</span>,<span class="dv">12</span>)</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>plt.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Pest%20Control%20Example_files/figure-html/cell-16-output-1.png" width="511" height="411" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>In the plot above we have the kernel density estimate of the observed data (<span class="math inline">\(y\)</span>, thicker curve) and 200 simulated data sets (<span class="math inline">\(y_{rep}\)</span>, thin curves) from the posterior predictive distribution. If the model fits the data well, as it does here, there is little difference between the observed dataset and the simulated datasets.</p>
<p>Another plot we can make for count data is a rootogram. This is a plot of the expected counts (continuous line) vs the observed counts (blue histogram). We can see the model fits well because the observed histogram matches the expected counts relatively well.</p>
<div id="248fa778" class="cell" data-execution_count="16">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>plt.clf()</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>vals, counts <span class="op">=</span> np.unique(y_rep.to_dataframe()[<span class="st">'y_rep'</span>].to_numpy(), return_counts<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>hist_range <span class="op">=</span> (<span class="bu">min</span>(vals), <span class="bu">max</span>(vals))</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>az.plot_dist(stan_dat_fake[<span class="st">'complaints'</span>], kind<span class="op">=</span><span class="st">'hist'</span>, ax<span class="op">=</span>ax, </span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>             hist_kwargs<span class="op">=</span>{<span class="st">'bins'</span>: np.arange(hist_range[<span class="dv">0</span>], hist_range[<span class="dv">1</span>] <span class="op">+</span> <span class="dv">1</span>, <span class="dv">1</span>), <span class="st">'range'</span>: hist_range})</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>secax <span class="op">=</span> ax.twinx()</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>secax.plot(vals, counts, color<span class="op">=</span><span class="st">'red'</span>, linestyle<span class="op">=</span><span class="st">'dashed'</span>, marker<span class="op">=</span><span class="st">'o'</span>)</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>ax.set_xlim(hist_range[<span class="dv">0</span>]<span class="op">-</span><span class="fl">0.5</span>, hist_range[<span class="dv">1</span>]<span class="op">+</span><span class="fl">0.5</span>)</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>secax.set_yticklabels([])</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>secax.yaxis.set_ticks([])</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>plt.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<pre><code>&lt;Figure size 500x400 with 0 Axes&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Pest%20Control%20Example_files/figure-html/cell-17-output-2.png" width="511" height="411" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="fit-with-real-data" class="level3">
<h3 class="anchored" data-anchor-id="fit-with-real-data">Fit with real data</h3>
<p>To fit the model to the actual observed data we’ll first create a dictionary to pass to Stan using the variables in the <code>pest_data</code> data frame:</p>
<div id="6f882f71" class="cell" data-execution_count="17">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>stan_dat_simple <span class="op">=</span> {</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">'N'</span>: <span class="bu">len</span>(pest_data.traps),</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'complaints'</span>: pest_data.complaints,</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'traps'</span>: pest_data.traps</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="17227f2a" class="cell" data-execution_count="18">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>fit_P_real_data <span class="op">=</span> simple_poisson_regression_model.sample(data<span class="op">=</span>stan_dat_simple, show_progress<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>az_fit_P_real_data <span class="op">=</span> az.from_cmdstanpy(fit_P_real_data, posterior_predictive<span class="op">=</span><span class="st">'y_rep'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="333d9b79" class="cell" data-execution_count="19">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>summary <span class="op">=</span> fit_P_real_data.summary(percentiles<span class="op">=</span>(<span class="fl">2.5</span>, <span class="dv">25</span>, <span class="dv">50</span>, <span class="dv">75</span>, <span class="fl">97.5</span>))</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>summary[<span class="op">~</span>summary.index.<span class="bu">str</span>.contains(<span class="st">'y_rep'</span>)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="19">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Mean</th>
<th data-quarto-table-cell-role="th">MCSE</th>
<th data-quarto-table-cell-role="th">StdDev</th>
<th data-quarto-table-cell-role="th">MAD</th>
<th data-quarto-table-cell-role="th">2.5%</th>
<th data-quarto-table-cell-role="th">25%</th>
<th data-quarto-table-cell-role="th">50%</th>
<th data-quarto-table-cell-role="th">75%</th>
<th data-quarto-table-cell-role="th">97.5%</th>
<th data-quarto-table-cell-role="th">ESS_bulk</th>
<th data-quarto-table-cell-role="th">ESS_tail</th>
<th data-quarto-table-cell-role="th">R_hat</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">lp__</td>
<td>160.852000</td>
<td>0.031034</td>
<td>0.973310</td>
<td>0.695339</td>
<td>158.303000</td>
<td>160.468000</td>
<td>161.167000</td>
<td>161.54400</td>
<td>161.801000</td>
<td>1079.780</td>
<td>1571.070</td>
<td>1.00118</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">alpha</td>
<td>2.571560</td>
<td>0.005267</td>
<td>0.148006</td>
<td>0.148038</td>
<td>2.270460</td>
<td>2.474750</td>
<td>2.572500</td>
<td>2.67406</td>
<td>2.855320</td>
<td>808.361</td>
<td>796.063</td>
<td>1.00327</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">beta</td>
<td>-0.190843</td>
<td>0.000786</td>
<td>0.022289</td>
<td>0.022716</td>
<td>-0.233984</td>
<td>-0.206733</td>
<td>-0.190472</td>
<td>-0.17593</td>
<td>-0.146219</td>
<td>818.155</td>
<td>843.817</td>
<td>1.00316</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>We can also plot the posterior distributions:</p>
<div id="b2eba884" class="cell" data-execution_count="20">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.ticker <span class="im">as</span> mticker</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>plt.clf()</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>_, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>,<span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">8</span>,<span class="dv">4</span>))</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>az.plot_dist(az_fit_P_real_data.posterior.alpha, kind<span class="op">=</span><span class="st">'hist'</span>, ax<span class="op">=</span>ax[<span class="dv">0</span>])</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>az.plot_dist(az_fit_P_real_data.posterior.beta, kind<span class="op">=</span><span class="st">'hist'</span>, ax<span class="op">=</span>ax[<span class="dv">1</span>])</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> a <span class="kw">in</span> ax:</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>    a.xaxis.set_major_locator(mticker.MaxNLocator(nbins<span class="op">=</span><span class="dv">5</span>))</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>plt.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<pre><code>&lt;Figure size 500x400 with 0 Axes&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Pest%20Control%20Example_files/figure-html/cell-21-output-2.png" width="811" height="411" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>As we expected, it appears the number of bait stations set in a building is associated with the number of complaints about cockroaches that were made in the following month. However, we still need to consider how well the model fits.</p>
</section>
<section id="posterior-predictive-checking" class="level3">
<h3 class="anchored" data-anchor-id="posterior-predictive-checking">Posterior predictive checking</h3>
<div id="d2aa0401" class="cell" data-execution_count="21">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>y_rep <span class="op">=</span> az_fit_P_real_data.posterior_predictive.y_rep</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>plt.clf()</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">200</span>):</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    sns.kdeplot(y_rep.sel(chain<span class="op">=</span><span class="bu">slice</span>(<span class="dv">0</span>), draw<span class="op">=</span>i).to_dataframe(), x<span class="op">=</span><span class="st">'y_rep'</span>, color<span class="op">=</span><span class="st">'k'</span>, alpha<span class="op">=</span><span class="fl">0.2</span>)</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>sns.kdeplot(stan_dat_simple[<span class="st">'complaints'</span>], color<span class="op">=</span><span class="st">'r'</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>plt.xlim(<span class="dv">0</span>,<span class="dv">25</span>)</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>plt.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Pest%20Control%20Example_files/figure-html/cell-22-output-1.png" width="511" height="411" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>As opposed to when we fit the model to simulated data above, here the simulated datasets is not as dispersed as the observed data and don’t seem to capture the rate of zeros in the observed data. The Poisson model may not be sufficient for this data.</p>
<p>Let’s explore this further by looking directly at the proportion of zeros in the real data and predicted data.</p>
<div id="82fac0f8" class="cell" data-execution_count="22">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>plt.clf()</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>_, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>sns.histplot(np.mean(y_rep <span class="op">==</span> <span class="dv">0</span>, axis<span class="op">=</span><span class="dv">2</span>).to_numpy().flatten(), bins<span class="op">=</span><span class="dv">20</span>, ax<span class="op">=</span>ax)</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>ax.axvline(np.mean(stan_dat_simple[<span class="st">'complaints'</span>] <span class="op">==</span> <span class="dv">0</span>), linewidth<span class="op">=</span><span class="dv">2</span>, color<span class="op">=</span><span class="st">'r'</span>)</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>plt.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<pre><code>&lt;Figure size 500x400 with 0 Axes&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Pest%20Control%20Example_files/figure-html/cell-23-output-2.png" width="511" height="411" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>The plot above shows the observed proportion of zeros (thick vertical line) and a histogram of the proportion of zeros in each of the simulated data sets. It is clear that the model does not capture this feature of the data well at all.</p>
<p>This next plot is a plot of the standardized residuals of the observed vs predicted number of complaints.</p>
<div id="1f8714dc" class="cell" data-execution_count="23">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>mean_y_rep <span class="op">=</span> y_rep.mean(dim<span class="op">=</span>[<span class="st">'chain'</span>, <span class="st">'draw'</span>])</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>std_resid <span class="op">=</span> (stan_dat_simple[<span class="st">'complaints'</span>] <span class="op">-</span> mean_y_rep) <span class="op">/</span> np.sqrt(mean_y_rep)</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>plt.clf()</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>plt.plot(mean_y_rep, std_resid, <span class="st">'o'</span>, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>plt.axhline(<span class="dv">2</span>, linestyle<span class="op">=</span><span class="st">'--'</span>)</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>plt.axhline(<span class="op">-</span><span class="dv">2</span>, linestyle<span class="op">=</span><span class="st">'--'</span>)</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'mean_y_rep'</span>)</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'std_resid'</span>)</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>plt.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Pest%20Control%20Example_files/figure-html/cell-24-output-1.png" width="511" height="411" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>As you can see here, it looks as though we have more positive residuals than negative, which indicates that the model tends to underestimate the number of complaints that will be received.</p>
<p>Below another useful plot to compare the observed vs expected number of complaints. This is a plot of the expected counts (continuous line) vs the observed counts (black histogram):</p>
<div id="99572864" class="cell" data-execution_count="24">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>plt.clf()</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>vals, counts <span class="op">=</span> np.unique(y_rep, return_counts<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>hist_range <span class="op">=</span> (<span class="bu">min</span>(vals), <span class="bu">max</span>(vals))</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>az.plot_dist(stan_dat_simple[<span class="st">'complaints'</span>], kind<span class="op">=</span><span class="st">'hist'</span>, ax<span class="op">=</span>ax, </span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>             hist_kwargs<span class="op">=</span>{<span class="st">'bins'</span>: np.arange(hist_range[<span class="dv">0</span>], hist_range[<span class="dv">1</span>] <span class="op">+</span> <span class="dv">1</span>, <span class="dv">1</span>), <span class="st">'range'</span>: hist_range})</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>secax <span class="op">=</span> ax.twinx()</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>secax.plot(vals, counts, color<span class="op">=</span><span class="st">'red'</span>, linestyle<span class="op">=</span><span class="st">'dashed'</span>, marker<span class="op">=</span><span class="st">'o'</span>)</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>ax.set_xlim(hist_range[<span class="dv">0</span>]<span class="op">-</span><span class="fl">0.5</span>, hist_range[<span class="dv">1</span>]<span class="op">+</span><span class="fl">0.5</span>)</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>secax.set_yticklabels([])</span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>secax.yaxis.set_ticks([])</span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>plt.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<pre><code>&lt;Figure size 500x400 with 0 Axes&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Pest%20Control%20Example_files/figure-html/cell-25-output-2.png" width="511" height="411" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>If the model was fitting well these would be relatively similar, however in this figure we can see the number of complaints is underestimated if there are few complaints, over-estimated for medium numbers of complaints, and underestimated if there are a large number of complaints.</p>
<p>We can also view how the predicted number of complaints varies with the number of traps. From this we can see that the model doesn’t seem to fully capture the data.</p>
<div id="72cb4dad" class="cell" data-execution_count="25">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> collections <span class="im">import</span> defaultdict</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>plt.clf()</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>_, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>ax.plot(stan_dat_simple[<span class="st">'traps'</span>], stan_dat_simple[<span class="st">'complaints'</span>], <span class="st">'o'</span>, fillstyle<span class="op">=</span><span class="st">'none'</span>)</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>grouped_indices <span class="op">=</span> defaultdict(<span class="bu">list</span>)</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> idx, trap <span class="kw">in</span> <span class="bu">enumerate</span>(stan_dat_simple[<span class="st">'traps'</span>]):</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>    grouped_indices[trap].append(idx)</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>grouped_array <span class="op">=</span> {trap: y_rep[:, :, idx_list].to_numpy().flatten() <span class="cf">for</span> trap, idx_list <span class="kw">in</span> grouped_indices.items()}</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> traps_x, complaints_y <span class="kw">in</span> grouped_array.items():</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>    inner_prob <span class="op">=</span> np.array([np.quantile(complaints_y, <span class="fl">0.75</span>), np.quantile(complaints_y, <span class="fl">0.25</span>)])  <span class="co"># az.hdi(complaints_y, hdi_prob=0.5)</span></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>    outer_prob <span class="op">=</span> np.array([np.quantile(complaints_y, <span class="fl">0.95</span>), np.quantile(complaints_y, <span class="fl">0.05</span>)])  <span class="co"># az.hdi(complaints_y, hdi_prob=0.9)</span></span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>    ax.plot(np.full(inner_prob.shape, traps_x), inner_prob, <span class="st">'k'</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>    ax.plot(np.full(outer_prob.shape, traps_x), outer_prob, <span class="st">'k'</span>, linewidth<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>    ax.plot(traps_x, np.mean(complaints_y), <span class="st">'ko'</span>)</span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a>plt.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<pre><code>&lt;Figure size 500x400 with 0 Axes&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Pest%20Control%20Example_files/figure-html/cell-26-output-2.png" width="511" height="411" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Specifically, the model doesn’t capture the tails of the observed data very well.</p>
</section>
</section>
<section id="expanding-the-model-multiple-predictors" class="level2">
<h2 class="anchored" data-anchor-id="expanding-the-model-multiple-predictors">Expanding the model: multiple predictors</h2>
<p>Modeling the relationship between complaints and bait stations is the simplest model. We can expand the model, however, in a few ways that will be beneficial for our client. Moreover, the manager has told us that they expect there are a number of other reasons that one building might have more roach complaints than another.</p>
<section id="interpretability" class="level3">
<h3 class="anchored" data-anchor-id="interpretability">Interpretability</h3>
<p>Currently, our model’s mean parameter is a rate of complaints per 30 days, but we’re modeling a process that occurs over an area as well as over time. We have the square footage of each building, so if we add that information into the model, we can interpret our parameters as a rate of complaints per square foot per 30 days.</p>
<p><span class="math display">\[
\begin{align*}
\textrm{complaints}_{b,t} &amp; \sim \textrm{Poisson}(\textrm{sq. foot}_b\,\lambda_{b,t}) \\
\lambda_{b,t} &amp; = \exp{(\eta_{b,t} )} \\
\eta_{b,t} &amp;= \alpha + \beta \, \textrm{traps}_{b,t}
\end{align*}
\]</span></p>
<p>The term <span class="math inline">\(\text{sq. foot}\)</span> is called an <strong>exposure term</strong>. If we log the term, we can put it in <span class="math inline">\(\eta_{b,t}\)</span>:</p>
<p><span class="math display">\[
\begin{align*}
\textrm{complaints}_{b,t} &amp; \sim \textrm{Poisson}(\lambda_{b,t}) \\
\lambda_{b,t} &amp; = \exp{(\eta_{b,t} )} \\
\eta_{b,t} &amp;= \alpha + \beta \, \textrm{traps}_{b,t} + \textrm{log sq. foot}_b
\end{align*}
\]</span></p>
<p>A quick test shows us that there appears to be a relationship between the square footage of the building and the number of complaints received:</p>
<div id="a99f02fc" class="cell" data-execution_count="26">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>plt.clf()</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>sns.regplot(x<span class="op">=</span>np.log(pest_data.total_sq_foot),y<span class="op">=</span>np.log1p(pest_data.complaints))</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>plt.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Pest%20Control%20Example_files/figure-html/cell-27-output-1.png" width="511" height="411" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Using the property manager’s intuition, we include two extra pieces of information we know about the building - the (log of the) square floor space and whether there is a live in super or not - into both the simulated and real data.</p>
<div id="e5ecbee6" class="cell" data-execution_count="27">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>stan_dat_simple[<span class="st">'log_sq_foot'</span>] <span class="op">=</span> np.log(pest_data.total_sq_foot<span class="op">/</span><span class="fl">1e4</span>)</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>stan_dat_simple[<span class="st">'live_in_super'</span>] <span class="op">=</span> pest_data.live_in_super</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="stan-program-for-poisson-multiple-regression" class="level3">
<h3 class="anchored" data-anchor-id="stan-program-for-poisson-multiple-regression">Stan program for Poisson multiple regression</h3>
<p>Now we need a new Stan model that uses multiple predictors.</p>
<div id="afb28973" class="cell" data-execution_count="28">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>multiple_poisson_regression <span class="op">=</span> <span class="st">'''</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="st">functions {</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="st">    /*</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="st">    * Alternative to poisson_log_rng() that </span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a><span class="st">    * avoids potential numerical problems during warmup</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a><span class="st">    */</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a><span class="st">    int poisson_log_safe_rng(real eta) {</span></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a><span class="st">    real pois_rate = exp(eta);</span></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a><span class="st">    if (pois_rate &gt;= exp(20.79))</span></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a><span class="st">      return -9;</span></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a><span class="st">    return poisson_rng(pois_rate);</span></span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a><span class="st">    }</span></span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a><span class="st">data {</span></span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a><span class="st">    int&lt;lower=1&gt; N;</span></span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a><span class="st">    array[N] int&lt;lower=0&gt; complaints;</span></span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a><span class="st">    vector&lt;lower=0&gt;[N] traps;</span></span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a><span class="st">    vector&lt;lower=0,upper=1&gt;[N] live_in_super;</span></span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a><span class="st">    vector[N] log_sq_foot;  // exposure term</span></span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a><span class="st">parameters {</span></span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true" tabindex="-1"></a><span class="st">    real alpha;</span></span>
<span id="cb36-23"><a href="#cb36-23" aria-hidden="true" tabindex="-1"></a><span class="st">    real beta;</span></span>
<span id="cb36-24"><a href="#cb36-24" aria-hidden="true" tabindex="-1"></a><span class="st">    real beta_super;</span></span>
<span id="cb36-25"><a href="#cb36-25" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb36-26"><a href="#cb36-26" aria-hidden="true" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb36-27"><a href="#cb36-27" aria-hidden="true" tabindex="-1"></a><span class="st">    beta ~ normal(-0.25, 1);</span></span>
<span id="cb36-28"><a href="#cb36-28" aria-hidden="true" tabindex="-1"></a><span class="st">    beta_super ~ normal(-0.5, 1);</span></span>
<span id="cb36-29"><a href="#cb36-29" aria-hidden="true" tabindex="-1"></a><span class="st">    alpha ~ normal(log(4), 1);</span></span>
<span id="cb36-30"><a href="#cb36-30" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb36-31"><a href="#cb36-31" aria-hidden="true" tabindex="-1"></a><span class="st">    complaints ~ poisson_log(alpha + beta * traps + beta_super * live_in_super + log_sq_foot);</span></span>
<span id="cb36-32"><a href="#cb36-32" aria-hidden="true" tabindex="-1"></a><span class="st">} </span></span>
<span id="cb36-33"><a href="#cb36-33" aria-hidden="true" tabindex="-1"></a><span class="st">generated quantities {</span></span>
<span id="cb36-34"><a href="#cb36-34" aria-hidden="true" tabindex="-1"></a><span class="st">    array[N] int y_rep;</span></span>
<span id="cb36-35"><a href="#cb36-35" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb36-36"><a href="#cb36-36" aria-hidden="true" tabindex="-1"></a><span class="st">    for (n in 1:N) </span></span>
<span id="cb36-37"><a href="#cb36-37" aria-hidden="true" tabindex="-1"></a><span class="st">    y_rep[n] = poisson_log_safe_rng(alpha + beta * traps[n] + beta_super * live_in_super[n] + log_sq_foot[n]);</span></span>
<span id="cb36-38"><a href="#cb36-38" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb36-39"><a href="#cb36-39" aria-hidden="true" tabindex="-1"></a><span class="st">'''</span></span>
<span id="cb36-40"><a href="#cb36-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-41"><a href="#cb36-41" aria-hidden="true" tabindex="-1"></a>multiple_poisson_regression_model <span class="op">=</span> StanModel(<span class="st">'../stan_models/multiple_poisson_regression'</span>, multiple_poisson_regression)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="simulate-fake-data-with-multiple-predictors" class="level3">
<h3 class="anchored" data-anchor-id="simulate-fake-data-with-multiple-predictors">Simulate fake data with multiple predictors</h3>
<div id="d8f69c73" class="cell" data-execution_count="29">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>multiple_poisson_regression_dgp <span class="op">=</span> <span class="st">'''</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="st">data {</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="st">    int&lt;lower=1&gt; N;</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a><span class="st">} </span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a><span class="st">generated quantities {</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a><span class="st">    vector[N] log_sq_foot;</span></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a><span class="st">    array[N] int live_in_super;</span></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a><span class="st">    array[N] int traps;</span></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a><span class="st">    array[N] int complaints;</span></span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a><span class="st">    real alpha = normal_rng(log(4), .1);</span></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a><span class="st">    real beta = normal_rng(-0.25, .1);</span></span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a><span class="st">    real beta_super = normal_rng(-0.5, .1);</span></span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a><span class="st">    for (n in 1:N) {</span></span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a><span class="st">    log_sq_foot[n] = normal_rng(1.5, .1);</span></span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a><span class="st">    live_in_super[n] = bernoulli_rng(0.5);</span></span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a><span class="st">    traps[n] = poisson_rng(8);</span></span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a><span class="st">    complaints[n] = poisson_log_rng(alpha + log_sq_foot[n] </span></span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a><span class="st">                               + beta * traps[n] </span></span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a><span class="st">                               + beta_super * live_in_super[n]);</span></span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a><span class="st">    }</span></span>
<span id="cb37-25"><a href="#cb37-25" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb37-26"><a href="#cb37-26" aria-hidden="true" tabindex="-1"></a><span class="st">'''</span></span>
<span id="cb37-27"><a href="#cb37-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-28"><a href="#cb37-28" aria-hidden="true" tabindex="-1"></a>multiple_poisson_regression_dgp_model <span class="op">=</span> StanModel(<span class="st">'../stan_models/multiple_poisson_regression_dgp'</span>, multiple_poisson_regression_dgp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Fit / sample the prior predictive check model:</p>
<div id="55cece3b" class="cell" data-execution_count="30">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>fitted_model_dgp <span class="op">=</span> multiple_poisson_regression_dgp_model.sample(</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>{<span class="st">'N'</span>: <span class="bu">len</span>(pest_data.traps)},</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>    chains <span class="op">=</span> <span class="dv">1</span>,</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>    iter_sampling <span class="op">=</span> <span class="dv">1</span>,</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>    show_progress <span class="op">=</span> <span class="va">False</span>,</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>    fixed_param <span class="op">=</span> <span class="va">True</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>samps_dgp <span class="op">=</span> az.from_cmdstanpy(fitted_model_dgp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Now pop that simulated data into a dictionary ready for Stan.</p>
<div id="e1591fcd" class="cell" data-execution_count="31">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>stan_dat_fake <span class="op">=</span> {</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">'N'</span>: <span class="bu">len</span>(pest_data.traps),</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'complaints'</span>: samps_dgp.posterior.complaints.sel(chain<span class="op">=</span><span class="dv">0</span>, draw<span class="op">=</span><span class="dv">0</span>).to_numpy().astype(<span class="bu">int</span>),</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'traps'</span>: samps_dgp.posterior.traps.sel(chain<span class="op">=</span><span class="dv">0</span>, draw<span class="op">=</span><span class="dv">0</span>),</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'live_in_super'</span>: samps_dgp.posterior.live_in_super.sel(chain<span class="op">=</span><span class="dv">0</span>, draw<span class="op">=</span><span class="dv">0</span>),</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'log_sq_foot'</span>: samps_dgp.posterior.log_sq_foot.sel(chain<span class="op">=</span><span class="dv">0</span>, draw<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>And then compile and fit the model we wrote for the multiple regression.</p>
<div id="375be8a0" class="cell" data-execution_count="32">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>fit_model_P_mult <span class="op">=</span> multiple_poisson_regression_model.sample(data<span class="op">=</span>stan_dat_fake, show_progress<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>posterior_alpha_beta <span class="op">=</span> az.extract(az.from_cmdstanpy(fit_model_P_mult), <span class="st">'posterior'</span>, var_names<span class="op">=</span>[<span class="st">'alpha'</span>, <span class="st">'beta'</span>, <span class="st">'beta_super'</span>]).to_dataframe()[[<span class="st">'alpha'</span>, <span class="st">'beta'</span>, <span class="st">'beta_super'</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Then compare these parameters to the true parameters:</p>
<div id="5b302cfa" class="cell" data-execution_count="33">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>true_alpha <span class="op">=</span> samps_dgp.posterior.alpha.sel(chain<span class="op">=</span><span class="dv">0</span>, draw<span class="op">=</span><span class="dv">0</span>).to_numpy()</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>true_beta <span class="op">=</span> samps_dgp.posterior.beta.sel(chain<span class="op">=</span><span class="dv">0</span>, draw<span class="op">=</span><span class="dv">0</span>).to_numpy()</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>true_beta_super <span class="op">=</span> samps_dgp.posterior.beta_super.sel(chain<span class="op">=</span><span class="dv">0</span>, draw<span class="op">=</span><span class="dv">0</span>).to_numpy()</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>plt.clf()</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>_, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>,<span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">8</span>,<span class="dv">4</span>))</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>sns.histplot(posterior_alpha_beta, x<span class="op">=</span><span class="st">'alpha'</span>, bins<span class="op">=</span><span class="dv">30</span>, ax<span class="op">=</span>ax[<span class="dv">0</span>])</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].axvline(true_alpha, color<span class="op">=</span><span class="st">'r'</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>sns.histplot(posterior_alpha_beta, x<span class="op">=</span><span class="st">'beta'</span>, bins<span class="op">=</span><span class="dv">30</span>, ax<span class="op">=</span>ax[<span class="dv">1</span>])</span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].axvline(true_beta, color<span class="op">=</span><span class="st">'r'</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>sns.histplot(posterior_alpha_beta, x<span class="op">=</span><span class="st">'beta_super'</span>, bins<span class="op">=</span><span class="dv">30</span>, ax<span class="op">=</span>ax[<span class="dv">2</span>])</span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">2</span>].axvline(true_beta_super, color<span class="op">=</span><span class="st">'r'</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a>plt.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<pre><code>&lt;Figure size 500x400 with 0 Axes&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Pest%20Control%20Example_files/figure-html/cell-34-output-2.png" width="811" height="411" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>We’ve recovered the parameters sufficiently well, so we’ve probably coded the Stan program correctly and we’re ready to fit the real data.</p>
</section>
<section id="fit-the-real-data" class="level3">
<h3 class="anchored" data-anchor-id="fit-the-real-data">Fit the real data</h3>
<p>Now let’s use the real data and explore the fit.</p>
<div id="74980d05" class="cell" data-execution_count="34">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>fit_model_P_mult_real <span class="op">=</span> multiple_poisson_regression_model.sample(data<span class="op">=</span>stan_dat_simple, show_progress<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>az_fit_P_mult_real_data <span class="op">=</span> az.from_cmdstanpy(fit_model_P_mult_real, posterior_predictive<span class="op">=</span><span class="st">'y_rep'</span>)</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>y_rep <span class="op">=</span> az_fit_P_mult_real_data.posterior_predictive.y_rep</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cd71b0f6" class="cell" data-execution_count="35">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>plt.clf()</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">200</span>):</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>    sns.kdeplot(y_rep.sel(chain<span class="op">=</span><span class="bu">slice</span>(<span class="dv">0</span>), draw<span class="op">=</span>i).to_dataframe(), x<span class="op">=</span><span class="st">'y_rep'</span>, color<span class="op">=</span><span class="st">'k'</span>, alpha<span class="op">=</span><span class="fl">0.2</span>)</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>sns.kdeplot(stan_dat_simple[<span class="st">'complaints'</span>], color<span class="op">=</span><span class="st">'r'</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>plt.xlim(<span class="dv">0</span>,<span class="dv">25</span>)</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>plt.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Pest%20Control%20Example_files/figure-html/cell-36-output-1.png" width="511" height="411" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>This again looks like we haven’t captured the smaller counts very well, nor have we captured the larger counts.</p>
<div id="adbb9f6b" class="cell" data-execution_count="36">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>plt.clf()</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>_, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>sns.histplot(np.mean(y_rep <span class="op">==</span> <span class="dv">0</span>, axis<span class="op">=</span><span class="dv">2</span>).to_numpy().flatten(), bins<span class="op">=</span><span class="dv">20</span>, ax<span class="op">=</span>ax)</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>ax.axvline(np.mean(stan_dat_simple[<span class="st">'complaints'</span>] <span class="op">==</span> <span class="dv">0</span>), linewidth<span class="op">=</span><span class="dv">2</span>, color<span class="op">=</span><span class="st">'r'</span>)</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>plt.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<pre><code>&lt;Figure size 500x400 with 0 Axes&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Pest%20Control%20Example_files/figure-html/cell-37-output-2.png" width="511" height="411" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>We’re still severely underestimating the proportion of zeros in the data. Ideally this vertical line would fall somewhere within the histogram.</p>
<p>We can also plot uncertainty intervals for the predicted complaints for different numbers of traps.</p>
<div id="5498e617" class="cell" data-execution_count="37">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>plt.clf()</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>_, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>ax.plot(stan_dat_simple[<span class="st">'traps'</span>], stan_dat_simple[<span class="st">'complaints'</span>], <span class="st">'o'</span>, fillstyle<span class="op">=</span><span class="st">'none'</span>)</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>grouped_indices <span class="op">=</span> defaultdict(<span class="bu">list</span>)</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> idx, trap <span class="kw">in</span> <span class="bu">enumerate</span>(stan_dat_simple[<span class="st">'traps'</span>]):</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>    grouped_indices[trap].append(idx)</span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>grouped_array <span class="op">=</span> {trap: y_rep[:, :, idx_list].to_numpy().flatten() <span class="cf">for</span> trap, idx_list <span class="kw">in</span> grouped_indices.items()}</span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> traps_x, complaints_y <span class="kw">in</span> grouped_array.items():</span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>    inner_prob <span class="op">=</span> np.array([np.quantile(complaints_y, <span class="fl">0.75</span>), np.quantile(complaints_y, <span class="fl">0.25</span>)])  <span class="co"># az.hdi(complaints_y, hdi_prob=0.5)</span></span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a>    outer_prob <span class="op">=</span> np.array([np.quantile(complaints_y, <span class="fl">0.95</span>), np.quantile(complaints_y, <span class="fl">0.05</span>)])  <span class="co"># az.hdi(complaints_y, hdi_prob=0.9)</span></span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a>    ax.plot(np.full(inner_prob.shape, traps_x), inner_prob, <span class="st">'k'</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a>    ax.plot(np.full(outer_prob.shape, traps_x), outer_prob, <span class="st">'k'</span>, linewidth<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a>    ax.plot(traps_x, np.mean(complaints_y), <span class="st">'ko'</span>)</span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-19"><a href="#cb47-19" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb47-20"><a href="#cb47-20" aria-hidden="true" tabindex="-1"></a>plt.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<pre><code>&lt;Figure size 500x400 with 0 Axes&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Pest%20Control%20Example_files/figure-html/cell-38-output-2.png" width="511" height="411" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>We can see that we’ve increased the tails a bit more at the larger numbers of traps but we still have some large observed numbers of complaints that the model would consider extremely unlikely events.</p>
</section>
</section>
<section id="modeling-count-data-with-the-negative-binomial" class="level2">
<h2 class="anchored" data-anchor-id="modeling-count-data-with-the-negative-binomial">Modeling count data with the Negative Binomial</h2>
<p>When we considered modelling the data using a Poisson, we saw that the model didn’t appear to fit as well to the data as we would like. In particular the model under-predicted low and high numbers of complaints, and over-predicted the medium number of complaints. This is one indication of <strong>over-dispersion</strong>, where the variance is larger than the mean. A Poisson model doesn’t fit over-dispersed count data very well because the same parameter <span class="math inline">\(\lambda\)</span>, controls both the expected counts and the variance of these counts. The natural alternative to this is the <strong>negative binomial model</strong>:</p>
<p><span class="math display">\[
\begin{align*}
\text{complaints}_{b,t} &amp; \sim \text{Neg-Binomial}(\lambda_{b,t}, \phi) \\
\lambda_{b,t} &amp; = \exp{(\eta_{b,t})} \\
\eta_{b,t} &amp;= \alpha + \beta \, {\rm traps}_{b,t} + \beta_{\rm super} \, {\rm super}_{b} + \text{log_sq_foot}_{b}
\end{align*}
\]</span></p>
<p>In Stan the negative binomial mass function we’ll use is called <span class="math inline">\(\texttt{neg_binomial_2_log}(\text{ints} \, y, \text{reals} \, \eta, \text{reals} \, \phi)\)</span> in Stan. Like the <code>poisson_log</code> function, this negative binomial mass function that is parameterized in terms of its log-mean, <span class="math inline">\(\eta\)</span>, but it also has a precision <span class="math inline">\(\phi\)</span> such that</p>
<p><span class="math display">\[
\mathbb{E}[y] \, = \lambda = \exp(\eta)
\]</span></p>
<p><span class="math display">\[
\text{Var}[y] = \lambda + \lambda^2/\phi = \exp(\eta) + \exp(\eta)^2 / \phi.
\]</span></p>
<p>As <span class="math inline">\(\phi\)</span> gets larger the term <span class="math inline">\(\lambda^2 / \phi\)</span> approaches zero and so the variance of the negative-binomial approaches <span class="math inline">\(\lambda\)</span>, i.e., the negative-binomial gets closer and closer to the Poisson.</p>
<section id="stan-program-for-negative-binomial-regression" class="level3">
<h3 class="anchored" data-anchor-id="stan-program-for-negative-binomial-regression">Stan program for negative-binomial regression</h3>
<div id="adc96c13" class="cell" data-execution_count="38">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>multiple_NB_regression <span class="op">=</span> <span class="st">'''</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="st">functions {</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a><span class="st">    /*</span></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a><span class="st">    * Alternative to neg_binomial_2_log_rng() that </span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a><span class="st">    * avoids potential numerical problems during warmup</span></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a><span class="st">    */</span></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a><span class="st">    int neg_binomial_2_log_safe_rng(real eta, real phi) {</span></span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a><span class="st">    real gamma_rate = gamma_rng(phi, phi / exp(eta));</span></span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a><span class="st">    if (gamma_rate &gt;= exp(20.79))</span></span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a><span class="st">      return -9;</span></span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a><span class="st">      </span></span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a><span class="st">    return poisson_rng(gamma_rate);</span></span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a><span class="st">    }</span></span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a><span class="st">data {</span></span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a><span class="st">    int&lt;lower=1&gt; N;</span></span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a><span class="st">    vector&lt;lower=0&gt;[N] traps;</span></span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a><span class="st">    vector&lt;lower=0,upper=1&gt;[N] live_in_super;</span></span>
<span id="cb49-19"><a href="#cb49-19" aria-hidden="true" tabindex="-1"></a><span class="st">    vector[N] log_sq_foot;</span></span>
<span id="cb49-20"><a href="#cb49-20" aria-hidden="true" tabindex="-1"></a><span class="st">    array[N] int&lt;lower=0&gt; complaints;</span></span>
<span id="cb49-21"><a href="#cb49-21" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb49-22"><a href="#cb49-22" aria-hidden="true" tabindex="-1"></a><span class="st">parameters {</span></span>
<span id="cb49-23"><a href="#cb49-23" aria-hidden="true" tabindex="-1"></a><span class="st">    real alpha;</span></span>
<span id="cb49-24"><a href="#cb49-24" aria-hidden="true" tabindex="-1"></a><span class="st">    real beta;</span></span>
<span id="cb49-25"><a href="#cb49-25" aria-hidden="true" tabindex="-1"></a><span class="st">    real beta_super;</span></span>
<span id="cb49-26"><a href="#cb49-26" aria-hidden="true" tabindex="-1"></a><span class="st">    real&lt;lower=0&gt; inv_phi;  // Enforce positivity</span></span>
<span id="cb49-27"><a href="#cb49-27" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb49-28"><a href="#cb49-28" aria-hidden="true" tabindex="-1"></a><span class="st">transformed parameters {</span></span>
<span id="cb49-29"><a href="#cb49-29" aria-hidden="true" tabindex="-1"></a><span class="st">    real phi = inv(inv_phi);</span></span>
<span id="cb49-30"><a href="#cb49-30" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb49-31"><a href="#cb49-31" aria-hidden="true" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb49-32"><a href="#cb49-32" aria-hidden="true" tabindex="-1"></a><span class="st">    alpha ~ normal(log(4), 1);</span></span>
<span id="cb49-33"><a href="#cb49-33" aria-hidden="true" tabindex="-1"></a><span class="st">    beta ~ normal(-0.25, 1);</span></span>
<span id="cb49-34"><a href="#cb49-34" aria-hidden="true" tabindex="-1"></a><span class="st">    beta_super ~ normal(-0.5, 1);</span></span>
<span id="cb49-35"><a href="#cb49-35" aria-hidden="true" tabindex="-1"></a><span class="st">    inv_phi ~ normal(0, 1); // Alternative: normal(0.1, 0.1) // Alternative: exponential(1)</span></span>
<span id="cb49-36"><a href="#cb49-36" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb49-37"><a href="#cb49-37" aria-hidden="true" tabindex="-1"></a><span class="st">    complaints ~ neg_binomial_2_log(alpha + beta * traps + beta_super * live_in_super</span></span>
<span id="cb49-38"><a href="#cb49-38" aria-hidden="true" tabindex="-1"></a><span class="st">                                  + log_sq_foot, phi);</span></span>
<span id="cb49-39"><a href="#cb49-39" aria-hidden="true" tabindex="-1"></a><span class="st">} </span></span>
<span id="cb49-40"><a href="#cb49-40" aria-hidden="true" tabindex="-1"></a><span class="st">generated quantities {</span></span>
<span id="cb49-41"><a href="#cb49-41" aria-hidden="true" tabindex="-1"></a><span class="st">    array[N] int y_rep;</span></span>
<span id="cb49-42"><a href="#cb49-42" aria-hidden="true" tabindex="-1"></a><span class="st">    for (n in 1:N) </span></span>
<span id="cb49-43"><a href="#cb49-43" aria-hidden="true" tabindex="-1"></a><span class="st">    y_rep[n] = neg_binomial_2_log_safe_rng(alpha + beta * traps[n] + beta_super * live_in_super[n]</span></span>
<span id="cb49-44"><a href="#cb49-44" aria-hidden="true" tabindex="-1"></a><span class="st">                                       + log_sq_foot[n], phi);</span></span>
<span id="cb49-45"><a href="#cb49-45" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb49-46"><a href="#cb49-46" aria-hidden="true" tabindex="-1"></a><span class="st">'''</span></span>
<span id="cb49-47"><a href="#cb49-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-48"><a href="#cb49-48" aria-hidden="true" tabindex="-1"></a>multiple_NB_regression_model <span class="op">=</span> StanModel(<span class="st">'../stan_models/multiple_NB_regression'</span>, multiple_NB_regression)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="fake-data-fit-multiple-nb-regression" class="level3">
<h3 class="anchored" data-anchor-id="fake-data-fit-multiple-nb-regression">Fake data fit: Multiple NB regression</h3>
<div id="c3a68fc6" class="cell" data-execution_count="39">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>multiple_NB_regression_dgp <span class="op">=</span> <span class="st">'''</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="st">data {</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a><span class="st">    int&lt;lower=1&gt; N;</span></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a><span class="st">} </span></span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a><span class="st">generated quantities {</span></span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a><span class="st">    vector[N] log_sq_foot;</span></span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a><span class="st">    array[N] int live_in_super;</span></span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a><span class="st">    array[N] int traps;</span></span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a><span class="st">    array[N] int complaints;</span></span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a><span class="st">    real alpha = normal_rng(log(4), .1);</span></span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a><span class="st">    real beta = normal_rng(-0.25, .1);</span></span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a><span class="st">    real beta_super = normal_rng(-0.5, .1);</span></span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a><span class="st">    real inv_phi = abs(normal_rng(0,1));</span></span>
<span id="cb50-16"><a href="#cb50-16" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb50-17"><a href="#cb50-17" aria-hidden="true" tabindex="-1"></a><span class="st">    for (n in 1:N) {</span></span>
<span id="cb50-18"><a href="#cb50-18" aria-hidden="true" tabindex="-1"></a><span class="st">    log_sq_foot[n] = normal_rng(1.5, .1);</span></span>
<span id="cb50-19"><a href="#cb50-19" aria-hidden="true" tabindex="-1"></a><span class="st">    live_in_super[n] = bernoulli_rng(0.5);</span></span>
<span id="cb50-20"><a href="#cb50-20" aria-hidden="true" tabindex="-1"></a><span class="st">    traps[n] = poisson_rng(8);</span></span>
<span id="cb50-21"><a href="#cb50-21" aria-hidden="true" tabindex="-1"></a><span class="st">    complaints[n] = neg_binomial_2_log_rng(alpha + log_sq_foot[n] </span></span>
<span id="cb50-22"><a href="#cb50-22" aria-hidden="true" tabindex="-1"></a><span class="st">                               + beta * traps[n] </span></span>
<span id="cb50-23"><a href="#cb50-23" aria-hidden="true" tabindex="-1"></a><span class="st">                               + beta_super * live_in_super[n], inv(inv_phi));</span></span>
<span id="cb50-24"><a href="#cb50-24" aria-hidden="true" tabindex="-1"></a><span class="st">    }</span></span>
<span id="cb50-25"><a href="#cb50-25" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb50-26"><a href="#cb50-26" aria-hidden="true" tabindex="-1"></a><span class="st">'''</span></span>
<span id="cb50-27"><a href="#cb50-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-28"><a href="#cb50-28" aria-hidden="true" tabindex="-1"></a>multiple_NB_regression_dpg_model <span class="op">=</span> StanModel(<span class="st">'../stan_models/multiple_NB_regression_dgp'</span>, multiple_NB_regression_dgp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We’re going to generate one draw from the fake data model so we can use the data to fit our model and compare the known values of the parameters to the posterior density of the parameters.</p>
<div id="08578328" class="cell" data-execution_count="40">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>fitted_model_dgp_NB <span class="op">=</span> multiple_NB_regression_dpg_model.sample(</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>{<span class="st">'N'</span>: <span class="bu">len</span>(pest_data.traps)},</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>    chains <span class="op">=</span> <span class="dv">1</span>,</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>    iter_sampling <span class="op">=</span> <span class="dv">1</span>,</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>    show_progress <span class="op">=</span> <span class="va">False</span>,</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>    fixed_param<span class="op">=</span><span class="va">True</span></span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>samps_dgp_NB <span class="op">=</span> az.from_cmdstanpy(fitted_model_dgp_NB)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Create a dictionary to feed into the Stan model.</p>
<div id="a5caa320" class="cell" data-execution_count="41">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>stan_dat_fake_NB <span class="op">=</span> {</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">'N'</span>: <span class="bu">len</span>(pest_data.traps),</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'traps'</span>: samps_dgp_NB.posterior.traps.sel(chain<span class="op">=</span><span class="dv">0</span>, draw<span class="op">=</span><span class="dv">0</span>),</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'complaints'</span>: samps_dgp_NB.posterior.complaints.sel(chain<span class="op">=</span><span class="dv">0</span>, draw<span class="op">=</span><span class="dv">0</span>).to_numpy().astype(<span class="bu">int</span>),</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'live_in_super'</span>: samps_dgp_NB.posterior.live_in_super.sel(chain<span class="op">=</span><span class="dv">0</span>, draw<span class="op">=</span><span class="dv">0</span>),</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'log_sq_foot'</span>: samps_dgp_NB.posterior.log_sq_foot.sel(chain<span class="op">=</span><span class="dv">0</span>, draw<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Now we run our NB regression over the fake data and extract the samples to examine posterior predictive checks and to check whether we’ve sufficiently recovered our known parameters, <span class="math inline">\(\text{alpha}\)</span> <span class="math inline">\(\texttt{beta}\)</span>.</p>
<div id="d839213d" class="cell" data-execution_count="42">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>fitted_model_NB <span class="op">=</span> multiple_NB_regression_model.sample(data<span class="op">=</span>stan_dat_fake_NB, show_progress<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>posterior_alpha_beta_NB <span class="op">=</span> (</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>    az.extract(</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>        az.from_cmdstanpy(fitted_model_NB), <span class="st">'posterior'</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>    ).to_dataframe()[[<span class="st">'alpha'</span>, <span class="st">'beta'</span>, <span class="st">'beta_super'</span>, <span class="st">'inv_phi'</span>]]</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Construct the vector of true values from your simulated dataset and compare to the recovered parameters.</p>
<div id="6981e1be" class="cell" data-execution_count="43">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>true_params <span class="op">=</span> [<span class="st">'alpha'</span>, <span class="st">'beta'</span>, <span class="st">'beta_super'</span>, <span class="st">'inv_phi'</span>]</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>plt.clf()</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>_, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>,<span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">6</span>,<span class="dv">4</span>))</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, ax <span class="kw">in</span> <span class="bu">enumerate</span>(axes.flat):</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>    sns.histplot(posterior_alpha_beta_NB, x<span class="op">=</span>true_params[i], bins<span class="op">=</span><span class="dv">30</span>, ax<span class="op">=</span>ax)</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>    ax.axvline(samps_dgp_NB.posterior[true_params[i]].sel(chain<span class="op">=</span><span class="dv">0</span>, draw<span class="op">=</span><span class="dv">0</span>).to_numpy(), color<span class="op">=</span><span class="st">'r'</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>    ax.<span class="bu">set</span>(ylabel<span class="op">=</span><span class="st">''</span>)</span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>    ax.yaxis.set_ticks([])</span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>plt.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<pre><code>&lt;Figure size 500x400 with 0 Axes&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Pest%20Control%20Example_files/figure-html/cell-44-output-2.png" width="611" height="411" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="fit-to-real-data-and-check-the-fit" class="level3">
<h3 class="anchored" data-anchor-id="fit-to-real-data-and-check-the-fit">Fit to real data and check the fit</h3>
<div id="85335671" class="cell" data-execution_count="44">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>fitted_model_NB <span class="op">=</span> multiple_NB_regression_model.sample(data<span class="op">=</span>stan_dat_simple, show_progress<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>az_fitted_model_NB_data <span class="op">=</span> az.from_cmdstanpy(fitted_model_NB, posterior_predictive<span class="op">=</span><span class="st">'y_rep'</span>)</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>y_rep <span class="op">=</span> az_fitted_model_NB_data.posterior_predictive.y_rep</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Let’s look at our predictions vs.&nbsp;the data.</p>
<div id="bacd662a" class="cell" data-execution_count="45">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>plt.clf()</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">200</span>):</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>    sns.kdeplot(y_rep.sel(chain<span class="op">=</span><span class="bu">slice</span>(<span class="dv">0</span>), draw<span class="op">=</span>i).to_dataframe(), x<span class="op">=</span><span class="st">'y_rep'</span>, color<span class="op">=</span><span class="st">'k'</span>, alpha<span class="op">=</span><span class="fl">0.2</span>)</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>sns.kdeplot(stan_dat_simple[<span class="st">'complaints'</span>], color<span class="op">=</span><span class="st">'r'</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>plt.xlim(<span class="dv">0</span>,)</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>plt.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Pest%20Control%20Example_files/figure-html/cell-46-output-1.png" width="511" height="411" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>It appears that our model now captures both the number of small counts better as well as the tails.</p>
<p>Let’s check if the negative binomial model does a better job capturing the number of zeros:</p>
<div id="cc18ab7e" class="cell" data-execution_count="46">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>plt.clf()</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>_, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>sns.histplot(np.mean(y_rep <span class="op">==</span> <span class="dv">0</span>, axis<span class="op">=</span><span class="dv">2</span>).to_numpy().flatten(), bins<span class="op">=</span><span class="dv">25</span>, ax<span class="op">=</span>ax)</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>ax.axvline(np.mean(stan_dat_simple[<span class="st">'complaints'</span>] <span class="op">==</span> <span class="dv">0</span>), linewidth<span class="op">=</span><span class="dv">2</span>, color<span class="op">=</span><span class="st">'r'</span>)</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>plt.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<pre><code>&lt;Figure size 500x400 with 0 Axes&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Pest%20Control%20Example_files/figure-html/cell-47-output-2.png" width="511" height="411" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>These look OK, but let’s look at the standardized residual plot.</p>
<div id="745f90a9" class="cell" data-execution_count="47">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>mean_inv_phi <span class="op">=</span> az_fitted_model_NB_data.posterior.inv_phi.mean(dim<span class="op">=</span>[<span class="st">'chain'</span>, <span class="st">'draw'</span>])</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>mean_y_rep <span class="op">=</span> y_rep.mean(dim<span class="op">=</span>[<span class="st">'chain'</span>, <span class="st">'draw'</span>])</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>std_resid <span class="op">=</span> (stan_dat_simple[<span class="st">'complaints'</span>] <span class="op">-</span> mean_y_rep) <span class="op">/</span> np.sqrt(mean_y_rep <span class="op">+</span> mean_y_rep<span class="op">**</span><span class="dv">2</span> <span class="op">*</span> mean_inv_phi)</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>plt.clf()</span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>plt.plot(mean_y_rep, std_resid, <span class="st">'o'</span>, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>plt.axhline(<span class="dv">2</span>, linestyle<span class="op">=</span><span class="st">'--'</span>)</span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>plt.axhline(<span class="op">-</span><span class="dv">2</span>, linestyle<span class="op">=</span><span class="st">'--'</span>)</span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'mean_y_rep'</span>)</span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'std_resid'</span>)</span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a>plt.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Pest%20Control%20Example_files/figure-html/cell-48-output-1.png" width="511" height="411" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Looks OK, but we still have some very large <em>standardized</em> residuals. This might be because we are currently ignoring that the data are clustered by buildings, and that the probability of roach issue may vary substantially across buildings.</p>
<div id="1830af02" class="cell" data-execution_count="48">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>plt.clf()</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>vals, counts <span class="op">=</span> np.unique(y_rep, return_counts<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>hist_range <span class="op">=</span> (<span class="bu">min</span>(vals), <span class="bu">max</span>(vals))</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>az.plot_dist(stan_dat_simple[<span class="st">'complaints'</span>], kind<span class="op">=</span><span class="st">'hist'</span>, ax<span class="op">=</span>ax, </span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>             hist_kwargs<span class="op">=</span>{<span class="st">'bins'</span>: np.arange(hist_range[<span class="dv">0</span>], hist_range[<span class="dv">1</span>] <span class="op">+</span> <span class="dv">1</span>, <span class="dv">1</span>), <span class="st">'range'</span>: hist_range})</span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>secax <span class="op">=</span> ax.twinx()</span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a>secax.plot(vals, counts, color<span class="op">=</span><span class="st">'red'</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a>ax.set_xlim(hist_range[<span class="dv">0</span>]<span class="op">-</span><span class="fl">0.5</span>, hist_range[<span class="dv">1</span>]<span class="op">+</span><span class="fl">0.5</span>)</span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-13"><a href="#cb61-13" aria-hidden="true" tabindex="-1"></a>secax.set_yticklabels([])</span>
<span id="cb61-14"><a href="#cb61-14" aria-hidden="true" tabindex="-1"></a>secax.yaxis.set_ticks([])</span>
<span id="cb61-15"><a href="#cb61-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-16"><a href="#cb61-16" aria-hidden="true" tabindex="-1"></a>ax.xaxis.set_major_locator(mticker.MaxNLocator(nbins<span class="op">=</span><span class="dv">5</span>))</span>
<span id="cb61-17"><a href="#cb61-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-18"><a href="#cb61-18" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb61-19"><a href="#cb61-19" aria-hidden="true" tabindex="-1"></a>plt.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<pre><code>&lt;Figure size 500x400 with 0 Axes&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Pest%20Control%20Example_files/figure-html/cell-49-output-2.png" width="511" height="411" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>The rootogram now looks much more plausible. We can tell this because now the expected number of complaints matches much closer to the observed number of complaints. However, we still have some larger counts that appear to be outliers for the model.</p>
<p>Check predictions by number of traps:</p>
<div id="391a584e" class="cell" data-execution_count="49">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>plt.clf()</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>_, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>ax.plot(stan_dat_simple[<span class="st">'traps'</span>], stan_dat_simple[<span class="st">'complaints'</span>], <span class="st">'o'</span>, fillstyle<span class="op">=</span><span class="st">'none'</span>)</span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>grouped_indices <span class="op">=</span> defaultdict(<span class="bu">list</span>)</span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> idx, trap <span class="kw">in</span> <span class="bu">enumerate</span>(stan_dat_simple[<span class="st">'traps'</span>]):</span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>    grouped_indices[trap].append(idx)</span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a>grouped_array <span class="op">=</span> {trap: y_rep[:, :, idx_list].to_numpy().flatten() <span class="cf">for</span> trap, idx_list <span class="kw">in</span> grouped_indices.items()}</span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> traps_x, complaints_y <span class="kw">in</span> grouped_array.items():</span>
<span id="cb63-13"><a href="#cb63-13" aria-hidden="true" tabindex="-1"></a>    inner_prob <span class="op">=</span> np.array([np.quantile(complaints_y, <span class="fl">0.75</span>), np.quantile(complaints_y, <span class="fl">0.25</span>)])  <span class="co"># az.hdi(complaints_y, hdi_prob=0.5)</span></span>
<span id="cb63-14"><a href="#cb63-14" aria-hidden="true" tabindex="-1"></a>    outer_prob <span class="op">=</span> np.array([np.quantile(complaints_y, <span class="fl">0.95</span>), np.quantile(complaints_y, <span class="fl">0.05</span>)])  <span class="co"># az.hdi(complaints_y, hdi_prob=0.9)</span></span>
<span id="cb63-15"><a href="#cb63-15" aria-hidden="true" tabindex="-1"></a>    ax.plot(np.full(inner_prob.shape, traps_x), inner_prob, <span class="st">'k'</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb63-16"><a href="#cb63-16" aria-hidden="true" tabindex="-1"></a>    ax.plot(np.full(outer_prob.shape, traps_x), outer_prob, <span class="st">'k'</span>, linewidth<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb63-17"><a href="#cb63-17" aria-hidden="true" tabindex="-1"></a>    ax.plot(traps_x, np.mean(complaints_y), <span class="st">'ko'</span>)</span>
<span id="cb63-18"><a href="#cb63-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-19"><a href="#cb63-19" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb63-20"><a href="#cb63-20" aria-hidden="true" tabindex="-1"></a>plt.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<pre><code>&lt;Figure size 500x400 with 0 Axes&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Pest%20Control%20Example_files/figure-html/cell-50-output-2.png" width="511" height="411" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>We haven’t used the fact that the data are clustered by building yet. A posterior predictive check might elucidate whether it would be a good idea to add the building information into the model.</p>
<div id="4dfeb41e" class="cell" data-execution_count="50">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>plt.clf()</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>grouped_indices <span class="op">=</span> defaultdict(<span class="bu">list</span>)</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> idx, building_id <span class="kw">in</span> <span class="bu">enumerate</span>(pest_data[<span class="st">'building_id'</span>]):</span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>    grouped_indices[building_id].append(idx)</span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>grouped_array <span class="op">=</span> {bldg_id: y_rep[:, :, idx_list].mean(axis<span class="op">=</span><span class="dv">2</span>).to_numpy().flatten() <span class="cf">for</span> bldg_id, idx_list <span class="kw">in</span> grouped_indices.items()}</span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a>_, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">5</span>, figsize<span class="op">=</span>(<span class="dv">7</span>,<span class="dv">4</span>))</span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ax, key <span class="kw">in</span> <span class="bu">zip</span>(axes.flat, <span class="bu">sorted</span>(grouped_array.keys())):</span>
<span id="cb65-12"><a href="#cb65-12" aria-hidden="true" tabindex="-1"></a>    sns.histplot(grouped_array[key], bins<span class="op">=</span><span class="dv">30</span>, ax<span class="op">=</span>ax)</span>
<span id="cb65-13"><a href="#cb65-13" aria-hidden="true" tabindex="-1"></a>    ax.axvline(pest_data[pest_data[<span class="st">'building_id'</span>]<span class="op">==</span>key].complaints.mean(), color<span class="op">=</span><span class="st">'r'</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb65-14"><a href="#cb65-14" aria-hidden="true" tabindex="-1"></a>    ax.xaxis.set_major_locator(mticker.MaxNLocator(nbins<span class="op">=</span><span class="dv">4</span>))</span>
<span id="cb65-15"><a href="#cb65-15" aria-hidden="true" tabindex="-1"></a>    ax.<span class="bu">set</span>(ylabel<span class="op">=</span><span class="st">''</span>, title<span class="op">=</span><span class="ss">f"Bulding = </span><span class="sc">{</span>key<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb65-16"><a href="#cb65-16" aria-hidden="true" tabindex="-1"></a>    ax.yaxis.set_ticks([])</span>
<span id="cb65-17"><a href="#cb65-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-18"><a href="#cb65-18" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb65-19"><a href="#cb65-19" aria-hidden="true" tabindex="-1"></a>plt.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<pre><code>&lt;Figure size 500x400 with 0 Axes&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Pest%20Control%20Example_files/figure-html/cell-51-output-2.png" width="711" height="411" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>We’re getting plausible predictions for most building means but some are estimated better than others and some have larger uncertainties than we might expect. If we explicitly model the variation across buildings we may be able to get much better estimates.</p>
</section>
<section id="garbage-collect" class="level3">
<h3 class="anchored" data-anchor-id="garbage-collect">Garbage Collect</h3>
<div id="8dc7a0e4" class="cell" data-execution_count="51">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>exceptions <span class="op">=</span> [<span class="st">'pest_data'</span>, <span class="st">'exceptions'</span>, <span class="st">'active_variables'</span>]</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>active_variables <span class="op">=</span> [</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>    var <span class="cf">for</span> var, value <span class="kw">in</span> <span class="bu">globals</span>().items()</span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> var.startswith(<span class="st">'_'</span>)   <span class="co"># Exclude variables that start with "_"</span></span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">and</span> var <span class="kw">not</span> <span class="kw">in</span> exceptions    <span class="co"># Exclude variables in the exceptions list</span></span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">and</span> <span class="bu">isinstance</span>(value, (CmdStanModel, cmdstanpy.CmdStanMCMC, plt.Axes, </span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a>                           az.InferenceData, pd.DataFrame, pd.Series, </span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a>                           <span class="bu">dict</span>, <span class="bu">list</span>, <span class="bu">int</span>, <span class="bu">float</span>, <span class="bu">str</span>, <span class="bu">tuple</span>, plt.Figure, defaultdict,</span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true" tabindex="-1"></a>                           np.ndarray, np.int64, np.float32))  <span class="co"># Remove these types only</span></span>
<span id="cb67-11"><a href="#cb67-11" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb67-12"><a href="#cb67-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-13"><a href="#cb67-13" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> var <span class="kw">in</span> active_variables:</span>
<span id="cb67-14"><a href="#cb67-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">del</span> <span class="bu">globals</span>()[var]</span>
<span id="cb67-15"><a href="#cb67-15" aria-hidden="true" tabindex="-1"></a><span class="kw">del</span> active_variables, exceptions, var, _, g, y_rep, mean_inv_phi, mean_y_rep</span>
<span id="cb67-16"><a href="#cb67-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-17"><a href="#cb67-17" aria-hidden="true" tabindex="-1"></a>gc.collect()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="51">
<pre><code>160036</code></pre>
</div>
</div>
</section>
</section>
<section id="hierarchical-modeling" class="level2">
<h2 class="anchored" data-anchor-id="hierarchical-modeling">Hierarchical modeling</h2>
<section id="modeling-varying-intercepts-for-each-building" class="level3">
<h3 class="anchored" data-anchor-id="modeling-varying-intercepts-for-each-building">Modeling varying intercepts for each building</h3>
<p>Let’s add a hierarchical intercept parameter, <span class="math inline">\(\alpha_b\)</span> at the building level to our model.</p>
<p><span class="math display">\[
\begin{align*}
\text{complaints}_{b,t} &amp;\sim \text{Neg-Binomial}(\lambda_{b,t}, \phi) \\
\lambda_{b,t}  &amp;= \exp{(\eta_{b,t})} \\
\eta_{b,t} &amp;= \mu_b + \beta \, {\rm traps}_{b,t} + \beta_{\rm super}\, {\rm super}_b + \text{log_sq_foot}_b \\
\mu_b &amp;\sim \text{Normal}(\alpha, \sigma_{\mu})
\end{align*}
\]</span></p>
<p>In our Stan model, <span class="math inline">\(\mu_b\)</span> is the <span class="math inline">\(b\)</span>-th element of the vector <span class="math inline">\(\texttt{mu}\)</span> which has one element per building.</p>
<p>One of our predictors varies only by building, so we can rewrite the above model more efficiently like so:</p>
<p><span class="math display">\[
\begin{align*}
\eta_{b,t} &amp;= \mu_b + \beta \, {\rm traps}_{b,t} + \text{log_sq_foot}_b\\
\mu_b &amp;\sim \text{Normal}(\alpha +  \beta_{\text{super}} \, \text{super}_b , \sigma_{\mu})
\end{align*}
\]</span></p>
<p>We have more information at the building level as well, like the average age of the residents, the average age of the buildings, and the average per-apartment monthly rent so we can add that data into a matrix called <code>building_data</code>, which will have one row per building and four columns:</p>
<ul>
<li><code>live_in_super</code></li>
<li><code>age_of_building</code></li>
<li><code>average_tentant_age</code></li>
<li><code>monthly_average_rent</code></li>
</ul>
<p>We’ll write the Stan model like:</p>
<p><span class="math display">\[
\begin{align*}
\eta_{b,t} &amp;= \alpha_b + \beta \, {\rm traps} + \text{log_sq_foot}\\
\mu &amp;\sim \text{Normal}(\alpha + \texttt{building_data} \, \zeta, \,\sigma_{\mu})
\end{align*}
\]</span></p>
</section>
<section id="prepare-building-data-for-hierarchical" class="level3">
<h3 class="anchored" data-anchor-id="prepare-building-data-for-hierarchical">Prepare building data for hierarchical</h3>
<p>We’ll need to do some more data prep before we can fit our models. Firstly to use the building variable in Stan we will need to transform it from a factor variable to an integer variable.</p>
<div id="cd900495" class="cell" data-execution_count="52">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>N_months <span class="op">=</span> <span class="bu">len</span>(pest_data[<span class="st">'date'</span>].unique())</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>N_buildings <span class="op">=</span> <span class="bu">len</span>(pest_data[<span class="st">'building_id'</span>].unique())</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Add some IDs for building and month</span></span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>pest_data[<span class="st">'building_fac'</span>] <span class="op">=</span> pd.Categorical(pest_data[<span class="st">'building_id'</span>], categories<span class="op">=</span>pest_data[<span class="st">'building_id'</span>].unique())</span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>pest_data[<span class="st">'building_idx'</span>] <span class="op">=</span> pest_data[<span class="st">'building_fac'</span>].cat.codes <span class="op">+</span> <span class="dv">1</span>  <span class="co"># Convert to integer index (1-based)</span></span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>pest_data[<span class="st">'ids'</span>] <span class="op">=</span> <span class="bu">list</span>(<span class="bu">range</span>(<span class="dv">1</span>, N_months <span class="op">+</span> <span class="dv">1</span>)) <span class="op">*</span> N_buildings</span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a>pest_data[<span class="st">'mo_idx'</span>] <span class="op">=</span> pest_data[<span class="st">'date'</span>].dt.month  <span class="co"># Extract month from date column</span></span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Center and rescale the building specific data</span></span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a>building_data <span class="op">=</span> pest_data[[</span>
<span id="cb69-12"><a href="#cb69-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">'building_idx'</span>,</span>
<span id="cb69-13"><a href="#cb69-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">'live_in_super'</span>,</span>
<span id="cb69-14"><a href="#cb69-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">'age_of_building'</span>,</span>
<span id="cb69-15"><a href="#cb69-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">'total_sq_foot'</span>,</span>
<span id="cb69-16"><a href="#cb69-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">'average_tenant_age'</span>,</span>
<span id="cb69-17"><a href="#cb69-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">'monthly_average_rent'</span></span>
<span id="cb69-18"><a href="#cb69-18" aria-hidden="true" tabindex="-1"></a>]].drop_duplicates().sort_values(<span class="st">'building_idx'</span>).drop(columns<span class="op">=</span>[<span class="st">'building_idx'</span>])</span>
<span id="cb69-19"><a href="#cb69-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-20"><a href="#cb69-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Centering without scaling (subtract mean but don't divide by std)</span></span>
<span id="cb69-21"><a href="#cb69-21" aria-hidden="true" tabindex="-1"></a>building_data <span class="op">=</span> building_data <span class="op">-</span> building_data.mean()</span>
<span id="cb69-22"><a href="#cb69-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-23"><a href="#cb69-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Scale by constants</span></span>
<span id="cb69-24"><a href="#cb69-24" aria-hidden="true" tabindex="-1"></a>building_data[<span class="st">'age_of_building'</span>] <span class="op">/=</span> <span class="dv">10</span></span>
<span id="cb69-25"><a href="#cb69-25" aria-hidden="true" tabindex="-1"></a>building_data[<span class="st">'total_sq_foot'</span>] <span class="op">/=</span> <span class="dv">10000</span></span>
<span id="cb69-26"><a href="#cb69-26" aria-hidden="true" tabindex="-1"></a>building_data[<span class="st">'average_tenant_age'</span>] <span class="op">/=</span> <span class="dv">10</span></span>
<span id="cb69-27"><a href="#cb69-27" aria-hidden="true" tabindex="-1"></a>building_data[<span class="st">'monthly_average_rent'</span>] <span class="op">/=</span> <span class="dv">1000</span></span>
<span id="cb69-28"><a href="#cb69-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-29"><a href="#cb69-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert to NumPy matrix</span></span>
<span id="cb69-30"><a href="#cb69-30" aria-hidden="true" tabindex="-1"></a>building_data_matrix <span class="op">=</span> building_data.to_numpy()</span>
<span id="cb69-31"><a href="#cb69-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-32"><a href="#cb69-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Make data dictionary for Stan</span></span>
<span id="cb69-33"><a href="#cb69-33" aria-hidden="true" tabindex="-1"></a>stan_dat_hier <span class="op">=</span> {</span>
<span id="cb69-34"><a href="#cb69-34" aria-hidden="true" tabindex="-1"></a>  <span class="st">'complaints'</span>: pest_data.complaints,</span>
<span id="cb69-35"><a href="#cb69-35" aria-hidden="true" tabindex="-1"></a>  <span class="st">'traps'</span>: pest_data.traps,</span>
<span id="cb69-36"><a href="#cb69-36" aria-hidden="true" tabindex="-1"></a>  <span class="st">'N'</span>: <span class="bu">len</span>(pest_data.traps),</span>
<span id="cb69-37"><a href="#cb69-37" aria-hidden="true" tabindex="-1"></a>  <span class="st">'J'</span>: N_buildings,</span>
<span id="cb69-38"><a href="#cb69-38" aria-hidden="true" tabindex="-1"></a>  <span class="st">'M'</span>: N_months,</span>
<span id="cb69-39"><a href="#cb69-39" aria-hidden="true" tabindex="-1"></a>  <span class="st">'log_sq_foot'</span>: np.log(pest_data.total_sq_foot<span class="op">/</span><span class="fl">1e4</span>),</span>
<span id="cb69-40"><a href="#cb69-40" aria-hidden="true" tabindex="-1"></a>  <span class="st">'building_data'</span>: np.delete(building_data_matrix, <span class="dv">2</span>, axis<span class="op">=</span><span class="dv">1</span>),</span>
<span id="cb69-41"><a href="#cb69-41" aria-hidden="true" tabindex="-1"></a>  <span class="st">'mo_idx'</span>: pest_data.mo_idx,</span>
<span id="cb69-42"><a href="#cb69-42" aria-hidden="true" tabindex="-1"></a>  <span class="st">'K'</span>: <span class="dv">4</span>,</span>
<span id="cb69-43"><a href="#cb69-43" aria-hidden="true" tabindex="-1"></a>  <span class="st">'building_idx'</span>: pest_data.building_idx</span>
<span id="cb69-44"><a href="#cb69-44" aria-hidden="true" tabindex="-1"></a>  }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="compile-and-fit-the-hierarchical-model" class="level3">
<h3 class="anchored" data-anchor-id="compile-and-fit-the-hierarchical-model">Compile and fit the hierarchical model</h3>
<p>Let’s code up and compile the model.</p>
<div id="dc35cf5a" class="cell" data-execution_count="53">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>hier_NB_regression <span class="op">=</span> <span class="st">'''</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a><span class="st">functions {</span></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a><span class="st">  /*</span></span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a><span class="st">  * Alternative to neg_binomial_2_log_rng() that </span></span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a><span class="st">  * avoids potential numerical problems during warmup</span></span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a><span class="st">  */</span></span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a><span class="st">  int neg_binomial_2_log_safe_rng(real eta, real phi) {</span></span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a><span class="st">    real gamma_rate = gamma_rng(phi, phi / exp(eta));</span></span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a><span class="st">    if (gamma_rate &gt;= exp(20.79))</span></span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a><span class="st">      return -9;</span></span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a><span class="st">      </span></span>
<span id="cb70-12"><a href="#cb70-12" aria-hidden="true" tabindex="-1"></a><span class="st">    return poisson_rng(gamma_rate);</span></span>
<span id="cb70-13"><a href="#cb70-13" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb70-14"><a href="#cb70-14" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb70-15"><a href="#cb70-15" aria-hidden="true" tabindex="-1"></a><span class="st">data {</span></span>
<span id="cb70-16"><a href="#cb70-16" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; N;                     </span></span>
<span id="cb70-17"><a href="#cb70-17" aria-hidden="true" tabindex="-1"></a><span class="st">  array[N] int&lt;lower=0&gt; complaints;</span></span>
<span id="cb70-18"><a href="#cb70-18" aria-hidden="true" tabindex="-1"></a><span class="st">  vector&lt;lower=0&gt;[N] traps;</span></span>
<span id="cb70-19"><a href="#cb70-19" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb70-20"><a href="#cb70-20" aria-hidden="true" tabindex="-1"></a><span class="st">  // 'exposure'</span></span>
<span id="cb70-21"><a href="#cb70-21" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N] log_sq_foot;  </span></span>
<span id="cb70-22"><a href="#cb70-22" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb70-23"><a href="#cb70-23" aria-hidden="true" tabindex="-1"></a><span class="st">  // building-level data</span></span>
<span id="cb70-24"><a href="#cb70-24" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; K;</span></span>
<span id="cb70-25"><a href="#cb70-25" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; J;</span></span>
<span id="cb70-26"><a href="#cb70-26" aria-hidden="true" tabindex="-1"></a><span class="st">  array[N] int &lt;lower=1, upper=J&gt; building_idx;</span></span>
<span id="cb70-27"><a href="#cb70-27" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[J,K] building_data;</span></span>
<span id="cb70-28"><a href="#cb70-28" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb70-29"><a href="#cb70-29" aria-hidden="true" tabindex="-1"></a><span class="st">parameters {</span></span>
<span id="cb70-30"><a href="#cb70-30" aria-hidden="true" tabindex="-1"></a><span class="st">  real&lt;lower=0&gt; inv_phi;   // 1/phi (easier to think about prior for 1/phi instead of phi)</span></span>
<span id="cb70-31"><a href="#cb70-31" aria-hidden="true" tabindex="-1"></a><span class="st">  real beta;               // coefficient on traps</span></span>
<span id="cb70-32"><a href="#cb70-32" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb70-33"><a href="#cb70-33" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[J] mu;            // buildings-specific intercepts</span></span>
<span id="cb70-34"><a href="#cb70-34" aria-hidden="true" tabindex="-1"></a><span class="st">  real&lt;lower=0&gt; sigma_mu;  // sd of building-specific intercepts</span></span>
<span id="cb70-35"><a href="#cb70-35" aria-hidden="true" tabindex="-1"></a><span class="st">  real alpha;              // intercept of model for mu</span></span>
<span id="cb70-36"><a href="#cb70-36" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[K] zeta;          // coefficients on building-level predictors in model for mu </span></span>
<span id="cb70-37"><a href="#cb70-37" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb70-38"><a href="#cb70-38" aria-hidden="true" tabindex="-1"></a><span class="st">transformed parameters {</span></span>
<span id="cb70-39"><a href="#cb70-39" aria-hidden="true" tabindex="-1"></a><span class="st">  real phi = inv(inv_phi);</span></span>
<span id="cb70-40"><a href="#cb70-40" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb70-41"><a href="#cb70-41" aria-hidden="true" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb70-42"><a href="#cb70-42" aria-hidden="true" tabindex="-1"></a><span class="st">  mu ~ normal(alpha + building_data * zeta, sigma_mu);</span></span>
<span id="cb70-43"><a href="#cb70-43" aria-hidden="true" tabindex="-1"></a><span class="st">  sigma_mu ~ normal(0, 1);</span></span>
<span id="cb70-44"><a href="#cb70-44" aria-hidden="true" tabindex="-1"></a><span class="st">  alpha ~ normal(log(4), 1);</span></span>
<span id="cb70-45"><a href="#cb70-45" aria-hidden="true" tabindex="-1"></a><span class="st">  zeta ~ normal(0, 1);  // could also use informative priors on the different elements</span></span>
<span id="cb70-46"><a href="#cb70-46" aria-hidden="true" tabindex="-1"></a><span class="st">  beta ~ normal(-0.25, 1);</span></span>
<span id="cb70-47"><a href="#cb70-47" aria-hidden="true" tabindex="-1"></a><span class="st">  inv_phi ~ normal(0, 1);</span></span>
<span id="cb70-48"><a href="#cb70-48" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb70-49"><a href="#cb70-49" aria-hidden="true" tabindex="-1"></a><span class="st">  complaints ~ neg_binomial_2_log(mu[building_idx] + beta * traps + log_sq_foot, phi);</span></span>
<span id="cb70-50"><a href="#cb70-50" aria-hidden="true" tabindex="-1"></a><span class="st">} </span></span>
<span id="cb70-51"><a href="#cb70-51" aria-hidden="true" tabindex="-1"></a><span class="st">generated quantities {</span></span>
<span id="cb70-52"><a href="#cb70-52" aria-hidden="true" tabindex="-1"></a><span class="st">  array[N] int y_rep;</span></span>
<span id="cb70-53"><a href="#cb70-53" aria-hidden="true" tabindex="-1"></a><span class="st">  for (n in 1:N) {</span></span>
<span id="cb70-54"><a href="#cb70-54" aria-hidden="true" tabindex="-1"></a><span class="st">    real eta_n = mu[building_idx[n]] + beta * traps[n] + log_sq_foot[n];</span></span>
<span id="cb70-55"><a href="#cb70-55" aria-hidden="true" tabindex="-1"></a><span class="st">    y_rep[n] = neg_binomial_2_log_safe_rng(eta_n, phi);</span></span>
<span id="cb70-56"><a href="#cb70-56" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb70-57"><a href="#cb70-57" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb70-58"><a href="#cb70-58" aria-hidden="true" tabindex="-1"></a><span class="st">'''</span></span>
<span id="cb70-59"><a href="#cb70-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-60"><a href="#cb70-60" aria-hidden="true" tabindex="-1"></a>hier_NB_regression_model <span class="op">=</span> StanModel(<span class="st">'../stan_models/hier_NB_regression'</span>, hier_NB_regression)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Fit the model to data.</p>
<div id="a3cb27a1" class="cell" data-execution_count="54">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>fitted_model_NB_hier <span class="op">=</span> hier_NB_regression_model.sample(data<span class="op">=</span>stan_dat_hier, </span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>                                                       chains<span class="op">=</span><span class="dv">4</span>, </span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>                                                       parallel_chains<span class="op">=</span><span class="dv">4</span>,</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>                                                       iter_sampling<span class="op">=</span><span class="dv">4000</span>, </span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>                                                       seed<span class="op">=</span>[<span class="dv">1034992638</span>, <span class="dv">1034992638</span>, <span class="dv">1034992638</span>, <span class="dv">1034992638</span>],</span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a>                                                       show_progress<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a>az_samps_hier_NB <span class="op">=</span> az.from_cmdstanpy(fitted_model_NB_hier, posterior_predictive<span class="op">=</span><span class="st">'y_rep'</span>, observed_data<span class="op">=</span>stan_dat_hier)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="diagnostics" class="level3">
<h3 class="anchored" data-anchor-id="diagnostics">Diagnostics</h3>
<p>We get a bunch of warnings from Stan about divergent transitions, which is an indication that there may be regions of the posterior that have not been explored by the Markov chains.</p>
<p>Divergences are discussed in more detail in the course slides as well as the <strong>bayesplot</strong> <a href="http://mc-stan.org/bayesplot/articles/visual-mcmc-diagnostics.html">MCMC diagnostics vignette</a> and <a href="https://arxiv.org/abs/1701.02434"><em>A Conceptual Introduction to Hamiltonian Monte Carlo</em></a>.</p>
<p>In this example we will see that we have divergent transitions because we need to reparameterize our model - i.e., we will retain the overall structure of the model, but transform some of the parameters so that it is easier for Stan to sample from the parameter space. Before we go through exactly how to do this reparameterization, we will first go through what indicates that this is something that reparameterization will resolve. We will go through:</p>
<ol type="1">
<li>Examining the fitted parameter values, including the effective sample size</li>
<li>Traceplots and scatterplots that reveal particular patterns in locations of the divergences.</li>
</ol>
<p>Let us first run the <code>diagnose</code> and <code>summary</code> method on the model object <code>fitted_model_NB_hier</code>:</p>
<div id="87e16433" class="cell" data-execution_count="55">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(fitted_model_NB_hier.diagnose())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Checking sampler transitions treedepth.
Treedepth satisfactory for all transitions.

Checking sampler transitions for divergences.
1431 of 4000 (35.77%) transitions ended with a divergence.
These divergent transitions indicate that HMC is not fully able to explore the posterior distribution.
Try increasing adapt delta closer to 1.
If this doesn't remove all divergences, try to reparameterize the model.

Checking E-BFMI - sampler transitions HMC potential energy.
E-BFMI satisfactory.

Rank-normalized split effective sample size satisfactory for all parameters.

The following parameters had rank-normalized split R-hat greater than 1.01:
  sigma_mu
Such high values indicate incomplete mixing and biased estimation.
You should consider regularizating your model with additional prior information or a more effective parameterization.

Processing complete.
</code></pre>
</div>
</div>
<p>This reports that 32% of the samples ended with a divergence.</p>
<p>Now, let’s extract the fits from the model.</p>
<div id="ee92843f" class="cell" data-execution_count="56">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>summary <span class="op">=</span> fitted_model_NB_hier.summary(percentiles<span class="op">=</span>(<span class="dv">5</span>, <span class="dv">95</span>)).<span class="bu">round</span>(<span class="dv">2</span>)</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>summary[<span class="op">~</span>summary.index.<span class="bu">str</span>.contains(<span class="st">'y_rep'</span>)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="56">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Mean</th>
<th data-quarto-table-cell-role="th">MCSE</th>
<th data-quarto-table-cell-role="th">StdDev</th>
<th data-quarto-table-cell-role="th">MAD</th>
<th data-quarto-table-cell-role="th">5%</th>
<th data-quarto-table-cell-role="th">95%</th>
<th data-quarto-table-cell-role="th">ESS_bulk</th>
<th data-quarto-table-cell-role="th">ESS_tail</th>
<th data-quarto-table-cell-role="th">R_hat</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">lp__</td>
<td>-268.53</td>
<td>0.34</td>
<td>6.59</td>
<td>6.51</td>
<td>-278.86</td>
<td>-257.28</td>
<td>404.61</td>
<td>172.60</td>
<td>1.01</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">inv_phi</td>
<td>0.66</td>
<td>0.00</td>
<td>0.14</td>
<td>0.14</td>
<td>0.45</td>
<td>0.91</td>
<td>1786.10</td>
<td>5755.14</td>
<td>1.00</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">beta</td>
<td>-0.23</td>
<td>0.00</td>
<td>0.06</td>
<td>0.06</td>
<td>-0.33</td>
<td>-0.13</td>
<td>1208.69</td>
<td>2685.52</td>
<td>1.01</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">mu[1]</td>
<td>1.27</td>
<td>0.01</td>
<td>0.54</td>
<td>0.51</td>
<td>0.39</td>
<td>2.16</td>
<td>1394.05</td>
<td>3469.98</td>
<td>1.01</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">mu[2]</td>
<td>1.22</td>
<td>0.01</td>
<td>0.51</td>
<td>0.50</td>
<td>0.39</td>
<td>2.07</td>
<td>1477.69</td>
<td>3956.30</td>
<td>1.00</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">mu[3]</td>
<td>1.39</td>
<td>0.02</td>
<td>0.48</td>
<td>0.47</td>
<td>0.61</td>
<td>2.20</td>
<td>958.95</td>
<td>2043.49</td>
<td>1.01</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">mu[4]</td>
<td>1.43</td>
<td>0.01</td>
<td>0.47</td>
<td>0.46</td>
<td>0.67</td>
<td>2.22</td>
<td>1726.18</td>
<td>3803.09</td>
<td>1.01</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">mu[5]</td>
<td>1.07</td>
<td>0.01</td>
<td>0.42</td>
<td>0.41</td>
<td>0.40</td>
<td>1.75</td>
<td>1171.63</td>
<td>4564.63</td>
<td>1.01</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">mu[6]</td>
<td>1.16</td>
<td>0.01</td>
<td>0.47</td>
<td>0.46</td>
<td>0.37</td>
<td>1.92</td>
<td>1040.17</td>
<td>2432.11</td>
<td>1.01</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">mu[7]</td>
<td>1.45</td>
<td>0.01</td>
<td>0.50</td>
<td>0.48</td>
<td>0.61</td>
<td>2.28</td>
<td>1504.63</td>
<td>2175.90</td>
<td>1.00</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">mu[8]</td>
<td>1.23</td>
<td>0.02</td>
<td>0.44</td>
<td>0.44</td>
<td>0.49</td>
<td>1.93</td>
<td>536.04</td>
<td>193.35</td>
<td>1.01</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">mu[9]</td>
<td>1.40</td>
<td>0.02</td>
<td>0.56</td>
<td>0.55</td>
<td>0.48</td>
<td>2.30</td>
<td>876.97</td>
<td>4529.49</td>
<td>1.01</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">mu[10]</td>
<td>0.86</td>
<td>0.01</td>
<td>0.36</td>
<td>0.36</td>
<td>0.29</td>
<td>1.45</td>
<td>1557.41</td>
<td>4753.73</td>
<td>1.00</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">sigma_mu</td>
<td>0.24</td>
<td>0.01</td>
<td>0.17</td>
<td>0.15</td>
<td>0.05</td>
<td>0.57</td>
<td>339.97</td>
<td>6005.71</td>
<td>1.02</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">alpha</td>
<td>1.25</td>
<td>0.01</td>
<td>0.42</td>
<td>0.41</td>
<td>0.56</td>
<td>1.94</td>
<td>1133.95</td>
<td>2264.72</td>
<td>1.01</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">zeta[1]</td>
<td>-0.20</td>
<td>0.01</td>
<td>0.34</td>
<td>0.32</td>
<td>-0.72</td>
<td>0.39</td>
<td>1802.17</td>
<td>1172.26</td>
<td>1.01</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">zeta[2]</td>
<td>0.14</td>
<td>0.01</td>
<td>0.25</td>
<td>0.23</td>
<td>-0.25</td>
<td>0.54</td>
<td>2374.92</td>
<td>6221.82</td>
<td>1.01</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">zeta[3]</td>
<td>0.04</td>
<td>0.01</td>
<td>0.19</td>
<td>0.17</td>
<td>-0.29</td>
<td>0.34</td>
<td>800.92</td>
<td>228.18</td>
<td>1.01</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">zeta[4]</td>
<td>0.01</td>
<td>0.01</td>
<td>0.42</td>
<td>0.40</td>
<td>-0.67</td>
<td>0.70</td>
<td>3138.87</td>
<td>6823.70</td>
<td>1.00</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">phi</td>
<td>1.59</td>
<td>0.01</td>
<td>0.35</td>
<td>0.34</td>
<td>1.10</td>
<td>2.22</td>
<td>1786.10</td>
<td>5755.14</td>
<td>1.00</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>You can see that the effective samples are quite low for many of the parameters relative to the total number of samples. This alone isn’t indicative of the need to reparameterize, but it indicates that we should look further at the trace plots and pairs plots. First let’s look at the traceplots to see if the divergent transitions form a pattern.</p>
<div id="752b9513" class="cell" data-execution_count="57">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>plt.clf()</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>az.plot_trace(az_samps_hier_NB, var_names<span class="op">=</span><span class="st">'sigma_mu'</span>, divergences<span class="op">=</span><span class="st">'bottom'</span>)</span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>plt.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<pre><code>&lt;Figure size 500x400 with 0 Axes&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Pest%20Control%20Example_files/figure-html/cell-58-output-2.png" width="1211" height="211" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Looks as if the divergent parameters, the the black bars underneath the traceplots correspond to samples where the sampler gets stuck at one parameter value for <span class="math inline">\(\sigma_\mu\)</span>.</p>
<div id="72f9b69c" class="cell" data-execution_count="58">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>plot_mu <span class="op">=</span> az_samps_hier_NB.posterior.mu.sel(mu_dim_0<span class="op">=</span><span class="dv">3</span>).to_numpy().flatten()</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>plot_sigma_mu <span class="op">=</span> np.log(az_samps_hier_NB.posterior.sigma_mu.to_numpy().flatten())</span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>divergent_filter <span class="op">=</span> az_samps_hier_NB.sample_stats.diverging.to_numpy().flatten()</span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>plt.clf()</span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a>_, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a>sns.scatterplot(x<span class="op">=</span>plot_mu, y<span class="op">=</span>plot_sigma_mu, alpha<span class="op">=</span><span class="fl">0.2</span>, ax<span class="op">=</span>ax)</span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a>sns.scatterplot(x<span class="op">=</span>plot_mu[divergent_filter], y<span class="op">=</span>plot_sigma_mu[divergent_filter], color<span class="op">=</span><span class="st">'r'</span>, alpha<span class="op">=</span><span class="fl">0.5</span>, ax<span class="op">=</span>ax)</span>
<span id="cb77-9"><a href="#cb77-9" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb77-10"><a href="#cb77-10" aria-hidden="true" tabindex="-1"></a>plt.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<pre><code>&lt;Figure size 500x400 with 0 Axes&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Pest%20Control%20Example_files/figure-html/cell-59-output-2.png" width="511" height="411" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>What we have here is a cloud-like shape, with most of the divergences clustering towards the bottom. We’ll see a bit later that we actually want this to look more like a funnel than a cloud, but the divergences are indicating that the sampler can’t explore the narrowing neck of the funnel.</p>
<p>One way to see why we should expect some version of a funnel is to look at some simulations from the prior, which we can do without MCMC and thus with no risk of sampling problems:</p>
<div id="e1550183" class="cell" data-execution_count="59">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>N_sims <span class="op">=</span> <span class="dv">1000</span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>log_sigma <span class="op">=</span> np.random.normal(loc<span class="op">=</span><span class="dv">0</span>, scale<span class="op">=</span><span class="dv">1</span>, size<span class="op">=</span>N_sims)</span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>theta <span class="op">=</span> np.random.normal(loc<span class="op">=</span><span class="dv">0</span>, scale<span class="op">=</span>np.exp(log_sigma))</span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>plt.clf()</span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a>_, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a>sns.scatterplot(x<span class="op">=</span>theta, y<span class="op">=</span>log_sigma, alpha<span class="op">=</span><span class="fl">0.2</span>, ax<span class="op">=</span>ax)</span>
<span id="cb79-8"><a href="#cb79-8" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb79-9"><a href="#cb79-9" aria-hidden="true" tabindex="-1"></a>plt.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<pre><code>&lt;Figure size 500x400 with 0 Axes&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Pest%20Control%20Example_files/figure-html/cell-60-output-2.png" width="511" height="411" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Of course, if the data is at all informative we shouldn’t expect the posterior to look exactly like the prior. But unless the data is incredibly informative about the parameters and the posterior concentrates away from the narrow neck of the funnel, the sampler is going to have to confront the funnel geometry. (See the <a href="http://mc-stan.org/bayesplot/articles/visual-mcmc-diagnostics.html">Visual MCMC Diagnostics</a> vignette for more on this.)</p>
<p>Another way to look at the divergences is via a parallel coordinates plot:</p>
<div id="65bf65b2" class="cell" data-execution_count="60">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>param_mat <span class="op">=</span> np.zeros((<span class="dv">11</span>, <span class="dv">4000</span><span class="op">*</span><span class="dv">4</span>))</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>param_mat[<span class="dv">0</span>,:] <span class="op">=</span> az_samps_hier_NB.posterior.sigma_mu.to_numpy().flatten()</span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">10</span>):</span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>    param_mat[i<span class="op">+</span><span class="dv">1</span>,:] <span class="op">=</span> az_samps_hier_NB.posterior.mu.sel(mu_dim_0<span class="op">=</span>i).to_numpy().flatten()</span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a>divergent_mat <span class="op">=</span> np.zeros((<span class="dv">11</span>, np.<span class="bu">sum</span>(divergent_filter)))</span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">11</span>):</span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a>    divergent_mat[i,:] <span class="op">=</span> param_mat[i, divergent_filter]</span>
<span id="cb81-9"><a href="#cb81-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-10"><a href="#cb81-10" aria-hidden="true" tabindex="-1"></a>custom_labels <span class="op">=</span> [<span class="st">"sigma_mu"</span>, <span class="st">"mu[1]"</span>, <span class="st">"mu[2]"</span>, <span class="st">"mu[3]"</span>, <span class="st">"mu[4]"</span>, <span class="st">"mu[5]"</span>,</span>
<span id="cb81-11"><a href="#cb81-11" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"mu[6]"</span>, <span class="st">"mu[7]"</span>, <span class="st">"mu[8]"</span>, <span class="st">"mu[9]"</span>, <span class="st">"mu[10]"</span>]</span>
<span id="cb81-12"><a href="#cb81-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-13"><a href="#cb81-13" aria-hidden="true" tabindex="-1"></a>plt.clf()</span>
<span id="cb81-14"><a href="#cb81-14" aria-hidden="true" tabindex="-1"></a>plt.plot(param_mat, <span class="st">'k'</span>, alpha<span class="op">=</span><span class="fl">0.015</span>)</span>
<span id="cb81-15"><a href="#cb81-15" aria-hidden="true" tabindex="-1"></a>plt.plot(divergent_mat, <span class="st">'r'</span>, alpha<span class="op">=</span><span class="fl">0.025</span>)</span>
<span id="cb81-16"><a href="#cb81-16" aria-hidden="true" tabindex="-1"></a>plt.xlim(<span class="dv">0</span>,<span class="dv">10</span>)</span>
<span id="cb81-17"><a href="#cb81-17" aria-hidden="true" tabindex="-1"></a>plt.xticks(np.arange(<span class="dv">11</span>), custom_labels)</span>
<span id="cb81-18"><a href="#cb81-18" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb81-19"><a href="#cb81-19" aria-hidden="true" tabindex="-1"></a>plt.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Pest%20Control%20Example_files/figure-html/cell-61-output-1.png" width="511" height="411" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Again, we see evidence that our problems concentrate when <span class="math inline">\(\texttt{sigma_mu}\)</span> is small.</p>
</section>
<section id="reparameterize-and-recheck-diagnostics" class="level3">
<h3 class="anchored" data-anchor-id="reparameterize-and-recheck-diagnostics">Reparameterize and recheck diagnostics</h3>
<p>Instead, we should use the non-centered parameterization for <span class="math inline">\(\mu_b\)</span>. We define a vector of auxiliary variables in the parameters block, <span class="math inline">\(\texttt{mu_raw}\)</span> that is given a <span class="math inline">\(\text{Normal}(0, 1)\)</span> prior in the model block. We then make <span class="math inline">\(\texttt{mu}\)</span> a transformed parameter:</p>
<p>We can reparameterize the random intercept <span class="math inline">\(\mu_b\)</span>, which is distributed:</p>
<p><span class="math display">\[
\mu_b \sim \text{Normal}(\alpha + \texttt{building_data} \, \zeta, \sigma_{\mu})
\]</span></p>
<pre><code>transformed parameters {
  vector[J] mu;
  mu = alpha + building_data * zeta + sigma_mu * mu_raw;
}</code></pre>
<p>This gives <span class="math inline">\(\texttt{mu}\)</span> a <span class="math inline">\(\text{Normal}(\alpha + \texttt{building_data}\, \zeta, \sigma_\mu)\)</span> distribution, but it decouples the dependence of the density of each element of <span class="math inline">\(\texttt{mu}\)</span> from <span class="math inline">\(\texttt{sigma_mu}\)</span> (<span class="math inline">\(\sigma_\mu\)</span>). <code>hier_NB_regression_ncp</code> uses the non-centered parameterization for <span class="math inline">\(\texttt{mu}\)</span>. We will examine the effective sample size of the fitted model to see whether we’ve fixed the problem with our reparameterization.</p>
<p>Compile the model.</p>
<div id="7ea859aa" class="cell" data-execution_count="61">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>hier_NB_regression_ncp <span class="op">=</span> <span class="st">'''</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a><span class="st">functions {</span></span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a><span class="st">    /*</span></span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a><span class="st">    * Alternative to neg_binomial_2_log_rng() that </span></span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a><span class="st">    * avoids potential numerical problems during warmup</span></span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a><span class="st">    */</span></span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a><span class="st">    int neg_binomial_2_log_safe_rng(real eta, real phi) {</span></span>
<span id="cb83-8"><a href="#cb83-8" aria-hidden="true" tabindex="-1"></a><span class="st">    real gamma_rate = gamma_rng(phi, phi / exp(eta));</span></span>
<span id="cb83-9"><a href="#cb83-9" aria-hidden="true" tabindex="-1"></a><span class="st">    if (gamma_rate &gt;= exp(20.79))</span></span>
<span id="cb83-10"><a href="#cb83-10" aria-hidden="true" tabindex="-1"></a><span class="st">      return -9;</span></span>
<span id="cb83-11"><a href="#cb83-11" aria-hidden="true" tabindex="-1"></a><span class="st">      </span></span>
<span id="cb83-12"><a href="#cb83-12" aria-hidden="true" tabindex="-1"></a><span class="st">    return poisson_rng(gamma_rate);</span></span>
<span id="cb83-13"><a href="#cb83-13" aria-hidden="true" tabindex="-1"></a><span class="st">    }</span></span>
<span id="cb83-14"><a href="#cb83-14" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb83-15"><a href="#cb83-15" aria-hidden="true" tabindex="-1"></a><span class="st">data {</span></span>
<span id="cb83-16"><a href="#cb83-16" aria-hidden="true" tabindex="-1"></a><span class="st">    int&lt;lower=1&gt; N;                     </span></span>
<span id="cb83-17"><a href="#cb83-17" aria-hidden="true" tabindex="-1"></a><span class="st">    array[N] int&lt;lower=0&gt; complaints;</span></span>
<span id="cb83-18"><a href="#cb83-18" aria-hidden="true" tabindex="-1"></a><span class="st">    vector&lt;lower=0&gt;[N] traps;</span></span>
<span id="cb83-19"><a href="#cb83-19" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb83-20"><a href="#cb83-20" aria-hidden="true" tabindex="-1"></a><span class="st">    // 'exposure'</span></span>
<span id="cb83-21"><a href="#cb83-21" aria-hidden="true" tabindex="-1"></a><span class="st">    vector[N] log_sq_foot;</span></span>
<span id="cb83-22"><a href="#cb83-22" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb83-23"><a href="#cb83-23" aria-hidden="true" tabindex="-1"></a><span class="st">    // building-level data</span></span>
<span id="cb83-24"><a href="#cb83-24" aria-hidden="true" tabindex="-1"></a><span class="st">    int&lt;lower=1&gt; K;</span></span>
<span id="cb83-25"><a href="#cb83-25" aria-hidden="true" tabindex="-1"></a><span class="st">    int&lt;lower=1&gt; J;</span></span>
<span id="cb83-26"><a href="#cb83-26" aria-hidden="true" tabindex="-1"></a><span class="st">    array[N] int&lt;lower=1, upper=J&gt; building_idx;</span></span>
<span id="cb83-27"><a href="#cb83-27" aria-hidden="true" tabindex="-1"></a><span class="st">    matrix[J,K] building_data;</span></span>
<span id="cb83-28"><a href="#cb83-28" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb83-29"><a href="#cb83-29" aria-hidden="true" tabindex="-1"></a><span class="st">parameters {</span></span>
<span id="cb83-30"><a href="#cb83-30" aria-hidden="true" tabindex="-1"></a><span class="st">    real&lt;lower=0&gt; inv_phi;   // 1/phi (easier to think about prior for 1/phi instead of phi)</span></span>
<span id="cb83-31"><a href="#cb83-31" aria-hidden="true" tabindex="-1"></a><span class="st">    real beta;               // coefficient on traps</span></span>
<span id="cb83-32"><a href="#cb83-32" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb83-33"><a href="#cb83-33" aria-hidden="true" tabindex="-1"></a><span class="st">    vector[J] mu_raw;        // N(0,1) params for non-centered parameterization of building intercepts </span></span>
<span id="cb83-34"><a href="#cb83-34" aria-hidden="true" tabindex="-1"></a><span class="st">    real&lt;lower=0&gt; sigma_mu;  // sd of building-specific intercepts</span></span>
<span id="cb83-35"><a href="#cb83-35" aria-hidden="true" tabindex="-1"></a><span class="st">    real alpha;              // intercept of model for mu</span></span>
<span id="cb83-36"><a href="#cb83-36" aria-hidden="true" tabindex="-1"></a><span class="st">    vector[K] zeta;          // coefficients on building-level predictors in model for mu </span></span>
<span id="cb83-37"><a href="#cb83-37" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb83-38"><a href="#cb83-38" aria-hidden="true" tabindex="-1"></a><span class="st">transformed parameters {</span></span>
<span id="cb83-39"><a href="#cb83-39" aria-hidden="true" tabindex="-1"></a><span class="st">    real phi = inv(inv_phi);</span></span>
<span id="cb83-40"><a href="#cb83-40" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb83-41"><a href="#cb83-41" aria-hidden="true" tabindex="-1"></a><span class="st">    // non-centered parameterization</span></span>
<span id="cb83-42"><a href="#cb83-42" aria-hidden="true" tabindex="-1"></a><span class="st">    vector[J] mu = alpha + building_data * zeta + sigma_mu * mu_raw;</span></span>
<span id="cb83-43"><a href="#cb83-43" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb83-44"><a href="#cb83-44" aria-hidden="true" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb83-45"><a href="#cb83-45" aria-hidden="true" tabindex="-1"></a><span class="st">    mu_raw ~ normal(0, 1);   // implies mu ~ normal(alpha + building_data * zeta, sigma_mu)</span></span>
<span id="cb83-46"><a href="#cb83-46" aria-hidden="true" tabindex="-1"></a><span class="st">    sigma_mu ~ normal(0, 1);</span></span>
<span id="cb83-47"><a href="#cb83-47" aria-hidden="true" tabindex="-1"></a><span class="st">    alpha ~ normal(log(4), 1);</span></span>
<span id="cb83-48"><a href="#cb83-48" aria-hidden="true" tabindex="-1"></a><span class="st">    zeta ~ normal(0, 1);</span></span>
<span id="cb83-49"><a href="#cb83-49" aria-hidden="true" tabindex="-1"></a><span class="st">    beta ~ normal(-0.25, 1);</span></span>
<span id="cb83-50"><a href="#cb83-50" aria-hidden="true" tabindex="-1"></a><span class="st">    inv_phi ~ normal(0, 1);</span></span>
<span id="cb83-51"><a href="#cb83-51" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb83-52"><a href="#cb83-52" aria-hidden="true" tabindex="-1"></a><span class="st">    complaints ~ neg_binomial_2_log(mu[building_idx] + beta * traps + log_sq_foot, phi);</span></span>
<span id="cb83-53"><a href="#cb83-53" aria-hidden="true" tabindex="-1"></a><span class="st">} </span></span>
<span id="cb83-54"><a href="#cb83-54" aria-hidden="true" tabindex="-1"></a><span class="st">generated quantities {</span></span>
<span id="cb83-55"><a href="#cb83-55" aria-hidden="true" tabindex="-1"></a><span class="st">    array[N] int y_rep;</span></span>
<span id="cb83-56"><a href="#cb83-56" aria-hidden="true" tabindex="-1"></a><span class="st">    for (n in 1:N) {</span></span>
<span id="cb83-57"><a href="#cb83-57" aria-hidden="true" tabindex="-1"></a><span class="st">        real eta_n = mu[building_idx[n]] + beta * traps[n] + log_sq_foot[n];</span></span>
<span id="cb83-58"><a href="#cb83-58" aria-hidden="true" tabindex="-1"></a><span class="st">        y_rep[n] = neg_binomial_2_log_safe_rng(eta_n, phi);</span></span>
<span id="cb83-59"><a href="#cb83-59" aria-hidden="true" tabindex="-1"></a><span class="st">    }</span></span>
<span id="cb83-60"><a href="#cb83-60" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb83-61"><a href="#cb83-61" aria-hidden="true" tabindex="-1"></a><span class="st">'''</span></span>
<span id="cb83-62"><a href="#cb83-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-63"><a href="#cb83-63" aria-hidden="true" tabindex="-1"></a>hier_NB_regression_ncp_model <span class="op">=</span> StanModel(<span class="st">'../stan_models/hier_NB_regression_ncp'</span>, hier_NB_regression_ncp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Fit the model to the data.</p>
<div id="f6b95f0f" class="cell" data-execution_count="62">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>fitted_model_NB_hier_ncp <span class="op">=</span> hier_NB_regression_ncp_model.sample(</span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>stan_dat_hier,</span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>    chains<span class="op">=</span><span class="dv">4</span>,</span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>    parallel_chains<span class="op">=</span><span class="dv">4</span>,</span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a>    adapt_delta<span class="op">=</span><span class="fl">0.95</span>,</span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a>    show_progress<span class="op">=</span><span class="va">False</span></span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a>az_samps_hier_NB_hier_ncp <span class="op">=</span> az.from_cmdstanpy(fitted_model_NB_hier_ncp, posterior_predictive<span class="op">=</span><span class="st">'y_rep'</span>, observed_data<span class="op">=</span>stan_dat_hier)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Examining the fit of the new model</p>
<div id="0e91d464" class="cell" data-execution_count="63">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(fitted_model_NB_hier_ncp.diagnose())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Checking sampler transitions treedepth.
Treedepth satisfactory for all transitions.

Checking sampler transitions for divergences.
No divergent transitions found.

Checking E-BFMI - sampler transitions HMC potential energy.
E-BFMI satisfactory.

Rank-normalized split effective sample size satisfactory for all parameters.

Rank-normalized split R-hat values satisfactory for all parameters.

Processing complete, no problems detected.
</code></pre>
</div>
</div>
<div id="eb6afadf" class="cell" data-execution_count="64">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>summary <span class="op">=</span> fitted_model_NB_hier.summary(percentiles<span class="op">=</span>(<span class="dv">5</span>, <span class="dv">95</span>)).<span class="bu">round</span>(<span class="dv">2</span>)</span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>summary[<span class="op">~</span>summary.index.<span class="bu">str</span>.contains(<span class="vs">r'^(y_rep|zeta)'</span>, regex<span class="op">=</span><span class="va">True</span>)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="64">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Mean</th>
<th data-quarto-table-cell-role="th">MCSE</th>
<th data-quarto-table-cell-role="th">StdDev</th>
<th data-quarto-table-cell-role="th">MAD</th>
<th data-quarto-table-cell-role="th">5%</th>
<th data-quarto-table-cell-role="th">95%</th>
<th data-quarto-table-cell-role="th">ESS_bulk</th>
<th data-quarto-table-cell-role="th">ESS_tail</th>
<th data-quarto-table-cell-role="th">R_hat</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">lp__</td>
<td>-268.53</td>
<td>0.34</td>
<td>6.59</td>
<td>6.51</td>
<td>-278.86</td>
<td>-257.28</td>
<td>404.61</td>
<td>172.60</td>
<td>1.01</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">inv_phi</td>
<td>0.66</td>
<td>0.00</td>
<td>0.14</td>
<td>0.14</td>
<td>0.45</td>
<td>0.91</td>
<td>1786.10</td>
<td>5755.14</td>
<td>1.00</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">beta</td>
<td>-0.23</td>
<td>0.00</td>
<td>0.06</td>
<td>0.06</td>
<td>-0.33</td>
<td>-0.13</td>
<td>1208.69</td>
<td>2685.52</td>
<td>1.01</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">mu[1]</td>
<td>1.27</td>
<td>0.01</td>
<td>0.54</td>
<td>0.51</td>
<td>0.39</td>
<td>2.16</td>
<td>1394.05</td>
<td>3469.98</td>
<td>1.01</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">mu[2]</td>
<td>1.22</td>
<td>0.01</td>
<td>0.51</td>
<td>0.50</td>
<td>0.39</td>
<td>2.07</td>
<td>1477.69</td>
<td>3956.30</td>
<td>1.00</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">mu[3]</td>
<td>1.39</td>
<td>0.02</td>
<td>0.48</td>
<td>0.47</td>
<td>0.61</td>
<td>2.20</td>
<td>958.95</td>
<td>2043.49</td>
<td>1.01</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">mu[4]</td>
<td>1.43</td>
<td>0.01</td>
<td>0.47</td>
<td>0.46</td>
<td>0.67</td>
<td>2.22</td>
<td>1726.18</td>
<td>3803.09</td>
<td>1.01</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">mu[5]</td>
<td>1.07</td>
<td>0.01</td>
<td>0.42</td>
<td>0.41</td>
<td>0.40</td>
<td>1.75</td>
<td>1171.63</td>
<td>4564.63</td>
<td>1.01</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">mu[6]</td>
<td>1.16</td>
<td>0.01</td>
<td>0.47</td>
<td>0.46</td>
<td>0.37</td>
<td>1.92</td>
<td>1040.17</td>
<td>2432.11</td>
<td>1.01</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">mu[7]</td>
<td>1.45</td>
<td>0.01</td>
<td>0.50</td>
<td>0.48</td>
<td>0.61</td>
<td>2.28</td>
<td>1504.63</td>
<td>2175.90</td>
<td>1.00</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">mu[8]</td>
<td>1.23</td>
<td>0.02</td>
<td>0.44</td>
<td>0.44</td>
<td>0.49</td>
<td>1.93</td>
<td>536.04</td>
<td>193.35</td>
<td>1.01</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">mu[9]</td>
<td>1.40</td>
<td>0.02</td>
<td>0.56</td>
<td>0.55</td>
<td>0.48</td>
<td>2.30</td>
<td>876.97</td>
<td>4529.49</td>
<td>1.01</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">mu[10]</td>
<td>0.86</td>
<td>0.01</td>
<td>0.36</td>
<td>0.36</td>
<td>0.29</td>
<td>1.45</td>
<td>1557.41</td>
<td>4753.73</td>
<td>1.00</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">sigma_mu</td>
<td>0.24</td>
<td>0.01</td>
<td>0.17</td>
<td>0.15</td>
<td>0.05</td>
<td>0.57</td>
<td>339.97</td>
<td>6005.71</td>
<td>1.02</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">alpha</td>
<td>1.25</td>
<td>0.01</td>
<td>0.42</td>
<td>0.41</td>
<td>0.56</td>
<td>1.94</td>
<td>1133.95</td>
<td>2264.72</td>
<td>1.01</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">phi</td>
<td>1.59</td>
<td>0.01</td>
<td>0.35</td>
<td>0.34</td>
<td>1.10</td>
<td>2.22</td>
<td>1786.10</td>
<td>5755.14</td>
<td>1.00</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>This has improved the effective sample sizes of <span class="math inline">\(\texttt{mu}\)</span>. We extract the parameters to run our usual posterior predictive checks.</p>
<div id="2618105b" class="cell" data-execution_count="65">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>plot_mu <span class="op">=</span> az_samps_hier_NB_hier_ncp.posterior.mu.sel(mu_dim_0<span class="op">=</span><span class="dv">3</span>).to_numpy().flatten()</span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>plot_sigma_mu <span class="op">=</span> np.log(az_samps_hier_NB_hier_ncp.posterior.sigma_mu.to_numpy().flatten())</span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a>divergent_filter <span class="op">=</span> az_samps_hier_NB_hier_ncp.sample_stats.diverging.to_numpy().flatten()</span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a>plt.clf()</span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a>_, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb88-7"><a href="#cb88-7" aria-hidden="true" tabindex="-1"></a>sns.scatterplot(x<span class="op">=</span>plot_mu, y<span class="op">=</span>plot_sigma_mu, alpha<span class="op">=</span><span class="fl">0.2</span>, ax<span class="op">=</span>ax)</span>
<span id="cb88-8"><a href="#cb88-8" aria-hidden="true" tabindex="-1"></a>sns.scatterplot(x<span class="op">=</span>plot_mu[divergent_filter], y<span class="op">=</span>plot_sigma_mu[divergent_filter], color<span class="op">=</span><span class="st">'r'</span>, alpha<span class="op">=</span><span class="fl">0.5</span>, ax<span class="op">=</span>ax)</span>
<span id="cb88-9"><a href="#cb88-9" aria-hidden="true" tabindex="-1"></a>ax.<span class="bu">set</span>(xlabel<span class="op">=</span><span class="st">'mu[4]'</span>, ylabel<span class="op">=</span><span class="st">'log(sigma_mu)'</span>)</span>
<span id="cb88-10"><a href="#cb88-10" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb88-11"><a href="#cb88-11" aria-hidden="true" tabindex="-1"></a>plt.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<pre><code>&lt;Figure size 500x400 with 0 Axes&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Pest%20Control%20Example_files/figure-html/cell-66-output-2.png" width="511" height="411" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="34c1bdf6" class="cell" data-execution_count="66">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>plt.clf()</span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>az.plot_parallel(az_samps_hier_NB_hier_ncp, </span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a>                 var_names<span class="op">=</span>[<span class="st">'sigma_mu'</span>, <span class="st">'mu'</span>])</span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a>plt.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<pre><code>&lt;Figure size 500x400 with 0 Axes&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Pest%20Control%20Example_files/figure-html/cell-67-output-2.png" width="511" height="411" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="0f965fac" class="cell" data-execution_count="67">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>y_rep <span class="op">=</span> az_samps_hier_NB_hier_ncp.posterior_predictive.y_rep</span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a>plt.clf()</span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">200</span>):</span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a>    sns.kdeplot(y_rep.sel(chain<span class="op">=</span><span class="bu">slice</span>(<span class="dv">0</span>), draw<span class="op">=</span>i).to_dataframe(), x<span class="op">=</span><span class="st">'y_rep'</span>, color<span class="op">=</span><span class="st">'k'</span>, alpha<span class="op">=</span><span class="fl">0.2</span>)</span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a>sns.kdeplot(stan_dat_hier[<span class="st">'complaints'</span>], color<span class="op">=</span><span class="st">'r'</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb92-7"><a href="#cb92-7" aria-hidden="true" tabindex="-1"></a>plt.xlim(<span class="dv">0</span>,)</span>
<span id="cb92-8"><a href="#cb92-8" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb92-9"><a href="#cb92-9" aria-hidden="true" tabindex="-1"></a>plt.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Pest%20Control%20Example_files/figure-html/cell-68-output-1.png" width="511" height="411" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>This looks quite nice. If we’ve captured the building-level means well, then the posterior distribution of means by building should match well with the observed means of the quantity of building complaints by month.</p>
<div id="c3507bc2" class="cell" data-execution_count="68">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>plt.clf()</span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a>grouped_indices <span class="op">=</span> defaultdict(<span class="bu">list</span>)</span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> idx, building_id <span class="kw">in</span> <span class="bu">enumerate</span>(pest_data[<span class="st">'building_id'</span>]):</span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a>    grouped_indices[building_id].append(idx)</span>
<span id="cb93-6"><a href="#cb93-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-7"><a href="#cb93-7" aria-hidden="true" tabindex="-1"></a>grouped_array <span class="op">=</span> {bldg_id: y_rep[:, :, idx_list].mean(axis<span class="op">=</span><span class="dv">2</span>).to_numpy().flatten() <span class="cf">for</span> bldg_id, idx_list <span class="kw">in</span> grouped_indices.items()}</span>
<span id="cb93-8"><a href="#cb93-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-9"><a href="#cb93-9" aria-hidden="true" tabindex="-1"></a>_, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">5</span>, figsize<span class="op">=</span>(<span class="dv">7</span>,<span class="dv">4</span>))</span>
<span id="cb93-10"><a href="#cb93-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-11"><a href="#cb93-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ax, key <span class="kw">in</span> <span class="bu">zip</span>(axes.flat, <span class="bu">sorted</span>(grouped_array.keys())):</span>
<span id="cb93-12"><a href="#cb93-12" aria-hidden="true" tabindex="-1"></a>    sns.histplot(grouped_array[key], bins<span class="op">=</span><span class="dv">30</span>, ax<span class="op">=</span>ax)</span>
<span id="cb93-13"><a href="#cb93-13" aria-hidden="true" tabindex="-1"></a>    ax.axvline(pest_data[pest_data[<span class="st">'building_id'</span>]<span class="op">==</span>key].complaints.mean(), color<span class="op">=</span><span class="st">'r'</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb93-14"><a href="#cb93-14" aria-hidden="true" tabindex="-1"></a>    ax.xaxis.set_major_locator(mticker.MaxNLocator(nbins<span class="op">=</span><span class="dv">4</span>))</span>
<span id="cb93-15"><a href="#cb93-15" aria-hidden="true" tabindex="-1"></a>    ax.<span class="bu">set</span>(ylabel<span class="op">=</span><span class="st">''</span>, title<span class="op">=</span><span class="ss">f"Bulding = </span><span class="sc">{</span>key<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb93-16"><a href="#cb93-16" aria-hidden="true" tabindex="-1"></a>    ax.yaxis.set_ticks([])</span>
<span id="cb93-17"><a href="#cb93-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-18"><a href="#cb93-18" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb93-19"><a href="#cb93-19" aria-hidden="true" tabindex="-1"></a>plt.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<pre><code>&lt;Figure size 500x400 with 0 Axes&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Pest%20Control%20Example_files/figure-html/cell-69-output-2.png" width="711" height="411" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>We weren’t doing terribly with the building-specific means before, but now they are all well-captured by our model. The model is also able to do a decent job estimating within-building variability:</p>
<div id="07382c41" class="cell" data-execution_count="69">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>plt.clf()</span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a>grouped_indices <span class="op">=</span> defaultdict(<span class="bu">list</span>)</span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> idx, building_id <span class="kw">in</span> <span class="bu">enumerate</span>(pest_data[<span class="st">'building_id'</span>]):</span>
<span id="cb95-5"><a href="#cb95-5" aria-hidden="true" tabindex="-1"></a>    grouped_indices[building_id].append(idx)</span>
<span id="cb95-6"><a href="#cb95-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-7"><a href="#cb95-7" aria-hidden="true" tabindex="-1"></a>grouped_array <span class="op">=</span> {bldg_id: y_rep[:, :, idx_list].std(axis<span class="op">=</span><span class="dv">2</span>).to_numpy().flatten() <span class="cf">for</span> bldg_id, idx_list <span class="kw">in</span> grouped_indices.items()}</span>
<span id="cb95-8"><a href="#cb95-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-9"><a href="#cb95-9" aria-hidden="true" tabindex="-1"></a>_, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">5</span>, figsize<span class="op">=</span>(<span class="dv">7</span>,<span class="dv">4</span>))</span>
<span id="cb95-10"><a href="#cb95-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-11"><a href="#cb95-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ax, key <span class="kw">in</span> <span class="bu">zip</span>(axes.flat, <span class="bu">sorted</span>(grouped_array.keys())):</span>
<span id="cb95-12"><a href="#cb95-12" aria-hidden="true" tabindex="-1"></a>    sns.histplot(grouped_array[key], bins<span class="op">=</span><span class="dv">30</span>, ax<span class="op">=</span>ax)</span>
<span id="cb95-13"><a href="#cb95-13" aria-hidden="true" tabindex="-1"></a>    ax.axvline(pest_data[pest_data[<span class="st">'building_id'</span>]<span class="op">==</span>key].complaints.std(), color<span class="op">=</span><span class="st">'r'</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb95-14"><a href="#cb95-14" aria-hidden="true" tabindex="-1"></a>    ax.xaxis.set_major_locator(mticker.MaxNLocator(nbins<span class="op">=</span><span class="dv">4</span>))</span>
<span id="cb95-15"><a href="#cb95-15" aria-hidden="true" tabindex="-1"></a>    ax.<span class="bu">set</span>(ylabel<span class="op">=</span><span class="st">''</span>, title<span class="op">=</span><span class="ss">f"Bulding = </span><span class="sc">{</span>key<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb95-16"><a href="#cb95-16" aria-hidden="true" tabindex="-1"></a>    ax.yaxis.set_ticks([])</span>
<span id="cb95-17"><a href="#cb95-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-18"><a href="#cb95-18" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb95-19"><a href="#cb95-19" aria-hidden="true" tabindex="-1"></a>plt.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<pre><code>&lt;Figure size 500x400 with 0 Axes&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Pest%20Control%20Example_files/figure-html/cell-70-output-2.png" width="711" height="411" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Predictions by number of traps:</p>
<div id="a74d9664" class="cell" data-execution_count="70">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>plt.clf()</span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>_, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a>ax.plot(stan_dat_hier[<span class="st">'traps'</span>], stan_dat_hier[<span class="st">'complaints'</span>], <span class="st">'o'</span>, fillstyle<span class="op">=</span><span class="st">'none'</span>)</span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-6"><a href="#cb97-6" aria-hidden="true" tabindex="-1"></a>grouped_indices <span class="op">=</span> defaultdict(<span class="bu">list</span>)</span>
<span id="cb97-7"><a href="#cb97-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> idx, trap <span class="kw">in</span> <span class="bu">enumerate</span>(stan_dat_hier[<span class="st">'traps'</span>]):</span>
<span id="cb97-8"><a href="#cb97-8" aria-hidden="true" tabindex="-1"></a>    grouped_indices[trap].append(idx)</span>
<span id="cb97-9"><a href="#cb97-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-10"><a href="#cb97-10" aria-hidden="true" tabindex="-1"></a>grouped_array <span class="op">=</span> {trap: y_rep[:, :, idx_list].to_numpy().flatten() <span class="cf">for</span> trap, idx_list <span class="kw">in</span> grouped_indices.items()}</span>
<span id="cb97-11"><a href="#cb97-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-12"><a href="#cb97-12" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> traps_x, complaints_y <span class="kw">in</span> grouped_array.items():</span>
<span id="cb97-13"><a href="#cb97-13" aria-hidden="true" tabindex="-1"></a>    inner_prob <span class="op">=</span> np.array([np.quantile(complaints_y, <span class="fl">0.75</span>), np.quantile(complaints_y, <span class="fl">0.25</span>)])</span>
<span id="cb97-14"><a href="#cb97-14" aria-hidden="true" tabindex="-1"></a>    outer_prob <span class="op">=</span> np.array([np.quantile(complaints_y, <span class="fl">0.95</span>), np.quantile(complaints_y, <span class="fl">0.05</span>)])</span>
<span id="cb97-15"><a href="#cb97-15" aria-hidden="true" tabindex="-1"></a>    ax.plot(np.full(inner_prob.shape, traps_x), inner_prob, <span class="st">'k'</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb97-16"><a href="#cb97-16" aria-hidden="true" tabindex="-1"></a>    ax.plot(np.full(outer_prob.shape, traps_x), outer_prob, <span class="st">'k'</span>, linewidth<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb97-17"><a href="#cb97-17" aria-hidden="true" tabindex="-1"></a>    ax.plot(traps_x, np.mean(complaints_y), <span class="st">'ko'</span>)</span>
<span id="cb97-18"><a href="#cb97-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-19"><a href="#cb97-19" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb97-20"><a href="#cb97-20" aria-hidden="true" tabindex="-1"></a>plt.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<pre><code>&lt;Figure size 500x400 with 0 Axes&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Pest%20Control%20Example_files/figure-html/cell-71-output-2.png" width="511" height="411" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Standardized residuals:</p>
<div id="e09eee00" class="cell" data-execution_count="71">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a>mean_inv_phi <span class="op">=</span> az_samps_hier_NB_hier_ncp.posterior.inv_phi.mean(dim<span class="op">=</span>[<span class="st">'chain'</span>, <span class="st">'draw'</span>])</span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>mean_y_rep <span class="op">=</span> y_rep.mean(dim<span class="op">=</span>[<span class="st">'chain'</span>, <span class="st">'draw'</span>])</span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a>std_resid <span class="op">=</span> (stan_dat_hier[<span class="st">'complaints'</span>] <span class="op">-</span> mean_y_rep) <span class="op">/</span> np.sqrt(mean_y_rep <span class="op">+</span> mean_y_rep<span class="op">**</span><span class="dv">2</span> <span class="op">*</span> mean_inv_phi)</span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-5"><a href="#cb99-5" aria-hidden="true" tabindex="-1"></a>plt.clf()</span>
<span id="cb99-6"><a href="#cb99-6" aria-hidden="true" tabindex="-1"></a>plt.plot(mean_y_rep, std_resid, <span class="st">'o'</span>, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb99-7"><a href="#cb99-7" aria-hidden="true" tabindex="-1"></a>plt.axhline(<span class="dv">2</span>, linestyle<span class="op">=</span><span class="st">'--'</span>)</span>
<span id="cb99-8"><a href="#cb99-8" aria-hidden="true" tabindex="-1"></a>plt.axhline(<span class="op">-</span><span class="dv">2</span>, linestyle<span class="op">=</span><span class="st">'--'</span>)</span>
<span id="cb99-9"><a href="#cb99-9" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'mean_y_rep'</span>)</span>
<span id="cb99-10"><a href="#cb99-10" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'std_resid'</span>)</span>
<span id="cb99-11"><a href="#cb99-11" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb99-12"><a href="#cb99-12" aria-hidden="true" tabindex="-1"></a>plt.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Pest%20Control%20Example_files/figure-html/cell-72-output-1.png" width="511" height="411" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Rootogram:</p>
<div id="c9512568" class="cell" data-execution_count="72">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>plt.clf()</span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a>vals, counts <span class="op">=</span> np.unique(y_rep, return_counts<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a>hist_range <span class="op">=</span> (<span class="bu">min</span>(vals), <span class="bu">max</span>(vals))</span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a>az.plot_dist(stan_dat_hier[<span class="st">'complaints'</span>], kind<span class="op">=</span><span class="st">'hist'</span>, ax<span class="op">=</span>ax, </span>
<span id="cb100-6"><a href="#cb100-6" aria-hidden="true" tabindex="-1"></a>             hist_kwargs<span class="op">=</span>{<span class="st">'bins'</span>: np.arange(hist_range[<span class="dv">0</span>], hist_range[<span class="dv">1</span>] <span class="op">+</span> <span class="dv">1</span>, <span class="dv">1</span>), <span class="st">'range'</span>: hist_range})</span>
<span id="cb100-7"><a href="#cb100-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-8"><a href="#cb100-8" aria-hidden="true" tabindex="-1"></a>secax <span class="op">=</span> ax.twinx()</span>
<span id="cb100-9"><a href="#cb100-9" aria-hidden="true" tabindex="-1"></a>secax.plot(vals, counts, color<span class="op">=</span><span class="st">'red'</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb100-10"><a href="#cb100-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-11"><a href="#cb100-11" aria-hidden="true" tabindex="-1"></a>ax.set_xlim(hist_range[<span class="dv">0</span>]<span class="op">-</span><span class="fl">0.5</span>, hist_range[<span class="dv">1</span>]<span class="op">+</span><span class="fl">0.5</span>)</span>
<span id="cb100-12"><a href="#cb100-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-13"><a href="#cb100-13" aria-hidden="true" tabindex="-1"></a>secax.set_yticklabels([])</span>
<span id="cb100-14"><a href="#cb100-14" aria-hidden="true" tabindex="-1"></a>secax.yaxis.set_ticks([])</span>
<span id="cb100-15"><a href="#cb100-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-16"><a href="#cb100-16" aria-hidden="true" tabindex="-1"></a>ax.xaxis.set_major_locator(mticker.MaxNLocator(nbins<span class="op">=</span><span class="dv">5</span>))</span>
<span id="cb100-17"><a href="#cb100-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-18"><a href="#cb100-18" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb100-19"><a href="#cb100-19" aria-hidden="true" tabindex="-1"></a>plt.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<pre><code>&lt;Figure size 500x400 with 0 Axes&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Pest%20Control%20Example_files/figure-html/cell-73-output-2.png" width="511" height="411" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="varying-intercepts-and-varying-slopes" class="level3">
<h3 class="anchored" data-anchor-id="varying-intercepts-and-varying-slopes">Varying intercepts <em>and</em> varying slopes</h3>
<p>We’ve gotten some new data that extends the number of time points for which we have observations for each building. This will let us explore how to expand the model a bit more with varying <em>slopes</em> in addition to the varying intercepts and also, later, also model temporal variation.</p>
<div id="fbf101ef" class="cell" data-execution_count="73">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> rdata</span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>stan_dat_hier <span class="op">=</span> rdata.read_rds(<span class="st">'data/pest_data_longer_stan_dat.RDS'</span>)</span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a>stan_dat_hier[<span class="st">'N'</span>] <span class="op">=</span> stan_dat_hier[<span class="st">'N'</span>][<span class="dv">0</span>].astype(<span class="bu">int</span>)</span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a>stan_dat_hier[<span class="st">'J'</span>] <span class="op">=</span> stan_dat_hier[<span class="st">'J'</span>][<span class="dv">0</span>].astype(<span class="bu">int</span>)</span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a>stan_dat_hier[<span class="st">'K'</span>] <span class="op">=</span> stan_dat_hier[<span class="st">'K'</span>][<span class="dv">0</span>].astype(<span class="bu">int</span>)</span>
<span id="cb102-6"><a href="#cb102-6" aria-hidden="true" tabindex="-1"></a>stan_dat_hier[<span class="st">'M'</span>] <span class="op">=</span> stan_dat_hier[<span class="st">'M'</span>][<span class="dv">0</span>].astype(<span class="bu">int</span>)</span>
<span id="cb102-7"><a href="#cb102-7" aria-hidden="true" tabindex="-1"></a>stan_dat_hier[<span class="st">'M_forward'</span>] <span class="op">=</span> stan_dat_hier[<span class="st">'M_forward'</span>][<span class="dv">0</span>].astype(<span class="bu">int</span>)</span>
<span id="cb102-8"><a href="#cb102-8" aria-hidden="true" tabindex="-1"></a>stan_dat_hier[<span class="st">'complaints'</span>] <span class="op">=</span> stan_dat_hier[<span class="st">'complaints'</span>].astype(<span class="bu">int</span>)</span>
<span id="cb102-9"><a href="#cb102-9" aria-hidden="true" tabindex="-1"></a>stan_dat_hier[<span class="st">'building_idx'</span>] <span class="op">=</span> stan_dat_hier[<span class="st">'building_idx'</span>].astype(<span class="bu">int</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Perhaps if the levels of complaints differ by building, the coefficient for the effect of traps on building does too. We can add this to our model and observe the fit.</p>
<p><span class="math display">\[
\begin{align*}
\text{complaints}_{b,t} &amp;\sim \text{Neg-Binomial}(\lambda_{b,t}, \phi)  \\
\lambda_{b,t} &amp;= \exp{(\eta_{b,t})}\\
\eta_{b,t} &amp;= \mu_b + \kappa_b \, \texttt{traps}_{b,t} + \text{log_sq_foot}_b \\
\mu_b &amp;\sim \text{Normal}(\alpha + \texttt{building_data} \, \zeta, \sigma_{\mu}) \\
\kappa_b &amp;\sim \text{Normal}(\beta + \texttt{building_data} \, \gamma, \sigma_{\kappa})
\end{align*}
\]</span></p>
<p>Let’s compile the model.</p>
<div id="d4890657" class="cell" data-execution_count="74">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>hier_NB_regression_ncp_slopes_mod <span class="op">=</span> <span class="st">'''</span></span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a><span class="st">functions {</span></span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a><span class="st">  /*</span></span>
<span id="cb103-4"><a href="#cb103-4" aria-hidden="true" tabindex="-1"></a><span class="st">  * Alternative to neg_binomial_2_log_rng() that </span></span>
<span id="cb103-5"><a href="#cb103-5" aria-hidden="true" tabindex="-1"></a><span class="st">  * avoids potential numerical problems during warmup</span></span>
<span id="cb103-6"><a href="#cb103-6" aria-hidden="true" tabindex="-1"></a><span class="st">  */</span></span>
<span id="cb103-7"><a href="#cb103-7" aria-hidden="true" tabindex="-1"></a><span class="st">  int neg_binomial_2_log_safe_rng(real eta, real phi) {</span></span>
<span id="cb103-8"><a href="#cb103-8" aria-hidden="true" tabindex="-1"></a><span class="st">    real gamma_rate = gamma_rng(phi, phi / exp(eta));</span></span>
<span id="cb103-9"><a href="#cb103-9" aria-hidden="true" tabindex="-1"></a><span class="st">    if (gamma_rate &gt;= exp(20.79))</span></span>
<span id="cb103-10"><a href="#cb103-10" aria-hidden="true" tabindex="-1"></a><span class="st">      return -9;</span></span>
<span id="cb103-11"><a href="#cb103-11" aria-hidden="true" tabindex="-1"></a><span class="st">      </span></span>
<span id="cb103-12"><a href="#cb103-12" aria-hidden="true" tabindex="-1"></a><span class="st">    return poisson_rng(gamma_rate);</span></span>
<span id="cb103-13"><a href="#cb103-13" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb103-14"><a href="#cb103-14" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb103-15"><a href="#cb103-15" aria-hidden="true" tabindex="-1"></a><span class="st">data {</span></span>
<span id="cb103-16"><a href="#cb103-16" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; N;                     </span></span>
<span id="cb103-17"><a href="#cb103-17" aria-hidden="true" tabindex="-1"></a><span class="st">  array[N] int&lt;lower=0&gt; complaints;</span></span>
<span id="cb103-18"><a href="#cb103-18" aria-hidden="true" tabindex="-1"></a><span class="st">  vector&lt;lower=0&gt;[N] traps;        </span></span>
<span id="cb103-19"><a href="#cb103-19" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb103-20"><a href="#cb103-20" aria-hidden="true" tabindex="-1"></a><span class="st">  // 'exposure'</span></span>
<span id="cb103-21"><a href="#cb103-21" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N] log_sq_foot;  </span></span>
<span id="cb103-22"><a href="#cb103-22" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb103-23"><a href="#cb103-23" aria-hidden="true" tabindex="-1"></a><span class="st">  // building-level data</span></span>
<span id="cb103-24"><a href="#cb103-24" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; K;</span></span>
<span id="cb103-25"><a href="#cb103-25" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; J;</span></span>
<span id="cb103-26"><a href="#cb103-26" aria-hidden="true" tabindex="-1"></a><span class="st">  array[N] int&lt;lower=1, upper=J&gt; building_idx;</span></span>
<span id="cb103-27"><a href="#cb103-27" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[J,K] building_data;</span></span>
<span id="cb103-28"><a href="#cb103-28" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb103-29"><a href="#cb103-29" aria-hidden="true" tabindex="-1"></a><span class="st">parameters {</span></span>
<span id="cb103-30"><a href="#cb103-30" aria-hidden="true" tabindex="-1"></a><span class="st">  real&lt;lower=0&gt; inv_phi;     // 1/phi (easier to think about prior for 1/phi instead of phi)</span></span>
<span id="cb103-31"><a href="#cb103-31" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb103-32"><a href="#cb103-32" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[J] mu_raw;        // N(0,1) params for non-centered param of building-specific intercepts</span></span>
<span id="cb103-33"><a href="#cb103-33" aria-hidden="true" tabindex="-1"></a><span class="st">  real&lt;lower=0&gt; sigma_mu;  // sd of buildings-specific intercepts</span></span>
<span id="cb103-34"><a href="#cb103-34" aria-hidden="true" tabindex="-1"></a><span class="st">  real alpha;              // 'global' intercept</span></span>
<span id="cb103-35"><a href="#cb103-35" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[K] zeta;          // coefficients on building-level predictors in model for mu</span></span>
<span id="cb103-36"><a href="#cb103-36" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb103-37"><a href="#cb103-37" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[J] kappa_raw;       // N(0,1) params for non-centered param of building-specific slopes</span></span>
<span id="cb103-38"><a href="#cb103-38" aria-hidden="true" tabindex="-1"></a><span class="st">  real&lt;lower=0&gt; sigma_kappa; // sd of buildings-specific slopes</span></span>
<span id="cb103-39"><a href="#cb103-39" aria-hidden="true" tabindex="-1"></a><span class="st">  real beta;                 // 'global' slope on traps variable</span></span>
<span id="cb103-40"><a href="#cb103-40" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[K] gamma;           // coefficients on building-level predictors in model for kappa</span></span>
<span id="cb103-41"><a href="#cb103-41" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb103-42"><a href="#cb103-42" aria-hidden="true" tabindex="-1"></a><span class="st">transformed parameters {</span></span>
<span id="cb103-43"><a href="#cb103-43" aria-hidden="true" tabindex="-1"></a><span class="st">  real phi = inv(inv_phi);</span></span>
<span id="cb103-44"><a href="#cb103-44" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb103-45"><a href="#cb103-45" aria-hidden="true" tabindex="-1"></a><span class="st">  // non-centered parameterization of building-specific intercepts and slopes</span></span>
<span id="cb103-46"><a href="#cb103-46" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[J] mu = alpha + building_data * zeta + sigma_mu * mu_raw;</span></span>
<span id="cb103-47"><a href="#cb103-47" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[J] kappa = beta + building_data * gamma + sigma_kappa * kappa_raw;</span></span>
<span id="cb103-48"><a href="#cb103-48" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb103-49"><a href="#cb103-49" aria-hidden="true" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb103-50"><a href="#cb103-50" aria-hidden="true" tabindex="-1"></a><span class="st">  inv_phi ~ normal(0, 1);</span></span>
<span id="cb103-51"><a href="#cb103-51" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb103-52"><a href="#cb103-52" aria-hidden="true" tabindex="-1"></a><span class="st">  kappa_raw ~ normal(0,1) ;</span></span>
<span id="cb103-53"><a href="#cb103-53" aria-hidden="true" tabindex="-1"></a><span class="st">  sigma_kappa ~ normal(0, 1);</span></span>
<span id="cb103-54"><a href="#cb103-54" aria-hidden="true" tabindex="-1"></a><span class="st">  beta ~ normal(-0.25, 1);</span></span>
<span id="cb103-55"><a href="#cb103-55" aria-hidden="true" tabindex="-1"></a><span class="st">  gamma ~ normal(0, 1);</span></span>
<span id="cb103-56"><a href="#cb103-56" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb103-57"><a href="#cb103-57" aria-hidden="true" tabindex="-1"></a><span class="st">  mu_raw ~ normal(0,1) ;</span></span>
<span id="cb103-58"><a href="#cb103-58" aria-hidden="true" tabindex="-1"></a><span class="st">  sigma_mu ~ normal(0, 1);</span></span>
<span id="cb103-59"><a href="#cb103-59" aria-hidden="true" tabindex="-1"></a><span class="st">  alpha ~ normal(log(4), 1);</span></span>
<span id="cb103-60"><a href="#cb103-60" aria-hidden="true" tabindex="-1"></a><span class="st">  zeta ~ normal(0, 1);</span></span>
<span id="cb103-61"><a href="#cb103-61" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb103-62"><a href="#cb103-62" aria-hidden="true" tabindex="-1"></a><span class="st">  complaints ~ neg_binomial_2_log(mu[building_idx] + kappa[building_idx] .* traps  + log_sq_foot,</span></span>
<span id="cb103-63"><a href="#cb103-63" aria-hidden="true" tabindex="-1"></a><span class="st">                                  phi);</span></span>
<span id="cb103-64"><a href="#cb103-64" aria-hidden="true" tabindex="-1"></a><span class="st">} </span></span>
<span id="cb103-65"><a href="#cb103-65" aria-hidden="true" tabindex="-1"></a><span class="st">generated quantities {</span></span>
<span id="cb103-66"><a href="#cb103-66" aria-hidden="true" tabindex="-1"></a><span class="st">  array[N] int y_rep;</span></span>
<span id="cb103-67"><a href="#cb103-67" aria-hidden="true" tabindex="-1"></a><span class="st">  for (n in 1:N) {</span></span>
<span id="cb103-68"><a href="#cb103-68" aria-hidden="true" tabindex="-1"></a><span class="st">    real eta_n = mu[building_idx[n]] + kappa[building_idx[n]] * traps[n] + log_sq_foot[n];</span></span>
<span id="cb103-69"><a href="#cb103-69" aria-hidden="true" tabindex="-1"></a><span class="st">    y_rep[n] = neg_binomial_2_log_safe_rng(eta_n, phi);</span></span>
<span id="cb103-70"><a href="#cb103-70" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb103-71"><a href="#cb103-71" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb103-72"><a href="#cb103-72" aria-hidden="true" tabindex="-1"></a><span class="st">'''</span></span>
<span id="cb103-73"><a href="#cb103-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-74"><a href="#cb103-74" aria-hidden="true" tabindex="-1"></a>hier_NB_regression_ncp_slopes_mod_model <span class="op">=</span> StanModel(<span class="st">'../stan_models/hier_NB_regression_ncp_slopes_mod'</span>, hier_NB_regression_ncp_slopes_mod)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Fit the model to data and extract the posterior draws needed for our posterior predictive checks.</p>
<div id="bf786fbf" class="cell" data-execution_count="75">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>keys_to_remove <span class="op">=</span> {<span class="st">'pred_mat'</span>, <span class="st">'log_sq_foot_pred'</span>, <span class="st">'M_forward'</span>, <span class="st">'M'</span>}</span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a>filtered_stan_dat_hier <span class="op">=</span> {k: v <span class="cf">for</span> k, v <span class="kw">in</span> stan_dat_hier.items() <span class="cf">if</span> k <span class="kw">not</span> <span class="kw">in</span> keys_to_remove}</span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a>fitted_model_NB_hier_slopes <span class="op">=</span> hier_NB_regression_ncp_slopes_mod_model.sample(</span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>filtered_stan_dat_hier,</span>
<span id="cb104-6"><a href="#cb104-6" aria-hidden="true" tabindex="-1"></a>    chains<span class="op">=</span><span class="dv">4</span>,</span>
<span id="cb104-7"><a href="#cb104-7" aria-hidden="true" tabindex="-1"></a>    parallel_chains<span class="op">=</span><span class="dv">4</span>,</span>
<span id="cb104-8"><a href="#cb104-8" aria-hidden="true" tabindex="-1"></a>    adapt_delta<span class="op">=</span><span class="fl">0.95</span>,</span>
<span id="cb104-9"><a href="#cb104-9" aria-hidden="true" tabindex="-1"></a>    show_progress<span class="op">=</span><span class="va">False</span></span>
<span id="cb104-10"><a href="#cb104-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb104-11"><a href="#cb104-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-12"><a href="#cb104-12" aria-hidden="true" tabindex="-1"></a>az_samps_NB_hier_slopes <span class="op">=</span> az.from_cmdstanpy(fitted_model_NB_hier_slopes, posterior_predictive<span class="op">=</span><span class="st">'y_rep'</span>, observed_data<span class="op">=</span>filtered_stan_dat_hier)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>To see if the model infers building-to-building differences in, we can plot a histogram of our marginal posterior distribution for <code>sigma_kappa</code>.</p>
<div id="823547d5" class="cell" data-execution_count="76">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a>plt.clf()</span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a>sns.histplot(az_samps_NB_hier_slopes.posterior.sigma_kappa.to_numpy().flatten(), binwidth<span class="op">=</span><span class="fl">0.005</span>)</span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb105-6"><a href="#cb105-6" aria-hidden="true" tabindex="-1"></a>plt.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Pest%20Control%20Example_files/figure-html/cell-77-output-1.png" width="511" height="411" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="48402ead" class="cell" data-execution_count="77">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a>summary <span class="op">=</span> fitted_model_NB_hier_slopes.summary(percentiles<span class="op">=</span>(<span class="dv">5</span>, <span class="dv">95</span>)).<span class="bu">round</span>(<span class="dv">2</span>)</span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a>filter_indices <span class="op">=</span> <span class="vs">r'^(kappa(\[\d+\])?|beta|alpha|phi|sigma_mu|sigma_kappa|mu(\[\d+\])?)$'</span></span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a>summary[summary.index.<span class="bu">str</span>.match(filter_indices, na<span class="op">=</span><span class="va">False</span>)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="77">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Mean</th>
<th data-quarto-table-cell-role="th">MCSE</th>
<th data-quarto-table-cell-role="th">StdDev</th>
<th data-quarto-table-cell-role="th">MAD</th>
<th data-quarto-table-cell-role="th">5%</th>
<th data-quarto-table-cell-role="th">95%</th>
<th data-quarto-table-cell-role="th">ESS_bulk</th>
<th data-quarto-table-cell-role="th">ESS_tail</th>
<th data-quarto-table-cell-role="th">R_hat</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">sigma_mu</td>
<td>0.52</td>
<td>0.02</td>
<td>0.42</td>
<td>0.38</td>
<td>0.04</td>
<td>1.38</td>
<td>768.98</td>
<td>1720.27</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">alpha</td>
<td>1.40</td>
<td>0.01</td>
<td>0.31</td>
<td>0.29</td>
<td>0.89</td>
<td>1.88</td>
<td>3107.82</td>
<td>2519.17</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">sigma_kappa</td>
<td>0.13</td>
<td>0.00</td>
<td>0.09</td>
<td>0.07</td>
<td>0.04</td>
<td>0.30</td>
<td>751.11</td>
<td>1272.65</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">beta</td>
<td>-0.34</td>
<td>0.00</td>
<td>0.06</td>
<td>0.06</td>
<td>-0.45</td>
<td>-0.25</td>
<td>2390.64</td>
<td>1926.24</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">phi</td>
<td>1.61</td>
<td>0.00</td>
<td>0.19</td>
<td>0.18</td>
<td>1.32</td>
<td>1.94</td>
<td>5825.70</td>
<td>2427.51</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">mu[1]</td>
<td>0.25</td>
<td>0.02</td>
<td>0.75</td>
<td>0.66</td>
<td>-1.18</td>
<td>1.25</td>
<td>1475.28</td>
<td>1901.80</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">mu[2]</td>
<td>1.66</td>
<td>0.01</td>
<td>0.52</td>
<td>0.50</td>
<td>0.88</td>
<td>2.57</td>
<td>1805.13</td>
<td>1928.38</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">mu[3]</td>
<td>2.13</td>
<td>0.00</td>
<td>0.32</td>
<td>0.31</td>
<td>1.62</td>
<td>2.67</td>
<td>6331.73</td>
<td>3418.58</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">mu[4]</td>
<td>1.47</td>
<td>0.01</td>
<td>0.50</td>
<td>0.45</td>
<td>0.61</td>
<td>2.27</td>
<td>4481.17</td>
<td>3172.84</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">mu[5]</td>
<td>2.39</td>
<td>0.01</td>
<td>0.42</td>
<td>0.41</td>
<td>1.70</td>
<td>3.10</td>
<td>5938.28</td>
<td>3652.69</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">mu[6]</td>
<td>1.90</td>
<td>0.01</td>
<td>0.40</td>
<td>0.35</td>
<td>1.30</td>
<td>2.60</td>
<td>4054.76</td>
<td>2509.59</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">mu[7]</td>
<td>2.68</td>
<td>0.00</td>
<td>0.25</td>
<td>0.25</td>
<td>2.27</td>
<td>3.10</td>
<td>4360.99</td>
<td>3098.85</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">mu[8]</td>
<td>-0.50</td>
<td>0.02</td>
<td>0.96</td>
<td>0.91</td>
<td>-1.98</td>
<td>1.12</td>
<td>2677.24</td>
<td>2444.97</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">mu[9]</td>
<td>0.22</td>
<td>0.01</td>
<td>0.57</td>
<td>0.57</td>
<td>-0.75</td>
<td>1.16</td>
<td>5571.23</td>
<td>3403.76</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">mu[10]</td>
<td>1.78</td>
<td>0.03</td>
<td>1.11</td>
<td>0.99</td>
<td>-0.30</td>
<td>3.31</td>
<td>1419.00</td>
<td>1815.65</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">kappa[1]</td>
<td>-0.01</td>
<td>0.00</td>
<td>0.08</td>
<td>0.07</td>
<td>-0.12</td>
<td>0.14</td>
<td>1442.55</td>
<td>1878.43</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">kappa[2]</td>
<td>-0.42</td>
<td>0.00</td>
<td>0.10</td>
<td>0.09</td>
<td>-0.59</td>
<td>-0.28</td>
<td>1764.95</td>
<td>2100.80</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">kappa[3]</td>
<td>-0.59</td>
<td>0.00</td>
<td>0.10</td>
<td>0.10</td>
<td>-0.76</td>
<td>-0.42</td>
<td>5836.27</td>
<td>3336.35</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">kappa[4]</td>
<td>-0.22</td>
<td>0.00</td>
<td>0.07</td>
<td>0.06</td>
<td>-0.33</td>
<td>-0.11</td>
<td>4217.42</td>
<td>3166.98</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">kappa[5]</td>
<td>-0.60</td>
<td>0.00</td>
<td>0.09</td>
<td>0.09</td>
<td>-0.75</td>
<td>-0.45</td>
<td>5880.82</td>
<td>3405.24</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">kappa[6]</td>
<td>-0.44</td>
<td>0.00</td>
<td>0.11</td>
<td>0.09</td>
<td>-0.62</td>
<td>-0.28</td>
<td>4255.86</td>
<td>2503.23</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">kappa[7]</td>
<td>-0.31</td>
<td>0.00</td>
<td>0.07</td>
<td>0.06</td>
<td>-0.42</td>
<td>-0.20</td>
<td>4661.56</td>
<td>3269.61</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">kappa[8]</td>
<td>-0.23</td>
<td>0.00</td>
<td>0.15</td>
<td>0.14</td>
<td>-0.50</td>
<td>-0.00</td>
<td>2366.12</td>
<td>2430.51</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">kappa[9]</td>
<td>0.08</td>
<td>0.00</td>
<td>0.06</td>
<td>0.06</td>
<td>-0.01</td>
<td>0.18</td>
<td>5532.24</td>
<td>3206.16</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">kappa[10]</td>
<td>-0.72</td>
<td>0.00</td>
<td>0.16</td>
<td>0.15</td>
<td>-0.96</td>
<td>-0.44</td>
<td>1789.71</td>
<td>1796.36</td>
<td>1.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="7d42ab5b" class="cell" data-execution_count="78">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a>plt.clf()</span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a>sns.histplot(az_samps_NB_hier_slopes.posterior.beta.to_numpy().flatten(), binwidth<span class="op">=</span><span class="fl">0.005</span>)</span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb107-6"><a href="#cb107-6" aria-hidden="true" tabindex="-1"></a>plt.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Pest%20Control%20Example_files/figure-html/cell-79-output-1.png" width="511" height="411" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>While the model can’t specifically rule out zero from the posterior, it does have mass at small non-zero numbers, so we should leave in the hierarchy over <span class="math inline">\(\texttt{kappa}\)</span>. Plotting the marginal data density again, we can see the model still looks well calibrated.</p>
<div id="5f4ebf93" class="cell" data-execution_count="79">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a>y_rep <span class="op">=</span> az_samps_NB_hier_slopes.posterior_predictive.y_rep</span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a>plt.clf()</span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">200</span>):</span>
<span id="cb108-5"><a href="#cb108-5" aria-hidden="true" tabindex="-1"></a>    sns.kdeplot(y_rep.sel(chain<span class="op">=</span><span class="bu">slice</span>(<span class="dv">0</span>), draw<span class="op">=</span>i).to_dataframe(), x<span class="op">=</span><span class="st">'y_rep'</span>, color<span class="op">=</span><span class="st">'k'</span>, alpha<span class="op">=</span><span class="fl">0.2</span>)</span>
<span id="cb108-6"><a href="#cb108-6" aria-hidden="true" tabindex="-1"></a>sns.kdeplot(stan_dat_hier[<span class="st">'complaints'</span>], color<span class="op">=</span><span class="st">'r'</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb108-7"><a href="#cb108-7" aria-hidden="true" tabindex="-1"></a>plt.xlim(<span class="dv">0</span>,)</span>
<span id="cb108-8"><a href="#cb108-8" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb108-9"><a href="#cb108-9" aria-hidden="true" tabindex="-1"></a>plt.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Pest%20Control%20Example_files/figure-html/cell-80-output-1.png" width="511" height="411" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="time-varying-effects-and-structured-priors" class="level2">
<h2 class="anchored" data-anchor-id="time-varying-effects-and-structured-priors">Time varying effects and structured priors</h2>
<p>We haven’t looked at how cockroach complaints change over time. Let’s look at whether there’s any pattern over time.</p>
<div id="a93561cf" class="cell" data-execution_count="80">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a>grouped_indices <span class="op">=</span> defaultdict(<span class="bu">list</span>)</span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> idx, month_num <span class="kw">in</span> <span class="bu">enumerate</span>(stan_dat_hier[<span class="st">'mo_idx'</span>]):</span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> month_num <span class="op">&gt;</span> <span class="dv">12</span>: <span class="cf">continue</span></span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a>    grouped_indices[month_num].append(idx)</span>
<span id="cb109-5"><a href="#cb109-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb109-6"><a href="#cb109-6" aria-hidden="true" tabindex="-1"></a>grouped_array <span class="op">=</span> {bldg_id: y_rep[:, :, idx_list].mean(axis<span class="op">=</span><span class="dv">2</span>).to_numpy().flatten() <span class="cf">for</span> bldg_id, idx_list <span class="kw">in</span> grouped_indices.items()}</span>
<span id="cb109-7"><a href="#cb109-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-8"><a href="#cb109-8" aria-hidden="true" tabindex="-1"></a>_, axes <span class="op">=</span> plt.subplots(<span class="dv">3</span>, <span class="dv">4</span>, figsize<span class="op">=</span>(<span class="dv">7</span>,<span class="dv">4</span>))</span>
<span id="cb109-9"><a href="#cb109-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-10"><a href="#cb109-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ax, key <span class="kw">in</span> <span class="bu">zip</span>(axes.flat, <span class="bu">sorted</span>(grouped_array.keys())):</span>
<span id="cb109-11"><a href="#cb109-11" aria-hidden="true" tabindex="-1"></a>    sns.histplot(grouped_array[key], bins<span class="op">=</span><span class="dv">30</span>, ax<span class="op">=</span>ax)</span>
<span id="cb109-12"><a href="#cb109-12" aria-hidden="true" tabindex="-1"></a>    ax.axvline(stan_dat_hier[<span class="st">'complaints'</span>][grouped_indices[key]].mean(), color<span class="op">=</span><span class="st">'r'</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb109-13"><a href="#cb109-13" aria-hidden="true" tabindex="-1"></a>    ax.xaxis.set_major_locator(mticker.MaxNLocator(nbins<span class="op">=</span><span class="dv">4</span>))</span>
<span id="cb109-14"><a href="#cb109-14" aria-hidden="true" tabindex="-1"></a>    ax.<span class="bu">set</span>(ylabel<span class="op">=</span><span class="st">''</span>, title<span class="op">=</span><span class="ss">f"Bulding = </span><span class="sc">{</span>key<span class="sc">}</span><span class="ss">"</span>, xlim<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">12</span>))</span>
<span id="cb109-15"><a href="#cb109-15" aria-hidden="true" tabindex="-1"></a>    ax.yaxis.set_ticks([])</span>
<span id="cb109-16"><a href="#cb109-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-17"><a href="#cb109-17" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb109-18"><a href="#cb109-18" aria-hidden="true" tabindex="-1"></a>plt.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Pest%20Control%20Example_files/figure-html/cell-81-output-1.png" width="711" height="411" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>We might augment our model with a log-additive monthly effect, <span class="math inline">\(\texttt{mo}_t\)</span>.</p>
<p><span class="math display">\[
\eta_{b,t} = \mu_b + \kappa_b \, \texttt{traps}_{b,t} + \texttt{mo}_t + \text{log_sq_foot}_b
\]</span></p>
<p>We have complete freedom over how to specify the prior for <span class="math inline">\(\texttt{mo}_t\)</span>. There are several competing factors for how the number of complaints might change over time. It makes sense that there might be more roaches in the environment during the summer, but we might also expect that there is more roach control in the summer as well. Given that we’re modeling complaints, maybe after the first sighting of roaches in a building, residents are more vigilant, and thus complaints of roaches would increase.</p>
<p>This can be a motivation for using an autoregressive prior for our monthly effects. The model is as follows:</p>
<p><span class="math display">\[
\begin{equation}
\texttt{mo}_t \sim \text{Normal}(\rho \, \texttt{mo}_{t-1}, \sigma_\texttt{mo}) \\
\equiv \\
\texttt{mo}_t = \rho \, \texttt{mo}_{t-1} +\epsilon_t , \quad \epsilon_t \sim \text{Normal}(0, \sigma_\texttt{mo}) \\
\quad \rho \in [-1,1]
\end{equation}
\]</span></p>
<p>This equation says that the monthly effect in month <span class="math inline">\(t\)</span> is directly related to the last month’s monthly effect. Given the description of the process above, it seems like there could be either positive or negative associations between the months, but there should be a bit more weight placed on positive <span class="math inline">\(\rho\)</span>s, so we’ll put an informative prior that pushes the parameter <span class="math inline">\(\rho\)</span> towards 0.5.</p>
<p>Before we write our prior, however, we have a problem: Stan doesn’t implement any densities that have support on <span class="math inline">\([-1,1]\)</span>. We can use variable transformation of a raw variable defined on <span class="math inline">\([0,1]\)</span> to to give us a density on <span class="math inline">\([-1,1]\)</span>. Specifically,</p>
<p><span class="math display">\[
\begin{equation}
\rho_{\text{raw}} \in [0, 1] \\
\rho = 2 \times \rho_{\text{raw}} - 1
\end{equation}
\]</span></p>
<p>Then we can put a beta prior on <span class="math inline">\(\rho_\text{raw}\)</span> to push our estimate towards 0.5.</p>
<p>One further wrinkle is that we have a prior for <span class="math inline">\(\texttt{mo}_t\)</span> that depends on <span class="math inline">\(\texttt{mo}_{t-1}\)</span>. That is, we are working with the <em>conditional</em> distribution of <span class="math inline">\(\texttt{mo}_t\)</span> given <span class="math inline">\(\texttt{mo}_{t-1}\)</span>. But what should we do about the prior for <span class="math inline">\(\texttt{mo}_1\)</span>, for which we don’t have a previous time period in the data?</p>
<p>We need to work out the <em>marginal</em> distribution of the first observation. Thankfully we can use the fact that AR models are stationary, so <span class="math inline">\(\text{Var}(\texttt{mo}_t) = \text{Var}(\texttt{mo}_{t-1})\)</span> and <span class="math inline">\(\mathbb{E}(\texttt{mo}_t) = \mathbb{E}(\texttt{mo}_{t-1})\)</span> for all <span class="math inline">\(t\)</span>. Therefore the marginal distribution of <span class="math inline">\(\texttt{mo}_1\)</span> is the same as the marginal distribution of any <span class="math inline">\(\texttt{mo}_t\)</span>.</p>
<p>First we derive the marginal variance of <span class="math inline">\(\texttt{mo}_{t}\)</span>.</p>
<p><span class="math display">\[
\begin{align*}
\text{Var}(\texttt{mo}_t) &amp;= \text{Var}(\rho \texttt{mo}_{t-1} + \epsilon_t)  \\
\text{Var}(\texttt{mo}_t) &amp;= \text{Var}(\rho \texttt{mo}_{t-1}) + \text{Var}(\epsilon_t)
\end{align*}
\]</span></p>
<p>where the second line holds by independence of <span class="math inline">\(\epsilon_t\)</span> and <span class="math inline">\(\epsilon_{t-1})\)</span>. Then, using the fact that <span class="math inline">\(Var(cX) = c^2Var(X)\)</span> for a constant <span class="math inline">\(c\)</span> and the fact that, by stationarity, <span class="math inline">\(\textrm{Var}(\texttt{mo}_{t-1}) = \textrm{Var}(\texttt{mo}_{t})\)</span>, we then obtain:</p>
<p><span class="math display">\[
\begin{align*}
\text{Var}(\texttt{mo}_t) &amp;= \rho^2 \text{Var}( \texttt{mo}_{t})  + \sigma_\texttt{mo}^2 \\
\text{Var}(\texttt{mo}_t) &amp;= \frac{\sigma_\texttt{mo}^2}{1 - \rho^2}
\end{align*}
\]</span></p>
<p>For the mean of <span class="math inline">\(\texttt{mo}_t\)</span> things are a bit simpler:</p>
<p><span class="math display">\[
\begin{align*}
\mathbb{E}(\texttt{mo}_t) &amp;= \mathbb{E}(\rho \, \texttt{mo}_{t-1} + \epsilon_t) \\
\mathbb{E}(\texttt{mo}_t) &amp;= \mathbb{E}(\rho \, \texttt{mo}_{t-1}) + \mathbb{E}(\epsilon_t) \\
\end{align*}
\]</span></p>
<p>Since <span class="math inline">\(\mathbb{E}(\epsilon_t) = 0\)</span> by assumption we have</p>
<p><span class="math display">\[
\begin{align*}
\mathbb{E}(\texttt{mo}_t) &amp;= \mathbb{E}(\rho \, \texttt{mo}_{t-1})  + 0\\
\mathbb{E}(\texttt{mo}_t) &amp;= \rho \, \mathbb{E}(\texttt{mo}_{t}) \\
\mathbb{E}(\texttt{mo}_t) - \rho \mathbb{E}(\texttt{mo}_t) &amp;= 0  \\
\mathbb{E}(\texttt{mo}_t) &amp;= 0/(1 - \rho)
\end{align*}
\]</span></p>
<p>which for <span class="math inline">\(\rho \neq 1\)</span> yields <span class="math inline">\(\mathbb{E}(\texttt{mo}_{t}) = 0\)</span>.</p>
<p>We now have the marginal distribution for <span class="math inline">\(\texttt{mo}_{t}\)</span>, which, in our case, we will use for <span class="math inline">\(\texttt{mo}_1\)</span>. The full AR(1) specification is then:</p>
<p><span class="math display">\[
\begin{align*}
\texttt{mo}_1 &amp;\sim \text{Normal}\left(0, \frac{\sigma_\texttt{mo}}{\sqrt{1 - \rho^2}}\right) \\
\texttt{mo}_t &amp;\sim \text{Normal}\left(\rho \, \texttt{mo}_{t-1}, \sigma_\texttt{mo}\right) \forall t &gt; 1
\end{align*}
\]</span></p>
<div id="2f06842d" class="cell" data-execution_count="81">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a>hier_NB_regression_ncp_slopes_mod_mos <span class="op">=</span> <span class="st">'''</span></span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a><span class="st">functions {</span></span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a><span class="st">  /*</span></span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a><span class="st">  * Alternative to neg_binomial_2_log_rng() that </span></span>
<span id="cb110-5"><a href="#cb110-5" aria-hidden="true" tabindex="-1"></a><span class="st">  * avoids potential numerical problems during warmup</span></span>
<span id="cb110-6"><a href="#cb110-6" aria-hidden="true" tabindex="-1"></a><span class="st">  */</span></span>
<span id="cb110-7"><a href="#cb110-7" aria-hidden="true" tabindex="-1"></a><span class="st">  int neg_binomial_2_log_safe_rng(real eta, real phi) {</span></span>
<span id="cb110-8"><a href="#cb110-8" aria-hidden="true" tabindex="-1"></a><span class="st">    real gamma_rate = gamma_rng(phi, phi / exp(eta));</span></span>
<span id="cb110-9"><a href="#cb110-9" aria-hidden="true" tabindex="-1"></a><span class="st">    if (gamma_rate &gt;= exp(20.79))</span></span>
<span id="cb110-10"><a href="#cb110-10" aria-hidden="true" tabindex="-1"></a><span class="st">      return -9;</span></span>
<span id="cb110-11"><a href="#cb110-11" aria-hidden="true" tabindex="-1"></a><span class="st">      </span></span>
<span id="cb110-12"><a href="#cb110-12" aria-hidden="true" tabindex="-1"></a><span class="st">    return poisson_rng(gamma_rate);</span></span>
<span id="cb110-13"><a href="#cb110-13" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb110-14"><a href="#cb110-14" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb110-15"><a href="#cb110-15" aria-hidden="true" tabindex="-1"></a><span class="st">data {</span></span>
<span id="cb110-16"><a href="#cb110-16" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; N;   </span></span>
<span id="cb110-17"><a href="#cb110-17" aria-hidden="true" tabindex="-1"></a><span class="st">  array[N] int&lt;lower=0&gt; complaints;</span></span>
<span id="cb110-18"><a href="#cb110-18" aria-hidden="true" tabindex="-1"></a><span class="st">  vector&lt;lower=0&gt;[N] traps;                </span></span>
<span id="cb110-19"><a href="#cb110-19" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb110-20"><a href="#cb110-20" aria-hidden="true" tabindex="-1"></a><span class="st">  // 'exposure'</span></span>
<span id="cb110-21"><a href="#cb110-21" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N] log_sq_foot;  </span></span>
<span id="cb110-22"><a href="#cb110-22" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb110-23"><a href="#cb110-23" aria-hidden="true" tabindex="-1"></a><span class="st">  // building-level data</span></span>
<span id="cb110-24"><a href="#cb110-24" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; K;</span></span>
<span id="cb110-25"><a href="#cb110-25" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; J;</span></span>
<span id="cb110-26"><a href="#cb110-26" aria-hidden="true" tabindex="-1"></a><span class="st">  array[N] int&lt;lower=1, upper=J&gt; building_idx;</span></span>
<span id="cb110-27"><a href="#cb110-27" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[J,K] building_data;</span></span>
<span id="cb110-28"><a href="#cb110-28" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb110-29"><a href="#cb110-29" aria-hidden="true" tabindex="-1"></a><span class="st">  // month </span></span>
<span id="cb110-30"><a href="#cb110-30" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; M; </span></span>
<span id="cb110-31"><a href="#cb110-31" aria-hidden="true" tabindex="-1"></a><span class="st">  array[N] int&lt;lower=1,upper=M&gt; mo_idx;</span></span>
<span id="cb110-32"><a href="#cb110-32" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb110-33"><a href="#cb110-33" aria-hidden="true" tabindex="-1"></a><span class="st">parameters {</span></span>
<span id="cb110-34"><a href="#cb110-34" aria-hidden="true" tabindex="-1"></a><span class="st">  real&lt;lower=0&gt; inv_phi;   // 1/phi (easier to think about prior for 1/phi instead of phi)</span></span>
<span id="cb110-35"><a href="#cb110-35" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb110-36"><a href="#cb110-36" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[J] mu_raw;        // N(0,1) params for non-centered param of building-specific intercepts</span></span>
<span id="cb110-37"><a href="#cb110-37" aria-hidden="true" tabindex="-1"></a><span class="st">  real&lt;lower=0&gt; sigma_mu;  // sd of buildings-specific intercepts</span></span>
<span id="cb110-38"><a href="#cb110-38" aria-hidden="true" tabindex="-1"></a><span class="st">  real alpha;              // 'global' intercept</span></span>
<span id="cb110-39"><a href="#cb110-39" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[K] zeta;          // coefficients on building-level predictors in model for mu</span></span>
<span id="cb110-40"><a href="#cb110-40" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb110-41"><a href="#cb110-41" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[J] kappa_raw;       // N(0,1) params for non-centered param of building-specific slopes</span></span>
<span id="cb110-42"><a href="#cb110-42" aria-hidden="true" tabindex="-1"></a><span class="st">  real&lt;lower=0&gt; sigma_kappa; // sd of buildings-specific slopes</span></span>
<span id="cb110-43"><a href="#cb110-43" aria-hidden="true" tabindex="-1"></a><span class="st">  real beta;                 // 'global' slope on traps variable</span></span>
<span id="cb110-44"><a href="#cb110-44" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[K] gamma;           // coefficients on building-level predictors in model for kappa</span></span>
<span id="cb110-45"><a href="#cb110-45" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb110-46"><a href="#cb110-46" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb110-47"><a href="#cb110-47" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[M] mo_raw;               // N(0,1) params for non-centered param of AR(1) process</span></span>
<span id="cb110-48"><a href="#cb110-48" aria-hidden="true" tabindex="-1"></a><span class="st">  real&lt;lower=0&gt; sigma_mo;         // sd of month-specific parameters</span></span>
<span id="cb110-49"><a href="#cb110-49" aria-hidden="true" tabindex="-1"></a><span class="st">  real&lt;lower=0,upper=1&gt; rho_raw;  // used to construct AR(1) coefficient</span></span>
<span id="cb110-50"><a href="#cb110-50" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb110-51"><a href="#cb110-51" aria-hidden="true" tabindex="-1"></a><span class="st">transformed parameters {</span></span>
<span id="cb110-52"><a href="#cb110-52" aria-hidden="true" tabindex="-1"></a><span class="st">  real phi = inv(inv_phi);</span></span>
<span id="cb110-53"><a href="#cb110-53" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb110-54"><a href="#cb110-54" aria-hidden="true" tabindex="-1"></a><span class="st">  // non-centered parameterization of building-specific intercepts and slopes</span></span>
<span id="cb110-55"><a href="#cb110-55" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[J] mu = alpha + building_data * zeta + sigma_mu * mu_raw;</span></span>
<span id="cb110-56"><a href="#cb110-56" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[J] kappa = beta + building_data * gamma + sigma_kappa * kappa_raw;</span></span>
<span id="cb110-57"><a href="#cb110-57" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb110-58"><a href="#cb110-58" aria-hidden="true" tabindex="-1"></a><span class="st">  // AR(1) process priors</span></span>
<span id="cb110-59"><a href="#cb110-59" aria-hidden="true" tabindex="-1"></a><span class="st">  real rho = 2.0 * rho_raw - 1.0;</span></span>
<span id="cb110-60"><a href="#cb110-60" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[M] mo = sigma_mo * mo_raw;</span></span>
<span id="cb110-61"><a href="#cb110-61" aria-hidden="true" tabindex="-1"></a><span class="st">  mo[1] /= sqrt(1 - rho^2);</span></span>
<span id="cb110-62"><a href="#cb110-62" aria-hidden="true" tabindex="-1"></a><span class="st">  for (m in 2:M) {</span></span>
<span id="cb110-63"><a href="#cb110-63" aria-hidden="true" tabindex="-1"></a><span class="st">    mo[m] += rho * mo[m-1];</span></span>
<span id="cb110-64"><a href="#cb110-64" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb110-65"><a href="#cb110-65" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb110-66"><a href="#cb110-66" aria-hidden="true" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb110-67"><a href="#cb110-67" aria-hidden="true" tabindex="-1"></a><span class="st">  inv_phi ~ normal(0, 1);</span></span>
<span id="cb110-68"><a href="#cb110-68" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb110-69"><a href="#cb110-69" aria-hidden="true" tabindex="-1"></a><span class="st">  kappa_raw ~ normal(0,1) ;</span></span>
<span id="cb110-70"><a href="#cb110-70" aria-hidden="true" tabindex="-1"></a><span class="st">  sigma_kappa ~ normal(0, 1);</span></span>
<span id="cb110-71"><a href="#cb110-71" aria-hidden="true" tabindex="-1"></a><span class="st">  beta ~ normal(-0.25, 1);</span></span>
<span id="cb110-72"><a href="#cb110-72" aria-hidden="true" tabindex="-1"></a><span class="st">  gamma ~ normal(0, 1);</span></span>
<span id="cb110-73"><a href="#cb110-73" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb110-74"><a href="#cb110-74" aria-hidden="true" tabindex="-1"></a><span class="st">  mu_raw ~ normal(0,1) ;</span></span>
<span id="cb110-75"><a href="#cb110-75" aria-hidden="true" tabindex="-1"></a><span class="st">  sigma_mu ~ normal(0, 1);</span></span>
<span id="cb110-76"><a href="#cb110-76" aria-hidden="true" tabindex="-1"></a><span class="st">  alpha ~ normal(log(4), 1);</span></span>
<span id="cb110-77"><a href="#cb110-77" aria-hidden="true" tabindex="-1"></a><span class="st">  zeta ~ normal(0, 1);</span></span>
<span id="cb110-78"><a href="#cb110-78" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb110-79"><a href="#cb110-79" aria-hidden="true" tabindex="-1"></a><span class="st">  mo_raw ~ normal(0,1);</span></span>
<span id="cb110-80"><a href="#cb110-80" aria-hidden="true" tabindex="-1"></a><span class="st">  sigma_mo ~ normal(0, 1);</span></span>
<span id="cb110-81"><a href="#cb110-81" aria-hidden="true" tabindex="-1"></a><span class="st">  rho_raw ~ beta(10, 5);</span></span>
<span id="cb110-82"><a href="#cb110-82" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb110-83"><a href="#cb110-83" aria-hidden="true" tabindex="-1"></a><span class="st">  complaints ~ neg_binomial_2_log(mu[building_idx] + kappa[building_idx] .* traps </span></span>
<span id="cb110-84"><a href="#cb110-84" aria-hidden="true" tabindex="-1"></a><span class="st">                                 + mo[mo_idx] + log_sq_foot, phi);</span></span>
<span id="cb110-85"><a href="#cb110-85" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb110-86"><a href="#cb110-86" aria-hidden="true" tabindex="-1"></a><span class="st">generated quantities {</span></span>
<span id="cb110-87"><a href="#cb110-87" aria-hidden="true" tabindex="-1"></a><span class="st">  array[N] int y_rep;</span></span>
<span id="cb110-88"><a href="#cb110-88" aria-hidden="true" tabindex="-1"></a><span class="st">  for (n in 1:N) {</span></span>
<span id="cb110-89"><a href="#cb110-89" aria-hidden="true" tabindex="-1"></a><span class="st">    real eta_n = </span></span>
<span id="cb110-90"><a href="#cb110-90" aria-hidden="true" tabindex="-1"></a><span class="st">      mu[building_idx[n]] + kappa[building_idx[n]] * traps[n] + mo[mo_idx[n]] + log_sq_foot[n];</span></span>
<span id="cb110-91"><a href="#cb110-91" aria-hidden="true" tabindex="-1"></a><span class="st">    y_rep[n] = neg_binomial_2_log_safe_rng(eta_n, phi);</span></span>
<span id="cb110-92"><a href="#cb110-92" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb110-93"><a href="#cb110-93" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb110-94"><a href="#cb110-94" aria-hidden="true" tabindex="-1"></a><span class="st">'''</span></span>
<span id="cb110-95"><a href="#cb110-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-96"><a href="#cb110-96" aria-hidden="true" tabindex="-1"></a>comp_model_NB_hier_mos <span class="op">=</span> StanModel(<span class="st">'../stan_models/hier_NB_regression_ncp_slopes_mod_mos'</span>, hier_NB_regression_ncp_slopes_mod_mos)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="a5ca7e46" class="cell" data-execution_count="82">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a>keys_to_remove <span class="op">=</span> {<span class="st">'pred_mat'</span>, <span class="st">'log_sq_foot_pred'</span>, <span class="st">'M_forward'</span>}</span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a>filtered_stan_dat_hier <span class="op">=</span> {k: v <span class="cf">for</span> k, v <span class="kw">in</span> stan_dat_hier.items() <span class="cf">if</span> k <span class="kw">not</span> <span class="kw">in</span> keys_to_remove}</span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-4"><a href="#cb111-4" aria-hidden="true" tabindex="-1"></a>fitted_model_NB_hier_mos <span class="op">=</span> comp_model_NB_hier_mos.sample(</span>
<span id="cb111-5"><a href="#cb111-5" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>filtered_stan_dat_hier,</span>
<span id="cb111-6"><a href="#cb111-6" aria-hidden="true" tabindex="-1"></a>    chains<span class="op">=</span><span class="dv">4</span>,</span>
<span id="cb111-7"><a href="#cb111-7" aria-hidden="true" tabindex="-1"></a>    parallel_chains<span class="op">=</span><span class="dv">4</span>,</span>
<span id="cb111-8"><a href="#cb111-8" aria-hidden="true" tabindex="-1"></a>    adapt_delta<span class="op">=</span><span class="fl">0.9</span>,</span>
<span id="cb111-9"><a href="#cb111-9" aria-hidden="true" tabindex="-1"></a>    show_progress<span class="op">=</span><span class="va">False</span></span>
<span id="cb111-10"><a href="#cb111-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb111-11"><a href="#cb111-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-12"><a href="#cb111-12" aria-hidden="true" tabindex="-1"></a>az_samps_NB_hier_mos <span class="op">=</span> az.from_cmdstanpy(fitted_model_NB_hier_mos, posterior_predictive<span class="op">=</span><span class="st">'y_rep'</span>, observed_data<span class="op">=</span>filtered_stan_dat_hier)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>In the interest of brevity, we won’t go on expanding the model, though we certainly could. What other information would help us understand the data generating process better? What other aspects of the data generating process might we want to capture that we’re not capturing now?</p>
<p>As usual, we run through our posterior predictive checks.</p>
<div id="ada344f2" class="cell" data-execution_count="83">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a>y_rep <span class="op">=</span> az_samps_NB_hier_mos.posterior_predictive.y_rep</span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a>plt.clf()</span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">200</span>):</span>
<span id="cb112-5"><a href="#cb112-5" aria-hidden="true" tabindex="-1"></a>    sns.kdeplot(y_rep.sel(chain<span class="op">=</span><span class="bu">slice</span>(<span class="dv">0</span>), draw<span class="op">=</span>i).to_dataframe(), x<span class="op">=</span><span class="st">'y_rep'</span>, color<span class="op">=</span><span class="st">'k'</span>, alpha<span class="op">=</span><span class="fl">0.2</span>)</span>
<span id="cb112-6"><a href="#cb112-6" aria-hidden="true" tabindex="-1"></a>sns.kdeplot(stan_dat_hier[<span class="st">'complaints'</span>], color<span class="op">=</span><span class="st">'r'</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb112-7"><a href="#cb112-7" aria-hidden="true" tabindex="-1"></a>plt.xlim(<span class="dv">0</span>,)</span>
<span id="cb112-8"><a href="#cb112-8" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb112-9"><a href="#cb112-9" aria-hidden="true" tabindex="-1"></a>plt.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Pest%20Control%20Example_files/figure-html/cell-84-output-1.png" width="511" height="411" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="5afbb88f" class="cell" data-execution_count="84">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a>grouped_indices <span class="op">=</span> defaultdict(<span class="bu">list</span>)</span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> idx, month_num <span class="kw">in</span> <span class="bu">enumerate</span>(stan_dat_hier[<span class="st">'mo_idx'</span>]):</span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> month_num <span class="op">&gt;</span> <span class="dv">12</span>: <span class="cf">continue</span></span>
<span id="cb113-4"><a href="#cb113-4" aria-hidden="true" tabindex="-1"></a>    grouped_indices[month_num].append(idx)</span>
<span id="cb113-5"><a href="#cb113-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb113-6"><a href="#cb113-6" aria-hidden="true" tabindex="-1"></a>grouped_array <span class="op">=</span> {bldg_id: y_rep[:, :, idx_list].mean(axis<span class="op">=</span><span class="dv">2</span>).to_numpy().flatten() <span class="cf">for</span> bldg_id, idx_list <span class="kw">in</span> grouped_indices.items()}</span>
<span id="cb113-7"><a href="#cb113-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-8"><a href="#cb113-8" aria-hidden="true" tabindex="-1"></a>_, axes <span class="op">=</span> plt.subplots(<span class="dv">3</span>, <span class="dv">4</span>, figsize<span class="op">=</span>(<span class="dv">7</span>,<span class="dv">4</span>))</span>
<span id="cb113-9"><a href="#cb113-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-10"><a href="#cb113-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ax, key <span class="kw">in</span> <span class="bu">zip</span>(axes.flat, <span class="bu">sorted</span>(grouped_array.keys())):</span>
<span id="cb113-11"><a href="#cb113-11" aria-hidden="true" tabindex="-1"></a>    sns.histplot(grouped_array[key], bins<span class="op">=</span><span class="dv">20</span>, ax<span class="op">=</span>ax)</span>
<span id="cb113-12"><a href="#cb113-12" aria-hidden="true" tabindex="-1"></a>    ax.axvline(stan_dat_hier[<span class="st">'complaints'</span>][grouped_indices[key]].mean(), color<span class="op">=</span><span class="st">'r'</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb113-13"><a href="#cb113-13" aria-hidden="true" tabindex="-1"></a>    ax.xaxis.set_major_locator(mticker.MaxNLocator(nbins<span class="op">=</span><span class="dv">4</span>))</span>
<span id="cb113-14"><a href="#cb113-14" aria-hidden="true" tabindex="-1"></a>    ax.<span class="bu">set</span>(ylabel<span class="op">=</span><span class="st">''</span>, title<span class="op">=</span><span class="ss">f"Bulding = </span><span class="sc">{</span>key<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb113-15"><a href="#cb113-15" aria-hidden="true" tabindex="-1"></a>    ax.yaxis.set_ticks([])</span>
<span id="cb113-16"><a href="#cb113-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-17"><a href="#cb113-17" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb113-18"><a href="#cb113-18" aria-hidden="true" tabindex="-1"></a>plt.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Pest%20Control%20Example_files/figure-html/cell-85-output-1.png" width="711" height="411" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>As we can see, our monthly random intercept has captured a monthly pattern across all the buildings. We can also compare the prior and posterior for the autoregressive parameter to see how much we’ve learned. Here are two different ways of comparing the prior and posterior visually:</p>
<div id="04472ce7" class="cell" data-execution_count="85">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> scipy.special <span class="im">as</span> special</span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 1) compare draws from prior and draws from posterior</span></span>
<span id="cb114-4"><a href="#cb114-4" aria-hidden="true" tabindex="-1"></a>prior_rho <span class="op">=</span> <span class="dv">2</span> <span class="op">*</span> np.random.beta(a<span class="op">=</span><span class="dv">10</span>, b<span class="op">=</span><span class="dv">5</span>, size<span class="op">=</span><span class="dv">4000</span>) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb114-5"><a href="#cb114-5" aria-hidden="true" tabindex="-1"></a>posterior_rho <span class="op">=</span> az_samps_NB_hier_mos.posterior.rho.to_numpy().flatten()</span>
<span id="cb114-6"><a href="#cb114-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-7"><a href="#cb114-7" aria-hidden="true" tabindex="-1"></a>plt.clf()</span>
<span id="cb114-8"><a href="#cb114-8" aria-hidden="true" tabindex="-1"></a>sns.histplot(prior_rho, binwidth<span class="op">=</span><span class="fl">0.025</span>)</span>
<span id="cb114-9"><a href="#cb114-9" aria-hidden="true" tabindex="-1"></a>sns.histplot(posterior_rho, binwidth<span class="op">=</span><span class="fl">0.025</span>)</span>
<span id="cb114-10"><a href="#cb114-10" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb114-11"><a href="#cb114-11" aria-hidden="true" tabindex="-1"></a>plt.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Pest%20Control%20Example_files/figure-html/cell-86-output-1.png" width="511" height="411" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="865718c0" class="cell" data-execution_count="86">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 2) overlay prior density curve on posterior draws</span></span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> gen_rho_prior(x):</span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a>    alpha, beta <span class="op">=</span> <span class="dv">10</span>, <span class="dv">5</span></span>
<span id="cb115-4"><a href="#cb115-4" aria-hidden="true" tabindex="-1"></a>    a, c <span class="op">=</span> <span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span></span>
<span id="cb115-5"><a href="#cb115-5" aria-hidden="true" tabindex="-1"></a>    lp <span class="op">=</span> (</span>
<span id="cb115-6"><a href="#cb115-6" aria-hidden="true" tabindex="-1"></a>        (alpha <span class="op">-</span> <span class="dv">1</span>) <span class="op">*</span> np.log(x <span class="op">-</span> a) <span class="op">+</span></span>
<span id="cb115-7"><a href="#cb115-7" aria-hidden="true" tabindex="-1"></a>        (beta <span class="op">-</span> <span class="dv">1</span>) <span class="op">*</span> np.log(c <span class="op">-</span> x) <span class="op">-</span></span>
<span id="cb115-8"><a href="#cb115-8" aria-hidden="true" tabindex="-1"></a>        (alpha <span class="op">+</span> beta <span class="op">-</span> <span class="dv">1</span>) <span class="op">*</span> np.log(c <span class="op">-</span> a) <span class="op">-</span></span>
<span id="cb115-9"><a href="#cb115-9" aria-hidden="true" tabindex="-1"></a>        special.betaln(<span class="dv">3</span>, <span class="dv">4</span>)</span>
<span id="cb115-10"><a href="#cb115-10" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb115-11"><a href="#cb115-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.exp(lp)</span>
<span id="cb115-12"><a href="#cb115-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-13"><a href="#cb115-13" aria-hidden="true" tabindex="-1"></a>plt.clf()</span>
<span id="cb115-14"><a href="#cb115-14" aria-hidden="true" tabindex="-1"></a>_, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb115-15"><a href="#cb115-15" aria-hidden="true" tabindex="-1"></a>sns.histplot(posterior_rho, binwidth<span class="op">=</span><span class="fl">0.025</span>, ax<span class="op">=</span>ax)</span>
<span id="cb115-16"><a href="#cb115-16" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.linspace(<span class="op">-</span><span class="fl">0.99</span>,<span class="fl">0.99</span>)</span>
<span id="cb115-17"><a href="#cb115-17" aria-hidden="true" tabindex="-1"></a>secax <span class="op">=</span> ax.twinx()</span>
<span id="cb115-18"><a href="#cb115-18" aria-hidden="true" tabindex="-1"></a>secax.plot(x, gen_rho_prior(x), color<span class="op">=</span><span class="st">'k'</span>)</span>
<span id="cb115-19"><a href="#cb115-19" aria-hidden="true" tabindex="-1"></a>secax.<span class="bu">set</span>(ylim<span class="op">=</span>(<span class="dv">0</span>,<span class="fl">0.03</span>))</span>
<span id="cb115-20"><a href="#cb115-20" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb115-21"><a href="#cb115-21" aria-hidden="true" tabindex="-1"></a>plt.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<pre><code>&lt;Figure size 500x400 with 0 Axes&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Pest%20Control%20Example_files/figure-html/cell-87-output-2.png" width="511" height="411" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="50c647af" class="cell" data-execution_count="87">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a>summary <span class="op">=</span> fitted_model_NB_hier_mos.summary(percentiles<span class="op">=</span>(<span class="dv">5</span>, <span class="dv">95</span>)).<span class="bu">round</span>(<span class="dv">2</span>)</span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a>filter_indices <span class="op">=</span> <span class="vs">r'^(gamma(\[\d+\])?|rho|sigma_mu|sigma_kappa)$'</span></span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a>summary[summary.index.<span class="bu">str</span>.match(filter_indices, na<span class="op">=</span><span class="va">False</span>)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="87">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Mean</th>
<th data-quarto-table-cell-role="th">MCSE</th>
<th data-quarto-table-cell-role="th">StdDev</th>
<th data-quarto-table-cell-role="th">MAD</th>
<th data-quarto-table-cell-role="th">5%</th>
<th data-quarto-table-cell-role="th">95%</th>
<th data-quarto-table-cell-role="th">ESS_bulk</th>
<th data-quarto-table-cell-role="th">ESS_tail</th>
<th data-quarto-table-cell-role="th">R_hat</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">sigma_mu</td>
<td>0.30</td>
<td>0.01</td>
<td>0.23</td>
<td>0.23</td>
<td>0.02</td>
<td>0.75</td>
<td>1422.01</td>
<td>2313.68</td>
<td>1.00</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">sigma_kappa</td>
<td>0.09</td>
<td>0.01</td>
<td>0.07</td>
<td>0.04</td>
<td>0.02</td>
<td>0.21</td>
<td>477.88</td>
<td>195.18</td>
<td>1.01</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">gamma[1]</td>
<td>-0.18</td>
<td>0.00</td>
<td>0.11</td>
<td>0.10</td>
<td>-0.35</td>
<td>0.01</td>
<td>815.80</td>
<td>206.62</td>
<td>1.01</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">gamma[2]</td>
<td>0.11</td>
<td>0.00</td>
<td>0.09</td>
<td>0.07</td>
<td>-0.02</td>
<td>0.24</td>
<td>605.71</td>
<td>232.65</td>
<td>1.01</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">gamma[3]</td>
<td>0.09</td>
<td>0.00</td>
<td>0.15</td>
<td>0.14</td>
<td>-0.16</td>
<td>0.32</td>
<td>1742.63</td>
<td>1982.97</td>
<td>1.00</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">gamma[4]</td>
<td>-0.01</td>
<td>0.00</td>
<td>0.07</td>
<td>0.06</td>
<td>-0.11</td>
<td>0.09</td>
<td>2278.88</td>
<td>1946.29</td>
<td>1.00</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">rho</td>
<td>0.78</td>
<td>0.00</td>
<td>0.08</td>
<td>0.08</td>
<td>0.64</td>
<td>0.89</td>
<td>1217.13</td>
<td>1992.79</td>
<td>1.00</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="3baea686" class="cell" data-execution_count="88">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a>plt.clf()</span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a>_, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a>ax.plot(stan_dat_hier[<span class="st">'traps'</span>], stan_dat_hier[<span class="st">'complaints'</span>], <span class="st">'o'</span>, fillstyle<span class="op">=</span><span class="st">'none'</span>)</span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-6"><a href="#cb118-6" aria-hidden="true" tabindex="-1"></a>grouped_indices <span class="op">=</span> defaultdict(<span class="bu">list</span>)</span>
<span id="cb118-7"><a href="#cb118-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> idx, trap <span class="kw">in</span> <span class="bu">enumerate</span>(stan_dat_hier[<span class="st">'traps'</span>]):</span>
<span id="cb118-8"><a href="#cb118-8" aria-hidden="true" tabindex="-1"></a>    grouped_indices[trap].append(idx)</span>
<span id="cb118-9"><a href="#cb118-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-10"><a href="#cb118-10" aria-hidden="true" tabindex="-1"></a>grouped_array <span class="op">=</span> {trap: y_rep[:, :, idx_list].to_numpy().flatten() <span class="cf">for</span> trap, idx_list <span class="kw">in</span> grouped_indices.items()}</span>
<span id="cb118-11"><a href="#cb118-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-12"><a href="#cb118-12" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> traps_x, complaints_y <span class="kw">in</span> grouped_array.items():</span>
<span id="cb118-13"><a href="#cb118-13" aria-hidden="true" tabindex="-1"></a>    inner_prob <span class="op">=</span> az.hdi(complaints_y, hdi_prob<span class="op">=</span><span class="fl">0.95</span>)</span>
<span id="cb118-14"><a href="#cb118-14" aria-hidden="true" tabindex="-1"></a>    outer_prob <span class="op">=</span> az.hdi(complaints_y, hdi_prob<span class="op">=</span><span class="fl">0.99</span>)</span>
<span id="cb118-15"><a href="#cb118-15" aria-hidden="true" tabindex="-1"></a>    ax.plot(np.full(inner_prob.shape, traps_x), inner_prob, <span class="st">'k'</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb118-16"><a href="#cb118-16" aria-hidden="true" tabindex="-1"></a>    ax.plot(np.full(outer_prob.shape, traps_x), outer_prob, <span class="st">'k'</span>, linewidth<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb118-17"><a href="#cb118-17" aria-hidden="true" tabindex="-1"></a>    ax.plot(traps_x, np.mean(complaints_y), <span class="st">'ko'</span>)</span>
<span id="cb118-18"><a href="#cb118-18" aria-hidden="true" tabindex="-1"></a>ax.<span class="bu">set</span>(xlabel<span class="op">=</span><span class="st">'Number of traps'</span>, ylabel<span class="op">=</span><span class="st">'Number of complaints'</span>)</span>
<span id="cb118-19"><a href="#cb118-19" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb118-20"><a href="#cb118-20" aria-hidden="true" tabindex="-1"></a>plt.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<pre><code>&lt;Figure size 500x400 with 0 Axes&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Pest%20Control%20Example_files/figure-html/cell-89-output-2.png" width="511" height="411" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>It looks as if our model finally generates a reasonable posterior predictive distribution for all numbers of traps, and appropriately captures the tails of the data generating process.</p>
</section>
<section id="using-our-model-cost-forecasts" class="level2">
<h2 class="anchored" data-anchor-id="using-our-model-cost-forecasts">Using our model: Cost forecasts</h2>
<p>Our model seems to be fitting well, so now we will go ahead and use the model to help us make a decision about how many traps to put in our buildings. We’ll make a forecast for 6 months forward.</p>
<div id="f84598f7" class="cell" data-execution_count="89">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a>hier_NB_regression_ncp_slopes_mod_mos_predict <span class="op">=</span> <span class="st">'''</span></span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a><span class="st">functions {</span></span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a><span class="st">  /*</span></span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a><span class="st">  * Alternative to neg_binomial_2_log_rng() that </span></span>
<span id="cb120-5"><a href="#cb120-5" aria-hidden="true" tabindex="-1"></a><span class="st">  * avoids potential numerical problems during warmup</span></span>
<span id="cb120-6"><a href="#cb120-6" aria-hidden="true" tabindex="-1"></a><span class="st">  */</span></span>
<span id="cb120-7"><a href="#cb120-7" aria-hidden="true" tabindex="-1"></a><span class="st">  int neg_binomial_2_log_safe_rng(real eta, real phi) {</span></span>
<span id="cb120-8"><a href="#cb120-8" aria-hidden="true" tabindex="-1"></a><span class="st">    real gamma_rate = gamma_rng(phi, phi / exp(eta));</span></span>
<span id="cb120-9"><a href="#cb120-9" aria-hidden="true" tabindex="-1"></a><span class="st">    if (gamma_rate &gt;= exp(20.79))</span></span>
<span id="cb120-10"><a href="#cb120-10" aria-hidden="true" tabindex="-1"></a><span class="st">      return -9;</span></span>
<span id="cb120-11"><a href="#cb120-11" aria-hidden="true" tabindex="-1"></a><span class="st">      </span></span>
<span id="cb120-12"><a href="#cb120-12" aria-hidden="true" tabindex="-1"></a><span class="st">    return poisson_rng(gamma_rate);</span></span>
<span id="cb120-13"><a href="#cb120-13" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb120-14"><a href="#cb120-14" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb120-15"><a href="#cb120-15" aria-hidden="true" tabindex="-1"></a><span class="st">data {</span></span>
<span id="cb120-16"><a href="#cb120-16" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; N;                     </span></span>
<span id="cb120-17"><a href="#cb120-17" aria-hidden="true" tabindex="-1"></a><span class="st">  array[N] int&lt;lower=0&gt; complaints;</span></span>
<span id="cb120-18"><a href="#cb120-18" aria-hidden="true" tabindex="-1"></a><span class="st">  vector&lt;lower=0&gt;[N] traps;</span></span>
<span id="cb120-19"><a href="#cb120-19" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb120-20"><a href="#cb120-20" aria-hidden="true" tabindex="-1"></a><span class="st">  // 'exposure'</span></span>
<span id="cb120-21"><a href="#cb120-21" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N] log_sq_foot;</span></span>
<span id="cb120-22"><a href="#cb120-22" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb120-23"><a href="#cb120-23" aria-hidden="true" tabindex="-1"></a><span class="st">  // building-level data</span></span>
<span id="cb120-24"><a href="#cb120-24" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; K;</span></span>
<span id="cb120-25"><a href="#cb120-25" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; J;</span></span>
<span id="cb120-26"><a href="#cb120-26" aria-hidden="true" tabindex="-1"></a><span class="st">  array[N] int&lt;lower=1, upper=J&gt; building_idx;</span></span>
<span id="cb120-27"><a href="#cb120-27" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[J,K] building_data;</span></span>
<span id="cb120-28"><a href="#cb120-28" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb120-29"><a href="#cb120-29" aria-hidden="true" tabindex="-1"></a><span class="st">  // month </span></span>
<span id="cb120-30"><a href="#cb120-30" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; M; </span></span>
<span id="cb120-31"><a href="#cb120-31" aria-hidden="true" tabindex="-1"></a><span class="st">  array[N] int&lt;lower=1,upper=M&gt; mo_idx;</span></span>
<span id="cb120-32"><a href="#cb120-32" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb120-33"><a href="#cb120-33" aria-hidden="true" tabindex="-1"></a><span class="st">  // for use in generated quantities</span></span>
<span id="cb120-34"><a href="#cb120-34" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; M_forward;</span></span>
<span id="cb120-35"><a href="#cb120-35" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[J] log_sq_foot_pred;</span></span>
<span id="cb120-36"><a href="#cb120-36" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb120-37"><a href="#cb120-37" aria-hidden="true" tabindex="-1"></a><span class="st">transformed data {</span></span>
<span id="cb120-38"><a href="#cb120-38" aria-hidden="true" tabindex="-1"></a><span class="st">  // We'll make predictions for 0, 1, 2, ..., 20 traps (can go further too)</span></span>
<span id="cb120-39"><a href="#cb120-39" aria-hidden="true" tabindex="-1"></a><span class="st">  int N_hypo_traps = 21;</span></span>
<span id="cb120-40"><a href="#cb120-40" aria-hidden="true" tabindex="-1"></a><span class="st">  array[N_hypo_traps] int hypo_traps;</span></span>
<span id="cb120-41"><a href="#cb120-41" aria-hidden="true" tabindex="-1"></a><span class="st">  for (i in 1:N_hypo_traps)</span></span>
<span id="cb120-42"><a href="#cb120-42" aria-hidden="true" tabindex="-1"></a><span class="st">    hypo_traps[i] = i - 1;</span></span>
<span id="cb120-43"><a href="#cb120-43" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb120-44"><a href="#cb120-44" aria-hidden="true" tabindex="-1"></a><span class="st">parameters {</span></span>
<span id="cb120-45"><a href="#cb120-45" aria-hidden="true" tabindex="-1"></a><span class="st">  real&lt;lower=0&gt; inv_phi;   // 1/phi (easier to think about prior for 1/phi instead of phi)</span></span>
<span id="cb120-46"><a href="#cb120-46" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb120-47"><a href="#cb120-47" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[J] mu_raw;        // N(0,1) params for non-centered param of building-specific intercepts</span></span>
<span id="cb120-48"><a href="#cb120-48" aria-hidden="true" tabindex="-1"></a><span class="st">  real&lt;lower=0&gt; sigma_mu;  // sd of buildings-specific intercepts</span></span>
<span id="cb120-49"><a href="#cb120-49" aria-hidden="true" tabindex="-1"></a><span class="st">  real alpha;              // 'global' intercept</span></span>
<span id="cb120-50"><a href="#cb120-50" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[K] zeta;          // coefficients on building-level predictors in model for mu</span></span>
<span id="cb120-51"><a href="#cb120-51" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb120-52"><a href="#cb120-52" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[J] kappa_raw;       // N(0,1) params for non-centered param of building-specific slopes</span></span>
<span id="cb120-53"><a href="#cb120-53" aria-hidden="true" tabindex="-1"></a><span class="st">  real&lt;lower=0&gt; sigma_kappa; // sd of buildings-specific slopes</span></span>
<span id="cb120-54"><a href="#cb120-54" aria-hidden="true" tabindex="-1"></a><span class="st">  real beta;                 // 'global' slope on traps variable</span></span>
<span id="cb120-55"><a href="#cb120-55" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[K] gamma;           // coefficients on building-level predictors in model for kappa</span></span>
<span id="cb120-56"><a href="#cb120-56" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb120-57"><a href="#cb120-57" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[M] mo_raw;               // N(0,1) params for non-centered param of AR(1) process</span></span>
<span id="cb120-58"><a href="#cb120-58" aria-hidden="true" tabindex="-1"></a><span class="st">  real&lt;lower=0&gt; sigma_mo;         // sd of month-specific parameters</span></span>
<span id="cb120-59"><a href="#cb120-59" aria-hidden="true" tabindex="-1"></a><span class="st">  real&lt;lower=0,upper=1&gt; rho_raw;  // used to construct AR(1) coefficient</span></span>
<span id="cb120-60"><a href="#cb120-60" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb120-61"><a href="#cb120-61" aria-hidden="true" tabindex="-1"></a><span class="st">transformed parameters {</span></span>
<span id="cb120-62"><a href="#cb120-62" aria-hidden="true" tabindex="-1"></a><span class="st">  real phi = inv(inv_phi);</span></span>
<span id="cb120-63"><a href="#cb120-63" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb120-64"><a href="#cb120-64" aria-hidden="true" tabindex="-1"></a><span class="st">  // non-centered parameterization of building-specific intercepts and slopes</span></span>
<span id="cb120-65"><a href="#cb120-65" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[J] mu = alpha + building_data * zeta + sigma_mu * mu_raw;</span></span>
<span id="cb120-66"><a href="#cb120-66" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[J] kappa = beta + building_data * gamma + sigma_kappa * kappa_raw;</span></span>
<span id="cb120-67"><a href="#cb120-67" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb120-68"><a href="#cb120-68" aria-hidden="true" tabindex="-1"></a><span class="st">  // AR(1) process priors</span></span>
<span id="cb120-69"><a href="#cb120-69" aria-hidden="true" tabindex="-1"></a><span class="st">  real rho = 2.0 * rho_raw - 1.0;</span></span>
<span id="cb120-70"><a href="#cb120-70" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[M] mo = sigma_mo * mo_raw;</span></span>
<span id="cb120-71"><a href="#cb120-71" aria-hidden="true" tabindex="-1"></a><span class="st">  mo[1] /= sqrt(1 - rho^2);</span></span>
<span id="cb120-72"><a href="#cb120-72" aria-hidden="true" tabindex="-1"></a><span class="st">  for (m in 2:M) {</span></span>
<span id="cb120-73"><a href="#cb120-73" aria-hidden="true" tabindex="-1"></a><span class="st">    mo[m] += rho * mo[m-1];</span></span>
<span id="cb120-74"><a href="#cb120-74" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb120-75"><a href="#cb120-75" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb120-76"><a href="#cb120-76" aria-hidden="true" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb120-77"><a href="#cb120-77" aria-hidden="true" tabindex="-1"></a><span class="st">  inv_phi ~ normal(0, 1);</span></span>
<span id="cb120-78"><a href="#cb120-78" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb120-79"><a href="#cb120-79" aria-hidden="true" tabindex="-1"></a><span class="st">  kappa_raw ~ normal(0,1) ;</span></span>
<span id="cb120-80"><a href="#cb120-80" aria-hidden="true" tabindex="-1"></a><span class="st">  sigma_kappa ~ normal(0, 1);</span></span>
<span id="cb120-81"><a href="#cb120-81" aria-hidden="true" tabindex="-1"></a><span class="st">  beta ~ normal(-0.25, 1);</span></span>
<span id="cb120-82"><a href="#cb120-82" aria-hidden="true" tabindex="-1"></a><span class="st">  gamma ~ normal(0, 1);</span></span>
<span id="cb120-83"><a href="#cb120-83" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb120-84"><a href="#cb120-84" aria-hidden="true" tabindex="-1"></a><span class="st">  mu_raw ~ normal(0,1) ;</span></span>
<span id="cb120-85"><a href="#cb120-85" aria-hidden="true" tabindex="-1"></a><span class="st">  sigma_mu ~ normal(0, 1);</span></span>
<span id="cb120-86"><a href="#cb120-86" aria-hidden="true" tabindex="-1"></a><span class="st">  alpha ~ normal(log(4), 1);</span></span>
<span id="cb120-87"><a href="#cb120-87" aria-hidden="true" tabindex="-1"></a><span class="st">  zeta ~ normal(0, 1);</span></span>
<span id="cb120-88"><a href="#cb120-88" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb120-89"><a href="#cb120-89" aria-hidden="true" tabindex="-1"></a><span class="st">  mo_raw ~ normal(0,1);</span></span>
<span id="cb120-90"><a href="#cb120-90" aria-hidden="true" tabindex="-1"></a><span class="st">  sigma_mo ~ normal(0, 1);</span></span>
<span id="cb120-91"><a href="#cb120-91" aria-hidden="true" tabindex="-1"></a><span class="st">  rho_raw ~ beta(10, 5);</span></span>
<span id="cb120-92"><a href="#cb120-92" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb120-93"><a href="#cb120-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-94"><a href="#cb120-94" aria-hidden="true" tabindex="-1"></a><span class="st">  { </span></span>
<span id="cb120-95"><a href="#cb120-95" aria-hidden="true" tabindex="-1"></a><span class="st">  // within a local block we can declare new temporary variables  </span></span>
<span id="cb120-96"><a href="#cb120-96" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N] eta = mu[building_idx] + kappa[building_idx] .* traps + mo[mo_idx] + log_sq_foot;</span></span>
<span id="cb120-97"><a href="#cb120-97" aria-hidden="true" tabindex="-1"></a><span class="st">  complaints ~ neg_binomial_2_log(eta, phi);</span></span>
<span id="cb120-98"><a href="#cb120-98" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb120-99"><a href="#cb120-99" aria-hidden="true" tabindex="-1"></a><span class="st">  /* </span></span>
<span id="cb120-100"><a href="#cb120-100" aria-hidden="true" tabindex="-1"></a><span class="st">  alternatively we can use a 'target +=' statement, which is equivalent to </span></span>
<span id="cb120-101"><a href="#cb120-101" aria-hidden="true" tabindex="-1"></a><span class="st">  above except that using '~' drops constants that don't affect inferences:</span></span>
<span id="cb120-102"><a href="#cb120-102" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb120-103"><a href="#cb120-103" aria-hidden="true" tabindex="-1"></a><span class="st">  target += neg_binomial_2_log_lpmf(complaints | eta, phi);</span></span>
<span id="cb120-104"><a href="#cb120-104" aria-hidden="true" tabindex="-1"></a><span class="st">  */</span></span>
<span id="cb120-105"><a href="#cb120-105" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb120-106"><a href="#cb120-106" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb120-107"><a href="#cb120-107" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb120-108"><a href="#cb120-108" aria-hidden="true" tabindex="-1"></a><span class="st">generated quantities {</span></span>
<span id="cb120-109"><a href="#cb120-109" aria-hidden="true" tabindex="-1"></a><span class="st">  // we'll predict number of complaints and revenue lost for each building</span></span>
<span id="cb120-110"><a href="#cb120-110" aria-hidden="true" tabindex="-1"></a><span class="st">  // at each hypothetical number of traps for M_forward months in the future</span></span>
<span id="cb120-111"><a href="#cb120-111" aria-hidden="true" tabindex="-1"></a><span class="st">  array[J,N_hypo_traps] int y_pred;</span></span>
<span id="cb120-112"><a href="#cb120-112" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[J,N_hypo_traps] rev_pred;</span></span>
<span id="cb120-113"><a href="#cb120-113" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb120-114"><a href="#cb120-114" aria-hidden="true" tabindex="-1"></a><span class="st">  for (j in 1:J) {</span></span>
<span id="cb120-115"><a href="#cb120-115" aria-hidden="true" tabindex="-1"></a><span class="st">    for (i in 1:N_hypo_traps) {</span></span>
<span id="cb120-116"><a href="#cb120-116" aria-hidden="true" tabindex="-1"></a><span class="st">      array[M_forward] int y_pred_by_month;</span></span>
<span id="cb120-117"><a href="#cb120-117" aria-hidden="true" tabindex="-1"></a><span class="st">      vector[M_forward] mo_forward;</span></span>
<span id="cb120-118"><a href="#cb120-118" aria-hidden="true" tabindex="-1"></a><span class="st">      </span></span>
<span id="cb120-119"><a href="#cb120-119" aria-hidden="true" tabindex="-1"></a><span class="st">      mo_forward[1] = normal_rng(rho * mo[M], sigma_mo);</span></span>
<span id="cb120-120"><a href="#cb120-120" aria-hidden="true" tabindex="-1"></a><span class="st">      for (m in 2:M_forward) </span></span>
<span id="cb120-121"><a href="#cb120-121" aria-hidden="true" tabindex="-1"></a><span class="st">        mo_forward[m] = normal_rng(rho * mo_forward[m-1], sigma_mo); </span></span>
<span id="cb120-122"><a href="#cb120-122" aria-hidden="true" tabindex="-1"></a><span class="st">        </span></span>
<span id="cb120-123"><a href="#cb120-123" aria-hidden="true" tabindex="-1"></a><span class="st">      for (m in 1:M_forward) {</span></span>
<span id="cb120-124"><a href="#cb120-124" aria-hidden="true" tabindex="-1"></a><span class="st">        real eta = mu[j] + kappa[j] * hypo_traps[i] + mo_forward[m] + log_sq_foot_pred[j];</span></span>
<span id="cb120-125"><a href="#cb120-125" aria-hidden="true" tabindex="-1"></a><span class="st">        y_pred_by_month[m] = neg_binomial_2_log_safe_rng(eta, phi);</span></span>
<span id="cb120-126"><a href="#cb120-126" aria-hidden="true" tabindex="-1"></a><span class="st">      }</span></span>
<span id="cb120-127"><a href="#cb120-127" aria-hidden="true" tabindex="-1"></a><span class="st">      </span></span>
<span id="cb120-128"><a href="#cb120-128" aria-hidden="true" tabindex="-1"></a><span class="st">      y_pred[j,i] = sum(y_pred_by_month);</span></span>
<span id="cb120-129"><a href="#cb120-129" aria-hidden="true" tabindex="-1"></a><span class="st">      </span></span>
<span id="cb120-130"><a href="#cb120-130" aria-hidden="true" tabindex="-1"></a><span class="st">      // were were told every 10 complaints has additional exterminator cost of $100, </span></span>
<span id="cb120-131"><a href="#cb120-131" aria-hidden="true" tabindex="-1"></a><span class="st">      // so $10 lose per complaint.</span></span>
<span id="cb120-132"><a href="#cb120-132" aria-hidden="true" tabindex="-1"></a><span class="st">      rev_pred[j,i] = y_pred[j,i] * (-10.0);</span></span>
<span id="cb120-133"><a href="#cb120-133" aria-hidden="true" tabindex="-1"></a><span class="st">    }</span></span>
<span id="cb120-134"><a href="#cb120-134" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb120-135"><a href="#cb120-135" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb120-136"><a href="#cb120-136" aria-hidden="true" tabindex="-1"></a><span class="st">'''</span></span>
<span id="cb120-137"><a href="#cb120-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-138"><a href="#cb120-138" aria-hidden="true" tabindex="-1"></a>comp_rev <span class="op">=</span> StanModel(<span class="st">'../stan_models/hier_NB_regression_ncp_slopes_mod_mos_predict'</span>, hier_NB_regression_ncp_slopes_mod_mos_predict)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>An important input to the revenue model is how much revenue is lost due to each complaint. The client has a policy that for every 10 complaints, they’ll call an exterminator costing the client $100, so that’ll amount to $10 per complaint.</p>
<div id="603b8ffd" class="cell" data-execution_count="90">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a>rev_model <span class="op">=</span> comp_rev.sample(</span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>stan_dat_hier,</span>
<span id="cb121-3"><a href="#cb121-3" aria-hidden="true" tabindex="-1"></a>    chains<span class="op">=</span><span class="dv">4</span>,</span>
<span id="cb121-4"><a href="#cb121-4" aria-hidden="true" tabindex="-1"></a>    parallel_chains<span class="op">=</span><span class="dv">4</span>,</span>
<span id="cb121-5"><a href="#cb121-5" aria-hidden="true" tabindex="-1"></a>    adapt_delta<span class="op">=</span><span class="fl">0.9</span>,</span>
<span id="cb121-6"><a href="#cb121-6" aria-hidden="true" tabindex="-1"></a>    show_progress<span class="op">=</span><span class="va">False</span></span>
<span id="cb121-7"><a href="#cb121-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb121-8"><a href="#cb121-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-9"><a href="#cb121-9" aria-hidden="true" tabindex="-1"></a>az_samps_rev_model <span class="op">=</span> az.from_cmdstanpy(rev_model, posterior_predictive<span class="op">=</span>[<span class="st">'rev_pred'</span>, <span class="st">'y_pred'</span>], observed_data<span class="op">=</span>stan_dat_hier)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Below we’ve generated our revenue curves for the buildings. These charts will give us precise quantification of our uncertainty around our revenue projections at any number of traps for each building.</p>
<p>A key input to our analysis will be the cost of installing bait stations. We’re simulating the number of complaints we receive over the course of a year, so we need to understand the cost associated with maintaining each bait station over the course of a year. There’s the cost attributed to the raw bait station, which is the plastic housing and the bait material, a peanut-buttery substance that’s injected with insecticide. The cost of maintaining one bait station for a year plus monthly replenishment of the bait material is about $20.</p>
<div id="82b7283f" class="cell" data-execution_count="91">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a>N_traps <span class="op">=</span> np.arange(<span class="dv">20</span><span class="op">+</span><span class="dv">1</span>)</span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a>costs <span class="op">=</span> N_traps <span class="op">*</span> <span class="dv">10</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We’ll also need labor for maintaining the bait stations, which need to be serviced every two months. If there are fewer than five traps, our in-house maintenance staff can manage the stations (about one hour of work every two months at $20/hour), but above five traps we need to hire outside pest control to help out. They’re a bit more expensive, so we’ve put their cost at $30 /hour. Each five traps should require an extra person-hour of work, so that’s factored in as well. The marginal person-person hours above five traps are at the higher pest-control-labor rate.</p>
<div id="d730b4d1" class="cell" data-execution_count="92">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a>N_months_forward <span class="op">=</span> <span class="dv">12</span></span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a>N_months_labor <span class="op">=</span> N_months_forward <span class="op">//</span> <span class="dv">2</span></span>
<span id="cb123-3"><a href="#cb123-3" aria-hidden="true" tabindex="-1"></a>hourly_rate_low <span class="op">=</span> <span class="dv">20</span></span>
<span id="cb123-4"><a href="#cb123-4" aria-hidden="true" tabindex="-1"></a>hourly_rate_high <span class="op">=</span> <span class="dv">30</span></span>
<span id="cb123-5"><a href="#cb123-5" aria-hidden="true" tabindex="-1"></a>costs <span class="op">+=</span> (</span>
<span id="cb123-6"><a href="#cb123-6" aria-hidden="true" tabindex="-1"></a>    ((N_traps <span class="op">&lt;</span> <span class="dv">5</span>) <span class="op">&amp;</span> (N_traps <span class="op">&gt;</span> <span class="dv">0</span>)) <span class="op">*</span> (N_months_labor <span class="op">*</span> hourly_rate_low) <span class="op">+</span></span>
<span id="cb123-7"><a href="#cb123-7" aria-hidden="true" tabindex="-1"></a>    ((N_traps <span class="op">&gt;=</span> <span class="dv">5</span>) <span class="op">&amp;</span> (N_traps <span class="op">&lt;</span> <span class="dv">10</span>)) <span class="op">*</span> (N_months_labor <span class="op">*</span> (hourly_rate_low <span class="op">+</span> <span class="dv">1</span> <span class="op">*</span> hourly_rate_high)) <span class="op">+</span></span>
<span id="cb123-8"><a href="#cb123-8" aria-hidden="true" tabindex="-1"></a>    ((N_traps <span class="op">&gt;=</span> <span class="dv">10</span>) <span class="op">&amp;</span> (N_traps <span class="op">&lt;</span> <span class="dv">15</span>)) <span class="op">*</span> (N_months_labor <span class="op">*</span> (hourly_rate_low <span class="op">+</span> <span class="dv">2</span> <span class="op">*</span> hourly_rate_high)) <span class="op">+</span></span>
<span id="cb123-9"><a href="#cb123-9" aria-hidden="true" tabindex="-1"></a>    (N_traps <span class="op">&gt;=</span> <span class="dv">15</span>) <span class="op">*</span> (N_months_labor <span class="op">*</span> (hourly_rate_low <span class="op">+</span> <span class="dv">3</span> <span class="op">*</span> hourly_rate_high))</span>
<span id="cb123-10"><a href="#cb123-10" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We can now plot curves with number of traps on the x-axis and profit/loss forecasts and uncertainty intervals on the y-axis.</p>
<div id="3e605b27" class="cell" data-execution_count="93">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a><span class="co"># total and mean profit</span></span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a>tot_profit <span class="op">=</span> az_samps_rev_model.posterior_predictive.rev_pred <span class="op">-</span> costs</span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a>mean_profit <span class="op">=</span> tot_profit.median(dim<span class="op">=</span>[<span class="st">'chain'</span>, <span class="st">'draw'</span>])</span>
<span id="cb124-4"><a href="#cb124-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-5"><a href="#cb124-5" aria-hidden="true" tabindex="-1"></a><span class="co"># lower and upper ends of 50% central interval</span></span>
<span id="cb124-6"><a href="#cb124-6" aria-hidden="true" tabindex="-1"></a>lower_profit <span class="op">=</span> tot_profit.quantile(q<span class="op">=</span><span class="fl">0.25</span>, dim<span class="op">=</span>[<span class="st">'chain'</span>, <span class="st">'draw'</span>])</span>
<span id="cb124-7"><a href="#cb124-7" aria-hidden="true" tabindex="-1"></a>upper_profit <span class="op">=</span> tot_profit.quantile(q<span class="op">=</span><span class="fl">0.75</span>, dim<span class="op">=</span>[<span class="st">'chain'</span>, <span class="st">'draw'</span>])</span>
<span id="cb124-8"><a href="#cb124-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-9"><a href="#cb124-9" aria-hidden="true" tabindex="-1"></a>profit_df <span class="op">=</span> pd.DataFrame({</span>
<span id="cb124-10"><a href="#cb124-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">'profit'</span>: mean_profit.to_numpy().flatten(),</span>
<span id="cb124-11"><a href="#cb124-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">'lower'</span>: lower_profit.to_numpy().flatten(),</span>
<span id="cb124-12"><a href="#cb124-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">'upper'</span>: upper_profit.to_numpy().flatten(),</span>
<span id="cb124-13"><a href="#cb124-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">'traps'</span>: np.tile(N_traps, N_buildings),</span>
<span id="cb124-14"><a href="#cb124-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">'building'</span>: np.repeat(np.arange(<span class="dv">1</span>, N_buildings<span class="op">+</span><span class="dv">1</span>), np.<span class="bu">max</span>(N_traps)<span class="op">+</span><span class="dv">1</span>)</span>
<span id="cb124-15"><a href="#cb124-15" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="20bc6d76" class="cell" data-execution_count="94">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a>plt.clf()</span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-3"><a href="#cb125-3" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">5</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">4</span>,<span class="dv">9</span>), sharex<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb125-4"><a href="#cb125-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-5"><a href="#cb125-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> idx, ax <span class="kw">in</span> <span class="bu">enumerate</span>(axes.flat):</span>
<span id="cb125-6"><a href="#cb125-6" aria-hidden="true" tabindex="-1"></a>  data <span class="op">=</span> profit_df[profit_df[<span class="st">'building'</span>] <span class="op">==</span> idx<span class="op">+</span><span class="dv">1</span>]</span>
<span id="cb125-7"><a href="#cb125-7" aria-hidden="true" tabindex="-1"></a>  profit_y <span class="op">=</span> data[<span class="st">'profit'</span>]</span>
<span id="cb125-8"><a href="#cb125-8" aria-hidden="true" tabindex="-1"></a>  traps_x <span class="op">=</span> data[<span class="st">'traps'</span>]</span>
<span id="cb125-9"><a href="#cb125-9" aria-hidden="true" tabindex="-1"></a>  ax.plot(traps_x, profit_y)</span>
<span id="cb125-10"><a href="#cb125-10" aria-hidden="true" tabindex="-1"></a>  ax.fill_between(traps_x, y1<span class="op">=</span>data[<span class="st">'lower'</span>], y2<span class="op">=</span>data[<span class="st">'upper'</span>], alpha<span class="op">=</span><span class="fl">0.2</span>)</span>
<span id="cb125-11"><a href="#cb125-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-12"><a href="#cb125-12" aria-hidden="true" tabindex="-1"></a>fig.supxlabel(<span class="st">'Traps'</span>)</span>
<span id="cb125-13"><a href="#cb125-13" aria-hidden="true" tabindex="-1"></a>fig.supylabel(<span class="st">'Profit'</span>)</span>
<span id="cb125-14"><a href="#cb125-14" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb125-15"><a href="#cb125-15" aria-hidden="true" tabindex="-1"></a>plt.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<pre><code>&lt;Figure size 500x400 with 0 Axes&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Pest%20Control%20Example_files/figure-html/cell-95-output-2.png" width="411" height="911" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>We can can see that the optimal number of bait stations differs by building.</p>
<section id="exercise-for-the-reader" class="level3">
<h3 class="anchored" data-anchor-id="exercise-for-the-reader">Exercise for the reader</h3>
<ul>
<li><p>How would we build a revenue curve for a new building?</p></li>
<li><p>Let’s say our utility function is revenue. If we wanted to maximize expected revenue, we can take expectations at each station count for each building, and choose the trap numbers that maximizes expected revenue. This will be called a maximum revenue strategy. How can we generate the distribution of portfolio revenue (i.e.&nbsp;the sum of revenue across all the buildings) under the maximum revenue strategy from the the draws of <code>rev_pred</code> we already have?</p></li>
</ul>
</section>
</section>
<section id="gaussian-process-instead-of-ar1" class="level2">
<h2 class="anchored" data-anchor-id="gaussian-process-instead-of-ar1">Gaussian process instead of AR(1)</h2>
<section id="joint-density-for-ar1-process" class="level3">
<h3 class="anchored" data-anchor-id="joint-density-for-ar1-process">Joint density for AR(1) process</h3>
<p>We can derive the joint distribution for the AR(1) process before we move to the Gaussian process (GP) which will give us a little more insight into what a GP is. Remember that we’ve specified the AR(1) prior as:</p>
<p><span class="math display">\[
\begin{align*}
\texttt{mo}_1 &amp;\sim \text{Normal}\left(0, \frac{\sigma_\texttt{mo}}{\sqrt{1 - \rho^2}}\right) \\
\texttt{mo}_t &amp;\sim \text{Normal}\left(\rho \, \texttt{mo}_{t-1}, \sigma_\texttt{mo}\right) \forall t &gt; 1
\end{align*}
\]</span></p>
<p>Rewriting our process in terms of the errors will make the derivation of the joint distribution clearer</p>
<p><span class="math display">\[
\begin{align*}
\texttt{mo}_1 &amp;\sim \text{Normal}\left(0, \frac{\sigma_\texttt{mo}}{\sqrt{1 - \rho^2}}\right) \\
\texttt{mo}_t &amp;= \rho \, \texttt{mo}_{t-1} + \sigma_\texttt{mo}\epsilon_t  \\
\epsilon_t &amp;\sim \text{Normal}\left(0, 1\right)
\end{align*}
\]</span></p>
<p>Given that our first term <span class="math inline">\(\texttt{mo}_1\)</span> is normally distributed, and subsequent terms are sums of normal random variables, we can see that jointly the vector, <code>mo</code>, with the <span class="math inline">\(t\)</span>-th element equally the scalar <span class="math inline">\(\texttt{mo}_t\)</span>, is multivariate normal, with mean zero (which we derived above). More formally, if we have a vector <span class="math inline">\(x \in \mathbb{R}^M\)</span> which is multivariate normal, <span class="math inline">\(x \sim \text{MultiNormal}(0, \Sigma)\)</span> and we left-multiply <span class="math inline">\(x\)</span> by a nonsingular matrix <span class="math inline">\(L \in \mathbb{R}^{M\times M}\)</span>, <span class="math inline">\(y = Lx \sim \text{MultiNormal}(0, L\Sigma L^T)\)</span>. We can use this fact to show that our vector <code>mo</code> is jointly multivariate normal.</p>
<p>Just as before with the noncentered parameterization, we’ll be taking a vector <span class="math inline">\(\texttt{mo_raw} \in \mathbb{R}^M\)</span> in which each element is univariate <span class="math inline">\(\text{Normal}(0,1)\)</span> and transforming it into <code>mo</code>, but instead of doing the transformation with scalar transformations like in the section <strong>Time varying effects and structured priors</strong>, we’ll do it with linear algebra operations. The trick is that by specifying each element of <span class="math inline">\(\texttt{mo_raw}\)</span> to be distributed <span class="math inline">\(\text{Normal}(0,1)\)</span> we are implicitly defining <span class="math inline">\(\texttt{mo_raw} \sim \text{MultiNormal}(0, I_M)\)</span>, where <span class="math inline">\(I_M\)</span> is the identity matrix of dimension <span class="math inline">\(M \times M\)</span>. Then we do a linear transformation using a matrix <span class="math inline">\(L\)</span> and assign the result to <code>mo</code> like <span class="math inline">\(\texttt{mo} = L\times\texttt{mo_raw}\)</span> so <span class="math inline">\(\texttt{mo} \sim \text{MultiNormal}(0, LI_M L^T)\)</span> and <span class="math inline">\(LI_M L^T = LL^T\)</span>.</p>
<p>Consider the case where we have three elements in <code>mo</code> and we want to make figure out the form for <span class="math inline">\(L\)</span>.</p>
<p>The first element of <code>mo</code> is fairly straightforward, because it mirrors our earlier parameterization of the AR(1) prior. The only difference is that we’re explicitly adding the last two terms of <code>mo_raw</code> into the equation so we can use matrix algebra for our transformation.</p>
<p><span class="math display">\[
\texttt{mo}_1 = \frac{\sigma_{\texttt{mo}}}{\sqrt{1 - \rho^2}} \times \texttt{mo_raw}_1 + 0 \times \texttt{mo_raw}_2 + 0 \times \texttt{mo_raw}_3\\
\]</span></p>
<p>The second element is a bit more complicated:</p>
<p><span class="math display">\[
\begin{align*}
\texttt{mo}_2 &amp;= \rho \texttt{mo}_1 + \sigma_{\texttt{mo}}\,\texttt{mo_raw}_2 + 0 \times \texttt{mo_raw}_3  \\
&amp;= \rho \left(\frac{\sigma_{\texttt{mo}}}{\sqrt{1 - \rho^2}} \times \texttt{mo_raw}_1\right) + \sigma_{\texttt{mo}}\,\texttt{mo_raw}_2 + 0 \times \texttt{mo_raw}_3  \\[5pt]
&amp;= \frac{\rho \sigma_{\texttt{mo}}}{\sqrt{1 - \rho^2}} \times \texttt{mo_raw}_1 + \sigma_{\texttt{mo}}\,\texttt{mo_raw}_2 + 0 \times \texttt{mo_raw}_3  \\
\end{align*}
\]</span></p>
<p>While the third element will involve all three terms</p>
<p><span class="math display">\[
\begin{align*}
\texttt{mo}_3 &amp;= \rho \, \texttt{mo}_2 + \sigma_{\texttt{mo}}\,\texttt{mo_raw}_3 \\
&amp;= \rho \left(\frac{\rho \sigma_{\texttt{mo}}}{\sqrt{1 - \rho^2}} \times \texttt{mo_raw}_1 + \sigma_{\texttt{mo}}\,\texttt{mo_raw}_2\right) + \sigma_{\texttt{mo}} \texttt{mo_raw}_3  \\[5pt]
&amp;= \frac{\rho^2 \sigma_{\texttt{mo}}}{\sqrt{1 - \rho^2}} \times \texttt{mo_raw}_1 + \rho \, \sigma_{\texttt{mo}}\,\texttt{mo_raw}_2 +  \sigma_{\texttt{mo}}\,\texttt{mo_raw}_3  \\
\end{align*}
\]</span></p>
<p>Writing this all together:</p>
<p><span class="math display">\[
\begin{align*}
\texttt{mo}_1 &amp;= \frac{\sigma_{\texttt{mo}}}{\sqrt{1 - \rho^2}} \times \texttt{mo_raw}_1 + 0 \times \texttt{mo_raw}_2 + 0 \times \texttt{mo_raw}_3\\[3pt]
\texttt{mo}_2 &amp;= \frac{\rho \sigma_{\texttt{mo}}}{\sqrt{1 - \rho^2}} \times \texttt{mo_raw}_1 + \sigma_{\texttt{mo}}\,\texttt{mo_raw}_2 + 0 \times \texttt{mo_raw}_3  \\[3pt]
\texttt{mo}_3 &amp;= \frac{\rho^2 \sigma_{\texttt{mo}}}{\sqrt{1 - \rho^2}} \times \texttt{mo_raw}_1 + \rho \, \sigma_{\texttt{mo}}\,\texttt{mo_raw}_2 +  \sigma_{\texttt{mo}}\,\texttt{mo_raw}_3  \\
\end{align*}
\]</span></p>
<p>Separating this into a matrix of coefficients <span class="math inline">\(L\)</span> and the vector <code>mo_raw</code>:</p>
<p><span class="math display">\[
\texttt{mo} = \begin{bmatrix} \sigma_\texttt{mo} / \sqrt{1 - \rho^2} &amp; 0 &amp; 0 \\
              \rho \sigma_\texttt{mo} / \sqrt{1 - \rho^2} &amp; \sigma_\texttt{mo} &amp; 0 \\
              \rho^2 \sigma_\texttt{mo} / \sqrt{1 - \rho^2} &amp; \rho \,\sigma_\texttt{mo}  &amp; \sigma_\texttt{mo}
              \end{bmatrix} \times \texttt{mo_raw}
\]</span></p>
<p>If we multiply <span class="math inline">\(L\)</span> on the right by its transpose <span class="math inline">\(L^T\)</span>, we’ll get expressions for the covariance matrix of our multivariate random vector <code>mo</code>:</p>
<p><span class="math display">\[
\begin{bmatrix} \sigma_\texttt{mo} / \sqrt{1 - \rho^2} &amp; 0 &amp; 0 \\
\rho \sigma_\texttt{mo} / \sqrt{1 - \rho^2} &amp; \sigma_\texttt{mo} &amp; 0 \\
\rho^2 \sigma_\texttt{mo} / \sqrt{1 - \rho^2} &amp; \rho \,\sigma_\texttt{mo}  &amp; \sigma_\texttt{mo}
\end{bmatrix} \times
\begin{bmatrix} \sigma_\texttt{mo} / \sqrt{1 - \rho^2} &amp; \rho \sigma_\texttt{mo} / \sqrt{1 - \rho^2} &amp; \rho^2 \sigma_\texttt{mo} / \sqrt{1 - \rho^2} \\
0 &amp; \sigma_\texttt{mo} &amp; \rho \,\sigma_\texttt{mo} \\
0 &amp; 0  &amp; \sigma_\texttt{mo}
\end{bmatrix}
\]</span></p>
<p>which results in:</p>
<p><span class="math display">\[
\begin{bmatrix} \sigma^2_\texttt{mo} / (1 - \rho^2) &amp; \rho \, \sigma^2_\texttt{mo} / (1 - \rho^2) &amp;  \rho^2 \, \sigma^2_\texttt{mo} / (1 - \rho^2)\\
\rho \, \sigma^2_\texttt{mo} / (1 - \rho^2)  &amp; \sigma^2_\texttt{mo} / (1 - \rho^2)  &amp; \rho \, \sigma^2_\texttt{mo} / (1 - \rho^2) \\
\rho^2 \sigma^2_\texttt{mo} / (1 - \rho^2) &amp; \rho \, \sigma^2_\texttt{mo} / (1 - \rho^2) &amp; \sigma^2_\texttt{mo} / (1 - \rho^2)
\end{bmatrix}
\]</span></p>
<p>We can simplify this result by dividing the matrix by <span class="math inline">\(\sigma^2_\texttt{mo} / (1 - \rho^2)\)</span> to get</p>
<p><span class="math display">\[
\begin{bmatrix} 1 &amp; \rho  &amp;  \rho^2 \\
\rho  &amp; 1  &amp; \rho  \\
\rho^2 &amp; \rho &amp; 1
\end{bmatrix}
\]</span></p>
<p>This should generalize to higher dimensions pretty easily. We could replace the <code>mo</code> variable and its definition (inside <code>transformed parameters</code> block) in Stan code in <code>hier_NB_regression_ncp_slopes_mod_mos.stan</code> with the following:</p>
<pre><code>vector[M] mo;
{
  matrix[M,M] A = rep_matrix(0, M, M);
  A[1,1] = sigma_mo / sqrt(1 - rho^2);
  for (m in 2:M)
    A[m,1] = rho^(m-1) * sigma_mo / sqrt(1 - rho^2);
  for (m in 2:M) {
    A[m,m] = sigma_mo;
    for (i in (m + 1):M)
      A[i,m] = rho^(i-m) * sigma_mo;
  }
  mo = A * mo_raw;
}</code></pre>
<p>It’s important to the note that the existing block of Stan code is doing the exact same calculations but more efficiently.</p>
</section>
<section id="cholesky-decomposition" class="level3">
<h3 class="anchored" data-anchor-id="cholesky-decomposition">Cholesky decomposition</h3>
<p>Note that if we only knew the covariance matrix of our process, say a matrix called <span class="math inline">\(\Sigma\)</span>, and we had a way of decomposing <span class="math inline">\(\Sigma\)</span> into <span class="math inline">\(L L^T\)</span> we wouldn’t need to write out the equation for the vector. Luckily, there is a matrix decomposition called the <strong>Cholesky decomposition</strong> that does just that. The Stan function for the composition is called <code>cholesky_decompose</code>. Instead of writing out the explicit equation, we could do the following:</p>
<pre><code>vector[M] mo;
{
  mo = cholesky_decompose(Sigma) * mo_raw;
}</code></pre>
<p>provided we’ve defined <code>Sigma</code> appropriately elsewhere in the transformed parameter block. Note that the matrix <span class="math inline">\(L\)</span> is lower-triangular (i.e.&nbsp;all elements in the upper right-hand triangle of the matrix are zero).</p>
<p>We’ve already derived the covariance matrix <code>Sigma</code> for the three-dimensional AR(1) process above by explicitly calculating <span class="math inline">\(L L^T\)</span>, but we can do so using the rules of covariance and the way our process is defined. We already know that each element of <span class="math inline">\(\texttt{mo}_t\)</span> has marginal variance <span class="math inline">\(\sigma^2_\texttt{mo} / (1 - \rho^2)\)</span>, but we don’t know the covariance of <span class="math inline">\(\texttt{mo}_t\)</span> and <span class="math inline">\(\texttt{mo}_{t+h}\)</span>. We can do so recursively. First we derive the covariance for two elements of <span class="math inline">\(\texttt{mo}_t\)</span> separated by one month:</p>
<p><span class="math display">\[
\begin{align*}
\text{Cov}(\texttt{mo}_{t+1},\texttt{mo}_{t}) &amp;= \text{Cov}(\rho \, \texttt{mo}_{t} + \sigma_\texttt{mo}\epsilon_{t+1},\texttt{mo}_{t}) \\
\text{Cov}(\texttt{mo}_{t+1},\texttt{mo}_{t}) &amp;= \rho \text{Cov}(\texttt{mo}_{t},\texttt{mo}_{t}) + \sigma_\texttt{mo}\text{Cov}(\epsilon_{t+1},\texttt{mo}_{t}) \\
\text{Cov}(\texttt{mo}_{t+1},\texttt{mo}_{t}) &amp;= \rho \text{Var}(\texttt{mo}_t) + 0
\end{align*}
\]</span></p>
<p>Then we define the covariance for <span class="math inline">\(\text{Cov}(\texttt{mo}_{t+h},\texttt{mo}_{t})\)</span> in terms of <span class="math inline">\(\text{Cov}(\texttt{mo}_{t+h-1},\texttt{mo}_{t})\)</span></p>
<p><span class="math display">\[
\begin{align*}
\text{Cov}(\texttt{mo}_{t+h},\texttt{mo}_{t}) &amp;= \text{Cov}(\rho \, \texttt{mo}_{t+h-1} + \sigma_\texttt{mo}\epsilon_{t+h},\texttt{mo}_{t}) \\
\text{Cov}(\texttt{mo}_{t+h},\texttt{mo}_{t}) &amp;= \rho \, \text{Cov}(\texttt{mo}_{t+h-1},\texttt{mo}_{t}) \\
\end{align*}
\]</span></p>
<p>Which we can use to recursively get at the covariance we need:</p>
<p><span class="math display">\[
\begin{align*}
\text{Cov}(\texttt{mo}_{t+h},\texttt{mo}_{t}) &amp;= \rho \, \text{Cov}(\texttt{mo}_{t+h-1},\texttt{mo}_{t}) \\
\text{Cov}(\texttt{mo}_{t+h},\texttt{mo}_{t}) &amp;= \rho \,( \rho \, \text{Cov}(\texttt{mo}_{t+h-2},\texttt{mo}_{t}) )\\
\dots \\
\text{Cov}(\texttt{mo}_{t+h},\texttt{mo}_{t}) &amp;= \rho^h \, \text{Cov}(\texttt{mo}_{t},\texttt{mo}_{t}) \\
\text{Cov}(\texttt{mo}_{t+h},\texttt{mo}_{t}) &amp;= \rho^h \, \sigma_\texttt{mo}^2/(1 - \rho^2) \\
\end{align*}
\]</span></p>
<p>Writing this in Stan code to replace the <code>mo</code> variable and its definition in <code>hier_NB_regression_ncp_slopes_mod_mos.stan</code> we would get:</p>
<pre><code>vector[M] mo;
{
  matrix[M,M] Sigma;
  for (m in 1:M) {
    Sigma[m,m] = 1.0;
    for (i in (m + 1):M) {
      Sigma[i,m] = rho^(i - m);
      Sigma[m,i] = Sigma[i,m];
    }
  }
  Sigma = Sigma * sigma_mo^2 / (1 - rho^2);
  mo = cholesky_decompose(Sigma) * mo_raw;
}</code></pre>
</section>
<section id="extension-to-gaussian-processes" class="level3">
<h3 class="anchored" data-anchor-id="extension-to-gaussian-processes">Extension to Gaussian processes</h3>
<p>The prior we defined for <code>mo</code> is strictly speaking a Gaussian process. It is a stochastic process that is distributed as jointly multivariate normal for any finite value of <span class="math inline">\(M\)</span>. Formally, we could write the above prior for <code>mo</code> like so:</p>
<p><span class="math display">\[
\begin{align*}
  \sigma_\texttt{mo} &amp;\sim \text{Normal}(0, 1) \\
  \rho &amp;\sim \text{GenBeta}(-1,1,10, 5) \\
  \texttt{mo}_t &amp;\sim \text{GP}\left( 0, K(t | \sigma_\texttt{mo},\rho) \right) \\
\end{align*}
\]</span></p>
<p>The notation <span class="math inline">\(K(t | \sigma_\texttt{mo},\rho)\)</span> defines the covariance matrix of the process over the domain <span class="math inline">\(t\)</span>, which is months.</p>
<p>In other words:</p>
<p><span class="math display">\[
\text{Cov}(\texttt{mo}_t,\texttt{mo}_{t+h}) = k(t, t+h | \sigma_\texttt{mo}, \rho)
\]</span></p>
<p>We’ve already derived the covariance for our process. What if we want to use a different definition of <code>Sigma</code>?</p>
<p>As the above example shows defining a proper covariance matrix will yield a proper multivariate normal prior on a parameter. We need a way of defining a proper covariance matrix. These are symmetric positive definite matrices. It turns out there is a class of functions that define proper covariance matrices, called <strong>kernel functions</strong>. These functions are applied elementwise to construct a covariance matrix, <span class="math inline">\(K\)</span>:</p>
<p><span class="math display">\[
K_{[t,t+h]} = k(t, t+h | \theta)
\]</span></p>
<p>where <span class="math inline">\(\theta\)</span> are the hyperparameters that define the behavior of covariance matrix.</p>
<p>One such function is called the <strong>exponentiated quadratic function</strong>, and it happens to be implemented in Stan as <code>gp_exp_quad_cov</code>. The function is defined as:</p>
<p><span class="math display">\[
\begin{align*}
  k(t, t+h | \theta) &amp;= \alpha^2  \exp \left( - \dfrac{1}{2\ell^2} ((t+h) - t)^2 \right) \\
  &amp;= \alpha^2  \exp \left( - \dfrac{h^2}{2\ell^2} \right)
\end{align*}
\]</span></p>
<p>The exponentiated quadratic kernel has two components to theta, <span class="math inline">\(\alpha\)</span>, the marginal standard deviation of the stochastic process <span class="math inline">\(f\)</span> and <span class="math inline">\(\ell\)</span>, the process length-scale.</p>
<p>The length-scale defines how quickly the covariance decays between time points, with large values of <span class="math inline">\(\ell\)</span> yielding a covariance that decays slowly, and with small values of <span class="math inline">\(\ell\)</span> yielding a covariance that decays rapidly. It can be seen interpreted as a measure of how nonlinear the <code>mo</code> process is in time.</p>
<p>The marginal standard deviation defines how large the fluctuations are on the output side, which in our case is the number of roach complaints per month across all buildings. It can be seen as a scale parameter akin to the scale parameter for our building-level hierarchical intercept, though it now defines the scale of the monthly deviations.</p>
<p>This kernel’s defining quality is its smoothness; the function is infinitely differentiable. That will present problems for our example, but if we add some noise the diagonal of our covariance matrix, the model will fit well.</p>
<p><span class="math display">\[
k(t, t+h | \theta) = \alpha^2  \exp \left( - \dfrac{h^2}{2\ell^2} \right) + \text{if } h = 0, \, \sigma^2_\texttt{noise} \text{ else } 0
\]</span></p>
</section>
<section id="compiling-the-gp-model" class="level3">
<h3 class="anchored" data-anchor-id="compiling-the-gp-model">Compiling the GP model</h3>
<div id="e2b7372a" class="cell" data-execution_count="95">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb130"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a>hier_NB_regression_ncp_slopes_mod_mos_gp <span class="op">=</span> <span class="st">'''</span></span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a><span class="st">functions {</span></span>
<span id="cb130-3"><a href="#cb130-3" aria-hidden="true" tabindex="-1"></a><span class="st">  int neg_binomial_2_log_safe_rng(real eta, real phi) {</span></span>
<span id="cb130-4"><a href="#cb130-4" aria-hidden="true" tabindex="-1"></a><span class="st">    real phi_div_exp_eta;</span></span>
<span id="cb130-5"><a href="#cb130-5" aria-hidden="true" tabindex="-1"></a><span class="st">    real gamma_rate;</span></span>
<span id="cb130-6"><a href="#cb130-6" aria-hidden="true" tabindex="-1"></a><span class="st">    phi_div_exp_eta = phi/exp(eta);</span></span>
<span id="cb130-7"><a href="#cb130-7" aria-hidden="true" tabindex="-1"></a><span class="st">    gamma_rate = gamma_rng(phi, phi_div_exp_eta);</span></span>
<span id="cb130-8"><a href="#cb130-8" aria-hidden="true" tabindex="-1"></a><span class="st">    if (gamma_rate &gt;= exp(20.79))</span></span>
<span id="cb130-9"><a href="#cb130-9" aria-hidden="true" tabindex="-1"></a><span class="st">      return -9;</span></span>
<span id="cb130-10"><a href="#cb130-10" aria-hidden="true" tabindex="-1"></a><span class="st">    return poisson_rng(gamma_rate);</span></span>
<span id="cb130-11"><a href="#cb130-11" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb130-12"><a href="#cb130-12" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb130-13"><a href="#cb130-13" aria-hidden="true" tabindex="-1"></a><span class="st">data {</span></span>
<span id="cb130-14"><a href="#cb130-14" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; N;</span></span>
<span id="cb130-15"><a href="#cb130-15" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; M;</span></span>
<span id="cb130-16"><a href="#cb130-16" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; K;</span></span>
<span id="cb130-17"><a href="#cb130-17" aria-hidden="true" tabindex="-1"></a><span class="st">  array[N] int complaints;</span></span>
<span id="cb130-18"><a href="#cb130-18" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N] traps;</span></span>
<span id="cb130-19"><a href="#cb130-19" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; J;</span></span>
<span id="cb130-20"><a href="#cb130-20" aria-hidden="true" tabindex="-1"></a><span class="st">  array[N] int&lt;lower=1, upper=J&gt; building_idx;</span></span>
<span id="cb130-21"><a href="#cb130-21" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[J,K] building_data;</span></span>
<span id="cb130-22"><a href="#cb130-22" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N] log_sq_foot;</span></span>
<span id="cb130-23"><a href="#cb130-23" aria-hidden="true" tabindex="-1"></a><span class="st">  array[N] int&lt;lower=1&gt; mo_idx;</span></span>
<span id="cb130-24"><a href="#cb130-24" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb130-25"><a href="#cb130-25" aria-hidden="true" tabindex="-1"></a><span class="st">transformed data {</span></span>
<span id="cb130-26"><a href="#cb130-26" aria-hidden="true" tabindex="-1"></a><span class="st">  array[M] real mo_gp_vec;</span></span>
<span id="cb130-27"><a href="#cb130-27" aria-hidden="true" tabindex="-1"></a><span class="st">  for (m in 1:M)</span></span>
<span id="cb130-28"><a href="#cb130-28" aria-hidden="true" tabindex="-1"></a><span class="st">    mo_gp_vec[m] = m;</span></span>
<span id="cb130-29"><a href="#cb130-29" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb130-30"><a href="#cb130-30" aria-hidden="true" tabindex="-1"></a><span class="st">parameters {</span></span>
<span id="cb130-31"><a href="#cb130-31" aria-hidden="true" tabindex="-1"></a><span class="st">  real alpha;</span></span>
<span id="cb130-32"><a href="#cb130-32" aria-hidden="true" tabindex="-1"></a><span class="st">  real&lt;lower=0&gt; sigma_mu;</span></span>
<span id="cb130-33"><a href="#cb130-33" aria-hidden="true" tabindex="-1"></a><span class="st">  real&lt;lower=0&gt; sigma_kappa;</span></span>
<span id="cb130-34"><a href="#cb130-34" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[J] mu_raw;</span></span>
<span id="cb130-35"><a href="#cb130-35" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[J] kappa_raw;</span></span>
<span id="cb130-36"><a href="#cb130-36" aria-hidden="true" tabindex="-1"></a><span class="st">  real beta;</span></span>
<span id="cb130-37"><a href="#cb130-37" aria-hidden="true" tabindex="-1"></a><span class="st">  real&lt;lower=0&gt; inv_phi;</span></span>
<span id="cb130-38"><a href="#cb130-38" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[K] zeta;</span></span>
<span id="cb130-39"><a href="#cb130-39" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[K] gamma;</span></span>
<span id="cb130-40"><a href="#cb130-40" aria-hidden="true" tabindex="-1"></a><span class="st">  // GP prior parameters</span></span>
<span id="cb130-41"><a href="#cb130-41" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[M] gp_raw;</span></span>
<span id="cb130-42"><a href="#cb130-42" aria-hidden="true" tabindex="-1"></a><span class="st">  real&lt;lower=0&gt; gp_len;</span></span>
<span id="cb130-43"><a href="#cb130-43" aria-hidden="true" tabindex="-1"></a><span class="st">  real&lt;lower=0&gt; sigma_gp;</span></span>
<span id="cb130-44"><a href="#cb130-44" aria-hidden="true" tabindex="-1"></a><span class="st">  real&lt;lower=0&gt; sigma_noise;</span></span>
<span id="cb130-45"><a href="#cb130-45" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[M] mo_noise_raw;</span></span>
<span id="cb130-46"><a href="#cb130-46" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb130-47"><a href="#cb130-47" aria-hidden="true" tabindex="-1"></a><span class="st">transformed parameters {</span></span>
<span id="cb130-48"><a href="#cb130-48" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[J] mu = alpha + building_data * zeta + sigma_mu * mu_raw;</span></span>
<span id="cb130-49"><a href="#cb130-49" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[J] kappa = beta + building_data * gamma + sigma_kappa * kappa_raw;</span></span>
<span id="cb130-50"><a href="#cb130-50" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[M] mo_noise = sigma_noise * mo_noise_raw;</span></span>
<span id="cb130-51"><a href="#cb130-51" aria-hidden="true" tabindex="-1"></a><span class="st">  real phi = inv(inv_phi);</span></span>
<span id="cb130-52"><a href="#cb130-52" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[M] gp_exp_quad;</span></span>
<span id="cb130-53"><a href="#cb130-53" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[M] gp;</span></span>
<span id="cb130-54"><a href="#cb130-54" aria-hidden="true" tabindex="-1"></a><span class="st">  {</span></span>
<span id="cb130-55"><a href="#cb130-55" aria-hidden="true" tabindex="-1"></a><span class="st">    matrix[M, M] C = gp_exp_quad_cov(mo_gp_vec, sigma_gp, gp_len);</span></span>
<span id="cb130-56"><a href="#cb130-56" aria-hidden="true" tabindex="-1"></a><span class="st">    real var_noise = square(sigma_noise);</span></span>
<span id="cb130-57"><a href="#cb130-57" aria-hidden="true" tabindex="-1"></a><span class="st">    matrix[M, M] L_C;</span></span>
<span id="cb130-58"><a href="#cb130-58" aria-hidden="true" tabindex="-1"></a><span class="st">    for (m in 1:M)</span></span>
<span id="cb130-59"><a href="#cb130-59" aria-hidden="true" tabindex="-1"></a><span class="st">      C[m,m] += 1e-12;</span></span>
<span id="cb130-60"><a href="#cb130-60" aria-hidden="true" tabindex="-1"></a><span class="st">    L_C = cholesky_decompose(C);</span></span>
<span id="cb130-61"><a href="#cb130-61" aria-hidden="true" tabindex="-1"></a><span class="st">    gp_exp_quad = L_C * gp_raw;</span></span>
<span id="cb130-62"><a href="#cb130-62" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb130-63"><a href="#cb130-63" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb130-64"><a href="#cb130-64" aria-hidden="true" tabindex="-1"></a><span class="st">  // gp is sum of monthly noise and the smoothly varying process</span></span>
<span id="cb130-65"><a href="#cb130-65" aria-hidden="true" tabindex="-1"></a><span class="st">  gp = mo_noise + gp_exp_quad;</span></span>
<span id="cb130-66"><a href="#cb130-66" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb130-67"><a href="#cb130-67" aria-hidden="true" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb130-68"><a href="#cb130-68" aria-hidden="true" tabindex="-1"></a><span class="st">  beta ~ normal(-0.25, 1);</span></span>
<span id="cb130-69"><a href="#cb130-69" aria-hidden="true" tabindex="-1"></a><span class="st">  mu_raw ~ normal(0,1);</span></span>
<span id="cb130-70"><a href="#cb130-70" aria-hidden="true" tabindex="-1"></a><span class="st">  kappa_raw ~ normal(0,1);</span></span>
<span id="cb130-71"><a href="#cb130-71" aria-hidden="true" tabindex="-1"></a><span class="st">  sigma_mu ~ normal(0, 1);</span></span>
<span id="cb130-72"><a href="#cb130-72" aria-hidden="true" tabindex="-1"></a><span class="st">  sigma_kappa ~ normal(0, 1);</span></span>
<span id="cb130-73"><a href="#cb130-73" aria-hidden="true" tabindex="-1"></a><span class="st">  alpha ~ normal(log(4), 1);</span></span>
<span id="cb130-74"><a href="#cb130-74" aria-hidden="true" tabindex="-1"></a><span class="st">  zeta ~ normal(0, 1);</span></span>
<span id="cb130-75"><a href="#cb130-75" aria-hidden="true" tabindex="-1"></a><span class="st">  gamma ~ normal(0, 1);</span></span>
<span id="cb130-76"><a href="#cb130-76" aria-hidden="true" tabindex="-1"></a><span class="st">  inv_phi ~ normal(0, 1);</span></span>
<span id="cb130-77"><a href="#cb130-77" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb130-78"><a href="#cb130-78" aria-hidden="true" tabindex="-1"></a><span class="st">  // GP priors</span></span>
<span id="cb130-79"><a href="#cb130-79" aria-hidden="true" tabindex="-1"></a><span class="st">  gp_raw ~ normal(0, 1);</span></span>
<span id="cb130-80"><a href="#cb130-80" aria-hidden="true" tabindex="-1"></a><span class="st">  gp_len ~ gamma(10, 2);</span></span>
<span id="cb130-81"><a href="#cb130-81" aria-hidden="true" tabindex="-1"></a><span class="st">  sigma_gp ~ normal(0, 1);</span></span>
<span id="cb130-82"><a href="#cb130-82" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb130-83"><a href="#cb130-83" aria-hidden="true" tabindex="-1"></a><span class="st">  sigma_noise ~ normal(0, 1);</span></span>
<span id="cb130-84"><a href="#cb130-84" aria-hidden="true" tabindex="-1"></a><span class="st">  mo_noise_raw ~ normal(0, 1);</span></span>
<span id="cb130-85"><a href="#cb130-85" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb130-86"><a href="#cb130-86" aria-hidden="true" tabindex="-1"></a><span class="st">  complaints ~ neg_binomial_2_log(mu[building_idx] + kappa[building_idx] .* traps </span></span>
<span id="cb130-87"><a href="#cb130-87" aria-hidden="true" tabindex="-1"></a><span class="st">                                 + gp[mo_idx] + log_sq_foot, phi);</span></span>
<span id="cb130-88"><a href="#cb130-88" aria-hidden="true" tabindex="-1"></a><span class="st">} </span></span>
<span id="cb130-89"><a href="#cb130-89" aria-hidden="true" tabindex="-1"></a><span class="st">generated quantities {</span></span>
<span id="cb130-90"><a href="#cb130-90" aria-hidden="true" tabindex="-1"></a><span class="st">  array[N] int y_rep;</span></span>
<span id="cb130-91"><a href="#cb130-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-92"><a href="#cb130-92" aria-hidden="true" tabindex="-1"></a><span class="st">  for (n in 1:N) </span></span>
<span id="cb130-93"><a href="#cb130-93" aria-hidden="true" tabindex="-1"></a><span class="st">    y_rep[n] = neg_binomial_2_log_safe_rng(mu[building_idx[n]] + kappa[building_idx[n]] * traps[n]</span></span>
<span id="cb130-94"><a href="#cb130-94" aria-hidden="true" tabindex="-1"></a><span class="st">                                          + gp[mo_idx[n]] + log_sq_foot[n],</span></span>
<span id="cb130-95"><a href="#cb130-95" aria-hidden="true" tabindex="-1"></a><span class="st">                                          phi);</span></span>
<span id="cb130-96"><a href="#cb130-96" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb130-97"><a href="#cb130-97" aria-hidden="true" tabindex="-1"></a><span class="st">'''</span></span>
<span id="cb130-98"><a href="#cb130-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-99"><a href="#cb130-99" aria-hidden="true" tabindex="-1"></a>comp_model_NB_hier_gp <span class="op">=</span> StanModel(<span class="st">'../stan_models/hier_NB_regression_ncp_slopes_mod_mos_gp'</span>, hier_NB_regression_ncp_slopes_mod_mos_gp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="fitting-the-gp-model-to-data" class="level3">
<h3 class="anchored" data-anchor-id="fitting-the-gp-model-to-data">Fitting the GP model to data</h3>
<div id="25893def" class="cell" data-execution_count="96">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb131"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a>fitted_model_NB_hier_gp <span class="op">=</span> comp_model_NB_hier_gp.sample(</span>
<span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>stan_dat_hier,</span>
<span id="cb131-3"><a href="#cb131-3" aria-hidden="true" tabindex="-1"></a>    chains<span class="op">=</span><span class="dv">4</span>,</span>
<span id="cb131-4"><a href="#cb131-4" aria-hidden="true" tabindex="-1"></a>    parallel_chains<span class="op">=</span><span class="dv">4</span>,</span>
<span id="cb131-5"><a href="#cb131-5" aria-hidden="true" tabindex="-1"></a>    adapt_delta<span class="op">=</span><span class="fl">0.9</span>,</span>
<span id="cb131-6"><a href="#cb131-6" aria-hidden="true" tabindex="-1"></a>    show_progress<span class="op">=</span><span class="va">False</span></span>
<span id="cb131-7"><a href="#cb131-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb131-8"><a href="#cb131-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-9"><a href="#cb131-9" aria-hidden="true" tabindex="-1"></a>samps_gp <span class="op">=</span> az.from_cmdstanpy(fitted_model_NB_hier_gp, posterior_predictive<span class="op">=</span><span class="st">'y_rep'</span>, observed_data<span class="op">=</span>stan_dat_hier)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>00:51:55 - cmdstanpy - INFO - CmdStan start processing
00:51:55 - cmdstanpy - INFO - CmdStan start processing
00:52:27 - cmdstanpy - INFO - CmdStan done processing
00:52:27 - cmdstanpy - WARNING - Non-fatal error during sampling:
Exception: gp_exp_quad_cov: sigma is 0, but must be positive! (in 'hier_NB_regression_ncp_slopes_mod_mos_gp.stan', line 55, column 4 to column 66)
    Exception: cholesky_decompose: Matrix m is not positive definite (in 'hier_NB_regression_ncp_slopes_mod_mos_gp.stan', line 60, column 4 to column 32)
    Exception: neg_binomial_2_log_lpmf: Precision parameter is 0, but must be positive finite! (in 'hier_NB_regression_ncp_slopes_mod_mos_gp.stan', line 86, column 2 to line 87, column 66)
    Exception: neg_binomial_2_log_lpmf: Precision parameter is 0, but must be positive finite! (in 'hier_NB_regression_ncp_slopes_mod_mos_gp.stan', line 86, column 2 to line 87, column 66)
    Exception: cholesky_decompose: Matrix m is not positive definite (in 'hier_NB_regression_ncp_slopes_mod_mos_gp.stan', line 60, column 4 to column 32)
    Exception: gp_exp_quad_cov: sigma is 0, but must be positive! (in 'hier_NB_regression_ncp_slopes_mod_mos_gp.stan', line 55, column 4 to column 66)
    Exception: neg_binomial_2_log_lpmf: Precision parameter is 0, but must be positive finite! (in 'hier_NB_regression_ncp_slopes_mod_mos_gp.stan', line 86, column 2 to line 87, column 66)
    Exception: neg_binomial_2_log_lpmf: Precision parameter is 0, but must be positive finite! (in 'hier_NB_regression_ncp_slopes_mod_mos_gp.stan', line 86, column 2 to line 87, column 66)
    Exception: cholesky_decompose: Matrix m is not positive definite (in 'hier_NB_regression_ncp_slopes_mod_mos_gp.stan', line 60, column 4 to column 32)
    Exception: neg_binomial_2_log_lpmf: Precision parameter is 0, but must be positive finite! (in 'hier_NB_regression_ncp_slopes_mod_mos_gp.stan', line 86, column 2 to line 87, column 66)
    Exception: neg_binomial_2_log_lpmf: Precision parameter is 0, but must be positive finite! (in 'hier_NB_regression_ncp_slopes_mod_mos_gp.stan', line 86, column 2 to line 87, column 66)
    Exception: neg_binomial_2_log_lpmf: Precision parameter is inf, but must be positive finite! (in 'hier_NB_regression_ncp_slopes_mod_mos_gp.stan', line 86, column 2 to line 87, column 66)
    Exception: neg_binomial_2_log_lpmf: Precision parameter is inf, but must be positive finite! (in 'hier_NB_regression_ncp_slopes_mod_mos_gp.stan', line 86, column 2 to line 87, column 66)
    Exception: neg_binomial_2_log_lpmf: Precision parameter is 0, but must be positive finite! (in 'hier_NB_regression_ncp_slopes_mod_mos_gp.stan', line 86, column 2 to line 87, column 66)
    Exception: cholesky_decompose: A is not symmetric. A[1,2] = inf, but A[2,1] = inf (in 'hier_NB_regression_ncp_slopes_mod_mos_gp.stan', line 60, column 4 to column 32)
    Exception: cholesky_decompose: Matrix m is not positive definite (in 'hier_NB_regression_ncp_slopes_mod_mos_gp.stan', line 60, column 4 to column 32)
    Exception: gp_exp_quad_cov: sigma is 0, but must be positive! (in 'hier_NB_regression_ncp_slopes_mod_mos_gp.stan', line 55, column 4 to column 66)
    Exception: gp_exp_quad_cov: length_scale is 0, but must be positive! (in 'hier_NB_regression_ncp_slopes_mod_mos_gp.stan', line 55, column 4 to column 66)
Consider re-running with show_console=True if the above output is unclear!</code></pre>
</div>
</div>
</section>
<section id="examining-the-fit" class="level3">
<h3 class="anchored" data-anchor-id="examining-the-fit">Examining the fit</h3>
<p>Let’s look at the prior vs.&nbsp;posterior for the GP length scale parameter:</p>
<div id="0541540e" class="cell" data-execution_count="97">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb133"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a>plt.clf()</span>
<span id="cb133-2"><a href="#cb133-2" aria-hidden="true" tabindex="-1"></a>sns.kdeplot(samps_gp.posterior.gp_len.to_numpy().flatten(), label<span class="op">=</span><span class="st">'Posterior'</span>)</span>
<span id="cb133-3"><a href="#cb133-3" aria-hidden="true" tabindex="-1"></a>sns.kdeplot(np.random.gamma(<span class="dv">10</span>, <span class="dv">1</span><span class="op">/</span><span class="dv">2</span>, <span class="dv">4000</span>), label<span class="op">=</span><span class="st">'Prior'</span>)</span>
<span id="cb133-4"><a href="#cb133-4" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb133-5"><a href="#cb133-5" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb133-6"><a href="#cb133-6" aria-hidden="true" tabindex="-1"></a>plt.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Pest%20Control%20Example_files/figure-html/cell-98-output-1.png" width="511" height="411" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>From the plot above it only looks like we learned a small amount, however we can see a bigger difference between the prior and posterior if we consider how much we learned about the ratio of <code>sigma_gp</code> to the length scale <code>gp_len</code>:</p>
<div id="1c4a59fd" class="cell" data-execution_count="98">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb134"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a>plt.clf()</span>
<span id="cb134-2"><a href="#cb134-2" aria-hidden="true" tabindex="-1"></a>sns.kdeplot(samps_gp.posterior.sigma_gp.to_numpy().flatten() <span class="op">/</span> samps_gp.posterior.gp_len.to_numpy().flatten(), label<span class="op">=</span><span class="st">'Posterior'</span>)</span>
<span id="cb134-3"><a href="#cb134-3" aria-hidden="true" tabindex="-1"></a>sns.kdeplot(np.<span class="bu">abs</span>(np.random.normal(size<span class="op">=</span><span class="dv">4000</span>)) <span class="op">/</span> np.random.gamma(<span class="dv">10</span>, <span class="dv">1</span><span class="op">/</span><span class="dv">2</span>, <span class="dv">4000</span>), label<span class="op">=</span><span class="st">'Prior'</span>)</span>
<span id="cb134-4"><a href="#cb134-4" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb134-5"><a href="#cb134-5" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb134-6"><a href="#cb134-6" aria-hidden="true" tabindex="-1"></a>plt.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Pest%20Control%20Example_files/figure-html/cell-99-output-1.png" width="511" height="411" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>This is a classic problem with Gaussian processes. Marginally, the length-scale parameter isn’t very well-identified by the data, but jointly the length-scale and the marginal standard deviation are well-identified.</p>
<p>And let’s compare the estimates for the time varying parameters between the AR(1) and GP. In this case the posterior mean of the time trend is essentially the same for the AR(1) and GP priors but the 50% uncertainty intervals are narrower for the AR(1):</p>
<div id="810a1166" class="cell" data-execution_count="99">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb135"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib.lines <span class="im">import</span> Line2D </span>
<span id="cb135-2"><a href="#cb135-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-3"><a href="#cb135-3" aria-hidden="true" tabindex="-1"></a>plt.clf()</span>
<span id="cb135-4"><a href="#cb135-4" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb135-5"><a href="#cb135-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-6"><a href="#cb135-6" aria-hidden="true" tabindex="-1"></a>az.plot_hdi(np.arange(<span class="dv">1</span>,<span class="dv">36</span><span class="op">+</span><span class="dv">1</span>), </span>
<span id="cb135-7"><a href="#cb135-7" aria-hidden="true" tabindex="-1"></a>            hdi_data<span class="op">=</span>az.hdi(samps_gp.posterior.gp, hdi_prob<span class="op">=</span><span class="fl">0.5</span>), </span>
<span id="cb135-8"><a href="#cb135-8" aria-hidden="true" tabindex="-1"></a>            smooth<span class="op">=</span><span class="va">False</span>, </span>
<span id="cb135-9"><a href="#cb135-9" aria-hidden="true" tabindex="-1"></a>            color<span class="op">=</span><span class="st">'C1'</span>,</span>
<span id="cb135-10"><a href="#cb135-10" aria-hidden="true" tabindex="-1"></a>            ax<span class="op">=</span>ax)</span>
<span id="cb135-11"><a href="#cb135-11" aria-hidden="true" tabindex="-1"></a>az.plot_hdi(np.arange(<span class="dv">1</span>,<span class="dv">36</span><span class="op">+</span><span class="dv">1</span>), </span>
<span id="cb135-12"><a href="#cb135-12" aria-hidden="true" tabindex="-1"></a>            hdi_data<span class="op">=</span>az.hdi(az_samps_NB_hier_mos.posterior.mo, hdi_prob<span class="op">=</span><span class="fl">0.5</span>), </span>
<span id="cb135-13"><a href="#cb135-13" aria-hidden="true" tabindex="-1"></a>            smooth<span class="op">=</span><span class="va">False</span>, </span>
<span id="cb135-14"><a href="#cb135-14" aria-hidden="true" tabindex="-1"></a>            color<span class="op">=</span><span class="st">'C0'</span>,</span>
<span id="cb135-15"><a href="#cb135-15" aria-hidden="true" tabindex="-1"></a>            ax<span class="op">=</span>ax)</span>
<span id="cb135-16"><a href="#cb135-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-17"><a href="#cb135-17" aria-hidden="true" tabindex="-1"></a>legend_handles <span class="op">=</span> [</span>
<span id="cb135-18"><a href="#cb135-18" aria-hidden="true" tabindex="-1"></a>    Line2D([<span class="dv">0</span>], [<span class="dv">0</span>], color<span class="op">=</span><span class="st">'C1'</span>, lw<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="st">"GP"</span>),</span>
<span id="cb135-19"><a href="#cb135-19" aria-hidden="true" tabindex="-1"></a>    Line2D([<span class="dv">0</span>], [<span class="dv">0</span>], color<span class="op">=</span><span class="st">'C0'</span>, lw<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="st">"AR1"</span>)</span>
<span id="cb135-20"><a href="#cb135-20" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb135-21"><a href="#cb135-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-22"><a href="#cb135-22" aria-hidden="true" tabindex="-1"></a>ax.legend(handles<span class="op">=</span>legend_handles, loc<span class="op">=</span><span class="st">'lower right'</span>)</span>
<span id="cb135-23"><a href="#cb135-23" aria-hidden="true" tabindex="-1"></a>ax.<span class="bu">set</span>(xlabel<span class="op">=</span><span class="st">'Time'</span>, ylabel<span class="op">=</span><span class="st">'m'</span>)</span>
<span id="cb135-24"><a href="#cb135-24" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb135-25"><a href="#cb135-25" aria-hidden="true" tabindex="-1"></a>plt.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<pre><code>&lt;Figure size 500x400 with 0 Axes&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Pest%20Control%20Example_files/figure-html/cell-100-output-2.png" width="511" height="411" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>The way we coded the GP also lets us plot a decomposition of the GP into a monthly noise component (<code>mo_noise</code> in the Stan code) and the underlying smoothly varying trend (<code>gp_exp_quad</code> in the Stan code):</p>
<div id="dbb34ac0" class="cell" data-execution_count="100">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb137"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a>plt.clf()</span>
<span id="cb137-2"><a href="#cb137-2" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb137-3"><a href="#cb137-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-4"><a href="#cb137-4" aria-hidden="true" tabindex="-1"></a>time <span class="op">=</span> np.arange(<span class="dv">1</span>,<span class="dv">36</span><span class="op">+</span><span class="dv">1</span>)</span>
<span id="cb137-5"><a href="#cb137-5" aria-hidden="true" tabindex="-1"></a>az.plot_hdi(time, </span>
<span id="cb137-6"><a href="#cb137-6" aria-hidden="true" tabindex="-1"></a>            hdi_data<span class="op">=</span>az.hdi(samps_gp.posterior.gp_exp_quad, hdi_prob<span class="op">=</span><span class="fl">0.5</span>), </span>
<span id="cb137-7"><a href="#cb137-7" aria-hidden="true" tabindex="-1"></a>            smooth<span class="op">=</span><span class="va">False</span>, </span>
<span id="cb137-8"><a href="#cb137-8" aria-hidden="true" tabindex="-1"></a>            color<span class="op">=</span><span class="st">'C1'</span>,</span>
<span id="cb137-9"><a href="#cb137-9" aria-hidden="true" tabindex="-1"></a>            ax<span class="op">=</span>ax)</span>
<span id="cb137-10"><a href="#cb137-10" aria-hidden="true" tabindex="-1"></a>az.plot_hdi(time, </span>
<span id="cb137-11"><a href="#cb137-11" aria-hidden="true" tabindex="-1"></a>            hdi_data<span class="op">=</span>az.hdi(samps_gp.posterior.mo_noise, hdi_prob<span class="op">=</span><span class="fl">0.5</span>), </span>
<span id="cb137-12"><a href="#cb137-12" aria-hidden="true" tabindex="-1"></a>            smooth<span class="op">=</span><span class="va">False</span>, </span>
<span id="cb137-13"><a href="#cb137-13" aria-hidden="true" tabindex="-1"></a>            color<span class="op">=</span><span class="st">'C0'</span>,</span>
<span id="cb137-14"><a href="#cb137-14" aria-hidden="true" tabindex="-1"></a>            ax<span class="op">=</span>ax)</span>
<span id="cb137-15"><a href="#cb137-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-16"><a href="#cb137-16" aria-hidden="true" tabindex="-1"></a>ax.plot(time, samps_gp.posterior.mo_noise.mean(dim<span class="op">=</span>[<span class="st">'chain'</span>, <span class="st">'draw'</span>]))</span>
<span id="cb137-17"><a href="#cb137-17" aria-hidden="true" tabindex="-1"></a>ax.plot(time, samps_gp.posterior.gp_exp_quad.mean(dim<span class="op">=</span>[<span class="st">'chain'</span>, <span class="st">'draw'</span>]))</span>
<span id="cb137-18"><a href="#cb137-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-19"><a href="#cb137-19" aria-hidden="true" tabindex="-1"></a>legend_handles <span class="op">=</span> [</span>
<span id="cb137-20"><a href="#cb137-20" aria-hidden="true" tabindex="-1"></a>    Line2D([<span class="dv">0</span>], [<span class="dv">0</span>], color<span class="op">=</span><span class="st">'C1'</span>, lw<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="st">"Smooth Trend"</span>),</span>
<span id="cb137-21"><a href="#cb137-21" aria-hidden="true" tabindex="-1"></a>    Line2D([<span class="dv">0</span>], [<span class="dv">0</span>], color<span class="op">=</span><span class="st">'C0'</span>, lw<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="st">"Monthly Noise"</span>)</span>
<span id="cb137-22"><a href="#cb137-22" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb137-23"><a href="#cb137-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-24"><a href="#cb137-24" aria-hidden="true" tabindex="-1"></a>ax.legend(handles<span class="op">=</span>legend_handles, loc<span class="op">=</span><span class="st">'lower right'</span>)</span>
<span id="cb137-25"><a href="#cb137-25" aria-hidden="true" tabindex="-1"></a>ax.<span class="bu">set</span>(xlabel<span class="op">=</span><span class="st">'Time'</span>, ylabel<span class="op">=</span><span class="st">'m'</span>)</span>
<span id="cb137-26"><a href="#cb137-26" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb137-27"><a href="#cb137-27" aria-hidden="true" tabindex="-1"></a>plt.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<pre><code>&lt;Figure size 500x400 with 0 Axes&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Pest%20Control%20Example_files/figure-html/cell-101-output-2.png" width="511" height="411" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>